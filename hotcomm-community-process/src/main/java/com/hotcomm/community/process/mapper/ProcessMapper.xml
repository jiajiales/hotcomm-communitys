<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hotcomm.community.process.mapper.ProcessMapper">

	<!-- 报警列表分页 -->
	<select id="alarmPage"
		resultType="com.hotcomm.community.common.bean.ui.process.alarm.AlarmPageUM">
		SELECT 
		1 as reportType,
			CASE
			  WHEN alm.alarm_type = 1 
			  THEN '设备上报报警' 
			  WHEN alm.alarm_type = 2 
			  THEN '车辆预警布控上报报警' 
			  WHEN alm.alarm_type = 3 
			  THEN '人员预警布控上报报警' 
			END AS alarmTypeOfWorder,
			case when w.id is not null then w.id else '' end as worderId,
		  	CASE
			WHEN w.`order_status` = 1
			THEN 1
			WHEN w.`order_status` = 2
			THEN 2
			WHEN w.`order_status` = 3
			THEN 3
			WHEN w.`order_status` = 4
			THEN 4
			else ''
			END AS worderPageState,
			CASE
			    WHEN alm.`handel_state` = 0 
			    THEN '详情细节未知，待工单或报警处理人员前往处理' 
			    WHEN alm.`handel_state` = 1 
			    THEN '详情细节未知，待报警处理人员处理填写中' 
			    WHEN alm.`handel_state` = 2 
			    THEN (CASE WHEN alm.handle_result_by_alarm IS NOT NULL THEN alm.handle_result_by_alarm ELSE '' END)
			    WHEN alm.`handel_state` = 3 
			    AND alm.`worder_no` IS NOT NULL 
			    AND alm.`worder_no` != '' 
			    THEN (CASE WHEN alm.handle_tip_by_alarm IS NOT NULL THEN alm.handle_tip_by_alarm ELSE '' END)
			    WHEN alm.`handel_state` = 3 
			    AND alm.`worder_no` IS NULL 
			    OR alm.`worder_no` = '' 
			    THEN (CASE WHEN alm.handle_tip_by_alarm IS NOT NULL THEN alm.handle_tip_by_alarm ELSE '' END)
			    WHEN alm.`handel_state` = 4 
			    THEN (CASE WHEN alm.handle_result_by_worder IS NOT NULL THEN alm.handle_result_by_worder ELSE '' END) 
			    WHEN alm.`handel_state` = 5 
			    THEN (CASE WHEN alm.closed_remark IS NOT NULL THEN alm.closed_remark ELSE '' END)  
			    ELSE '' 
			  END AS descOfWorder,
			  CASE
			    WHEN alm.lat IS NOT NULL 
			    THEN alm.lat 
			    ELSE '' 
			  END AS lat,
			  CASE
			    WHEN alm.lng IS NOT NULL 
			    THEN alm.lng
			    ELSE '' 
			  END AS lng,
		  alm.`alarm_message` AS alarmMessage,
		  alm.`id` AS alarmID,
		  CASE
		    WHEN alm.`alarm_type` = 1 
		    THEN '设备' 
		    WHEN alm.`alarm_type` = 2 
		    THEN '车辆' 
		    WHEN alm.`alarm_type` = 3 
		    THEN '人员' 
		  END AS alarmType,
		  CASE WHEN alm.`alarm_type` NOT IN (2,3)
		  THEN
		  CONCAT(sta.`level`, '级') 
		  ELSE
		  CONCAT(alm.`alarm_level`, '级') 
		  END
		  AS alarmLevel,
		  alm.`create_time` AS createTime,
		  alm.`alarm_source` AS alarmSource,
		  alm.`alarm_address` AS alarmAddress,
		  CASE
		   WHEN alm.handel_state=0 THEN 1
		   WHEN alm.handel_state=1 THEN 2
		   WHEN alm.handel_state=3 AND alm.worder_no IS NULL OR alm.`worder_no`='' THEN 3
		   WHEN alm.handel_state=3 AND alm.worder_no IS NOT NULL AND alm.`worder_no`!='' THEN 4
		   WHEN alm.handel_state=4 THEN 5
		   WHEN alm.handel_state=2 THEN 6
		   WHEN alm.handel_state=5 THEN 7
		   END AS pageState,
		  CASE
		   WHEN alm.handel_state=0 THEN 2
		   WHEN alm.handel_state=1 THEN 2
		   WHEN alm.handel_state=5 AND alm.handle_begin IS NULL THEN 4
		   WHEN alm.handel_state=5 AND alm.handle_begin IS NOT NULL THEN 3
		   WHEN alm.handel_state=2 THEN 2
		   WHEN alm.handel_state=3 AND alm.worder_no IS NULL THEN 1
		   WHEN alm.handel_state=3 AND alm.worder_no IS NOT NULL THEN 1
		   WHEN alm.handel_state=4 THEN 1
		   END AS canvaType,
		  CASE
		   WHEN alm.handel_state=0 THEN 1
		   WHEN alm.handel_state=1 THEN 2
		   WHEN alm.handel_state=5 AND alm.handle_begin IS NULL THEN 2
		   WHEN alm.handel_state=5 AND alm.handle_begin IS NOT NULL THEN 3
		   WHEN alm.handel_state=2 THEN 3
		   WHEN alm.handel_state=3 AND alm.worder_no IS NULL OR alm.`worder_no`='' THEN 3
		   WHEN alm.handel_state=3 AND alm.worder_no IS NOT NULL AND alm.`worder_no`!='' THEN 4
		   WHEN alm.handel_state=4 THEN 5
		   END AS canvaProgress,
<!-- 		  CASE -->
<!-- 		    WHEN alm.handel_state = 0  -->
<!-- 		    THEN '待报警人员处理,未出结果'  -->
<!-- 		    WHEN alm.handel_state = 1  -->
<!-- 		    THEN '报警人员处理中,等待结果'  -->
<!-- 		    WHEN alm.handel_state = 2  -->
<!-- 		    THEN alm.handle_result_by_alarm  -->
<!-- 		    WHEN alm.handel_state = 3  -->
<!-- 		    THEN (CASE WHEN alm.handle_tip_by_alarm IS NOT NULL THEN alm.handle_tip_by_alarm ELSE '' END) -->
<!-- 		    WHEN alm.handel_state = 4  -->
<!-- 		    THEN alm.handle_result_by_worder  -->
<!-- 		    WHEN alm.handel_state = 5  -->
<!-- 		    THEN alm.closed_remark  -->
<!-- 		  END  -->
<!-- 		  AS handleResult, -->
<!-- 		  CASE -->
<!-- 		    WHEN alm.`handel_state` = 0  -->
<!-- 		    THEN '未处理'  -->
<!-- 		    WHEN alm.`handel_state` = 1  -->
<!-- 		    THEN '报警处理中'  -->
<!-- 		    WHEN alm.`handel_state` = 2  -->
<!-- 		    THEN '报警已处理(完成)'  -->
<!-- 		    WHEN alm.`handel_state` = 3  -->
<!-- 		    AND alm.`worder_no` IS NOT NULL AND alm.`worder_no`!='' -->
<!-- 		    THEN '报警已处理,无法解决,工单处理中'  -->
<!-- 		    WHEN alm.`handel_state` = 3  -->
<!-- 		    AND alm.`worder_no` IS NULL OR alm.`worder_no`='' -->
<!-- 		    THEN '报警已处理,无法解决,等待转工单中'  -->
<!-- 		    WHEN alm.`handel_state` = 4  -->
<!-- 		    THEN '报警转工单处理完成' -->
<!-- 		    WHEN alm.`handel_state` = 5 -->
<!-- 		    THEN '已关闭' -->
<!-- 		  END AS state, -->
		  CASE
		    WHEN alm.handel_state = 0 
		    THEN '待报警人员处理,未出结果' 
		    WHEN alm.handel_state = 1 
		    THEN '报警人员处理中,等待结果' 
		    WHEN alm.handel_state = 2 
		    THEN alm.handle_result_by_alarm 
		    WHEN alm.`handel_state` = 3 
		    AND alm.`worder_no` IS NOT NULL AND alm.`worder_no`!=''
		    THEN concat(CASE WHEN alm.handle_tip_by_alarm IS NOT NULL THEN alm.handle_tip_by_alarm ELSE '' END,'报警已处理,无法解决,工单处理中' )
		    WHEN alm.`handel_state` = 3 
		    AND alm.`worder_no` IS NULL OR alm.`worder_no`=''
		    THEN concat(CASE WHEN alm.handle_tip_by_alarm IS NOT NULL THEN alm.handle_tip_by_alarm ELSE '' END,'报警已处理,无法解决,等待转工单中' )
		    WHEN alm.handel_state = 4 
		    THEN alm.handle_result_by_worder 
		    WHEN alm.handel_state = 5 
		    THEN alm.closed_remark 
		  END 
		  AS handleResult,
		  CASE
		    WHEN alm.`handel_state` = 0 
		    THEN '未处理' 
		    WHEN alm.`handel_state` = 1 
		    THEN '处理中' 
		    WHEN alm.`handel_state` = 2 
		    THEN '已完成' 
		    WHEN alm.`handel_state` = 3 
		    AND alm.`worder_no` IS NOT NULL AND alm.`worder_no`!=''
		    THEN '处理中' 
		    WHEN alm.`handel_state` = 3 
		    AND alm.`worder_no` IS NULL OR alm.`worder_no`=''
		    THEN '处理中' 
		    WHEN alm.`handel_state` = 4 
		    THEN '已完成'
		    WHEN alm.`handel_state` = 5
		    THEN '已关闭'
		  END AS state,
		  CASE
		    WHEN alm.`is_dispatch` = 1 
		    THEN '不派工' 
		    WHEN alm.`is_dispatch` = 2 
		    THEN '派工' 
		    ELSE '未确认' 
		  END AS isDispatch,
		  CASE
		    WHEN alm.`handel_state`=5 
		    THEN alm.update_time
		    ELSE IFNULL(alm.`handle_end`,'') 
		  END AS handleEnd,
		  CASE
		    WHEN alm.`worder_no` IS NULL 
		    THEN '' 
		    ELSE alm.`worder_no` 
		  END AS worderNo,
		  	CASE
			  WHEN alm.handel_state = 5 then cu.real_name 
			  when alm.wor_id is not null then uw.real_name
			  else (
			    CASE
			      WHEN GROUP_CONCAT(DISTINCT u.`real_name`) IS NOT NULL 
			      THEN GROUP_CONCAT(DISTINCT u.`real_name`) 
			    END
			  ) 
			END AS handleUserName 
		FROM
		  ${library.dynamic_dbname}.hk_alarm alm 
		  LEFT JOIN hotcomm_community.hk_alarm_state sta 
		    ON alm.`alarm_source_type` = sta.`id`
		  LEFT JOIN ${library.dynamic_dbname}.hk_worder w 
		    ON alm.wor_id = w.`id`  
		  LEFT JOIN hotcomm_community.`hk_sys_user` u 
		    ON FIND_IN_SET(u.`user_id`,
		    
		    REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(handel_user->"$.user",'[',''),']',''),' ',''),'{"id":"',''),'"}','')
		    
		    )
		    LEFT JOIN hotcomm_community.`hk_sys_user` uw on uw.user_id=w.handle_user_id
		    LEFT JOIN ${library.dynamic_dbname}.hk_device d on d.id=alm.alarm_source_id and alm.alarm_type=1
		    LEFT JOIN hotcomm_community.`hk_sys_user` cu ON alm.close_user_id=cu.user_id
		where 1=1
		<if test="alarmPagePA.getCarInfo==1">
			and alm.alarm_type=2
			<if test="alarmPagePA.pageType==1">
					and alm.handel_state!=2 AND alm.handel_state!=4 AND alm.handel_state!=5
				</if>
			<if test="alarmPagePA.pageType==2">
					and alm.handel_state!=0 and alm.handel_state!=1 and alm.handel_state!=3
			</if>
		</if>
		<if test="alarmPagePA.getCarInfo==2 or alarmPagePA.getCarInfo==null">
				<if test="alarmPagePA.pageType==1">
					and alm.handel_state!=2 AND alm.handel_state!=4 AND alm.handel_state!=5
				</if>
				<if test="alarmPagePA.pageType==2">
					and alm.handel_state!=0 and alm.handel_state!=1 and alm.handel_state!=3
				</if>
				<if test="alarmPagePA.alarmType != null">
					and alm.alarm_type=${alarmPagePA.alarmType}
				</if>
				<if test="alarmPagePA.moduleId != null">
					and alm.module_id=${alarmPagePA.moduleId}
				</if>
<!-- 				<if	test="alarmPagePA.alarmMessage != null and alarmPagePA.alarmMessage != ''"> -->
<!-- 					and alm.alarm_message like -->
<!-- 					CONCAT('%',#{alarmPagePA.alarmMessage},'%') -->
<!-- 				</if> -->
		</if>
		<if	test="alarmPagePA.alarmMessage != null and alarmPagePA.alarmMessage != ''">
					and alm.alarm_message like
					CONCAT('%',#{alarmPagePA.alarmMessage},'%')
		</if>
		<if test="alarmPagePA.startTime != null and alarmPagePA.startTime != ''">
			and alm.create_time>=#{alarmPagePA.startTime}
		</if>
		<if test="alarmPagePA.endTime != null and alarmPagePA.endTime != ''">
			and alm.create_time&lt;=#{alarmPagePA.endTime}
		</if>
		<if test="alarmPagePA.handelState != null">
			<if test="alarmPagePA.handelState==0">
			and alm.handel_state=0
			</if>
			<if test="alarmPagePA.handelState==1">
			and (alm.handel_state = 1 OR alm.handel_state = 3)
			</if>
			<if test="alarmPagePA.handelState==2">
			and alm.handel_state=3
			</if>
			<if test="alarmPagePA.handelState==3">
			and alm.handel_state in (2,4)
			</if>
			<if test="alarmPagePA.handelState==4">
			and alm.handel_state=5
			</if>
		</if>
		<if test="alarmPagePA.handelUser != null">
			and
			(FIND_IN_SET(${alarmPagePA.handelUser},REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(handel_user->"$.user",'[',''),']',''),' ',''),'{"id":"',''),'"}','')) or w.handle_user_id=${alarmPagePA.handelUser} or alm.close_user_id=${alarmPagePA.handelUser})
		</if>
		<if test="alarmPagePA.isDispatch==2">
			and alm.is_dispatch=2
		</if>
		GROUP BY alm.id
		order by alm.create_time desc
	</select>
	
	<!-- 获取设备维修日志 -->
	<select id="getDevFixLog" resultType="com.hotcomm.community.common.bean.pa.process.DevFixLogPA">
			SELECT 
			  w.`error_cause` AS description,
			  w.`handle_begin` AS repairTime,
			  u.`real_name` AS repairMan,
			  CASE
			    WHEN w.process_mode = 1 
			    THEN '设备维修' 
			    WHEN w.process_mode = 2 
			    THEN '设备更换' 
			    WHEN w.process_mode = 3 
			    THEN '其他处理' 
			    WHEN w.process_mode = 4 
			    THEN '工单挂起' 
			  END AS result 
			FROM
			  ${library.dynamic_dbname}.hk_worder w 
			  LEFT JOIN hotcomm_community.`hk_sys_user` u 
			    ON u.`user_id` = w.`handle_user_id` 
			WHERE w.`module_id` = #{devId} 
			  AND w.`device_id` = #{moduleId}  
			  AND w.`order_status` = 3 
	</select>
	
	<!-- 获取设备报警日志 -->
	<select id="getDevAlarmLog" resultType="com.hotcomm.community.common.bean.ui.process.DevAlarmLogUM">
			SELECT 
			  a.`alarm_message` AS errorCause,
			  CONCAT(a.`alarm_level`, '级') AS alarmLevel,
<!-- 			  case when a.`create_time` is not null then a.`create_time` end AS alarmTime, -->
case when date_sub(a.`create_time`,interval 8 hour) is not null then date_sub(a.`create_time`,interval 8 hour) end AS alarmTime,
			  CASE
			    WHEN a.`handel_state` = 0 
			    THEN '未处理' 
			    WHEN a.`handel_state` = 1 
			    THEN '报警处理中' 
			    WHEN a.`handel_state` = 2 
			    THEN '报警已处理' 
			    WHEN a.`handel_state` = 3 
			    AND a.`worder_no` IS NOT NULL 
			    AND a.`worder_no` != '' 
			    THEN '报警已处理,无法解决,工单处理中' 
			    WHEN a.`handel_state` = 3 
			    AND a.`worder_no` IS NULL 
			    OR a.`worder_no` = '' 
			    THEN '报警已处理,无法解决,等待转工单中' 
			    WHEN a.`handel_state` = 4 
			    THEN '报警转工单处理完成' 
			    WHEN a.`handel_state` = 5 
			    THEN '已关闭' 
			  END AS alarmState,
			  CASE
			    WHEN a.wor_id IS NOT NULL 
			    THEN (
			      CASE
			        WHEN w.process_mode = 1 
			        THEN '设备维修' 
			        WHEN w.process_mode = 2 
			        THEN '设备更换' 
			        WHEN w.process_mode = 3 
			        THEN '其他处理' 
			        WHEN w.process_mode = 4 
			        THEN '工单挂起' 
			        else ''
			      END
			    ) 
			    WHEN a.handel_state = 5 
			    THEN (
			      CASE
			        WHEN a.closed_result_id = 1 
			        THEN '误报' 
			        WHEN a.closed_result_id = 2 
			        THEN '设备自检' 
			        WHEN a.closed_result_id = 3 
			        THEN '人为干扰' 
			        WHEN a.closed_result_id = 4 
			        THEN '其他' 
			        else ''
			      END
			    ) 
			    ELSE s.state_name 
			  END AS handleMode,
			  CASE
			    WHEN a.wor_id IS NOT NULL 
			    THEN w.handle_end 
			    WHEN a.handel_state = 5 
			    THEN a.update_time 
			    ELSE a.handle_end 
			  END AS handleTime ,
			  concat(u.user_name,' ',u.telephone) as handleUserName,
			  case when a.alarm_value is not null then a.alarm_value else '' end AS alarmValue
			FROM
			  ${library.dynamic_dbname}.hk_alarm a 
			  LEFT JOIN ${library.dynamic_dbname}.hk_worder w 
			    ON w.id = a.wor_id 
			  LEFT JOIN hotcomm_community.`hk_alarm_handle_state` s 
			    ON s.id = a.handle_source_id 
			  LEFT JOIN hotcomm_community.`hk_sys_user` u 
			    ON u.user_id = a.handle_user_id
			WHERE a.`alarm_type` = 1 
			  AND a.`module_id` = #{moduleId} 
			  AND a.`alarm_source_id` = #{devId} 
	</select>

	<!-- 关闭报警 -->
	<update id="closeAlarm">
		UPDATE ${lib.dynamic_dbname}.hk_alarm alm SET
		alm.`alarm_view`=#{pa.alarmView},alm.`closed_remark`=#{pa.closedRemark},
		alm.`closed_result_id`=#{pa.closeResultID},alm.`handel_state`=5,alm.`close_user_id`=#{pa.userid},
		alm.`update_user`=#{pa.userid},alm.`update_time`=NOW()
		WHERE alm.`id`=#{pa.alarmID}
	</update>

	<!-- 获取报警详情 -->
	<select id="alarmDetail" resultType="java.util.HashMap">
		SELECT 
		  CASE
		   WHEN alm.handel_state=0 THEN 1
		   WHEN alm.handel_state=1 THEN 2
		   WHEN alm.handel_state=3 AND alm.worder_no IS NULL OR alm.`worder_no`='' THEN 3
		   WHEN alm.handel_state=3 AND alm.worder_no IS NOT NULL AND alm.`worder_no`!='' THEN 4
		   WHEN alm.handel_state=4 THEN 5
		   WHEN alm.handel_state=2 THEN 6
		   WHEN alm.handel_state=5 THEN 7
		   END AS pageState,
		  CASE
		   WHEN alm.handel_state=0 THEN 2
		   WHEN alm.handel_state=1 THEN 2
		   WHEN alm.handel_state=5 AND alm.handle_begin IS NULL THEN 4
		   WHEN alm.handel_state=5 AND alm.handle_begin IS NOT NULL THEN 3
		   WHEN alm.handel_state=2 THEN 2
		   WHEN alm.handel_state=3 AND alm.worder_no IS NULL THEN 1
		   WHEN alm.handel_state=3 AND alm.worder_no IS NOT NULL THEN 1
		   WHEN alm.handel_state=4 THEN 1
		   END AS canvaType,
		  CASE
		   WHEN alm.handel_state=0 THEN 1
		   WHEN alm.handel_state=1 THEN 2
		   WHEN alm.handel_state=5 AND alm.handle_begin IS NULL THEN 2
		   WHEN alm.handel_state=5 AND alm.handle_begin IS NOT NULL THEN 3
		   WHEN alm.handel_state=2 THEN 3
		   WHEN alm.handel_state=3 AND alm.worder_no IS NULL OR alm.`worder_no`='' THEN 3
		   WHEN alm.handel_state=3 AND alm.worder_no IS NOT NULL AND alm.`worder_no`!='' THEN 4
		   WHEN alm.handel_state=4 THEN 5
		   END AS canvaProgress,  
		  CASE
		    WHEN alm.alarm_type = 1 
		    THEN '设备' 
		    WHEN alm.alarm_type = 2 
		    THEN '车辆' 
		    WHEN alm.alarm_type = 3 
		    THEN '人员' 
		  END AS alarmSourceType,
		  CASE
		    WHEN alm.`handel_state` = 0 
		    THEN '未处理' 
		    WHEN alm.`handel_state` = 1 
		    THEN '报警处理中' 
		    WHEN alm.`handel_state` = 2 
		    THEN '报警已处理(完成)' 
		    WHEN alm.`handel_state` = 3 
		    AND alm.`worder_no` IS NOT NULL AND alm.`worder_no`!=''
		    THEN '报警已处理,无法解决,工单处理中' 
		    WHEN alm.`handel_state` = 3 
		    AND alm.`worder_no` IS NULL OR alm.`worder_no`=''
		    THEN '报警已处理,无法解决,等待转工单中'
		    WHEN alm.`handel_state` = 4 
		    THEN '报警转工单处理完成'
		    WHEN alm.`handel_state` = 5
		    THEN '已关闭'
		  END AS handleState,
<!-- 		  alm.create_time AS alarmTime, -->
			date_sub(alm.create_time,interval 8 hour) AS alarmTime,
		  alm.alarm_message AS alarmCotent,
		  CONCAT(alm.`alarm_level`,'级') as alarmLevel,
		  alm.alarm_source AS alarmSource,
		  CASE WHEN
		  alarm_address
		  IS NOT NULL
		  THEN
		  alarm_address
		  ELSE 
		  ''
		  END
		  AS address,
		  <if test="pa.type==2">
		  alarm_nature_of_vehicle AS natureOfTheVehicle,
		  </if>
		  <if test="pa.type==3">
		  alarm_nature_of_person AS natureOfPersonnel,
		  </if>
		  CASE WHEN
		  GROUP_CONCAT(u.real_name,' ',u.telephone) 
		  IS NOT NULL
		  THEN
		  GROUP_CONCAT(u.real_name,' ',u.telephone) 
		  ELSE 
		  ''
		  END
		  AS handleUser,
		  <if test="pa.type!=1">
		  CASE WHEN
		  JSON_EXTRACT(alm.`alarm_view`,'$.pendingView') 
		  IS NOT NULL
		  THEN
		  JSON_EXTRACT(alm.`alarm_view`,'$.pendingView') 
		  ELSE 
		  ''
		  END
  		  AS pendingVideoBeanJson,
  		  </if>
  		  <if test="pa.type==1">
		  case when dev.video_list is not null then dev.video_list else '' end as pendingVideoBeanJson,
		  case when dev.lat is not null then dev.lat else '' end as lat,case when dev.lon is not null then dev.lon else '' end as lng,
		  
		  case when dev.dev_num is not null then dev.dev_num else '' end as devNum,
		  case when dev.dev_type is not null then dev.dev_type else '' end as devType,
		  case when dev.mac is not null then dev.mac else '' end as devMac,
		  case when dev.lat is not null then dev.lat else '' end as devLat,
		  case when dev.lon is not null then dev.lon else '' end as devLng,
		  case when do.real_name is not null then do.real_name else '' end as ownerName,
		  case when do.telephone is not null then do.telephone else '' end as ownerTel,
		  case when dev.dev_address is not null then dev.dev_address else '' end as devAddress,
		  case when dev.install_time is not null then dev.install_time else '' end as devInstallTime,
  		  case when REPLACE(REPLACE(REPLACE(REPLACE(dev.`picture_list`->"$.picture",'["',''),'"]',''),'"',''),' ','') is not null then REPLACE(REPLACE(REPLACE(REPLACE(dev.`picture_list`->"$.picture",'["',''),'"]',''),'"',''),' ','') else '' end as devInstallImg,
  		  </if>
  		  alm.`alarm_view` AS allViewJson,
  		  <if test="pa.state!=0">
  		  CASE WHEN
		  CONCAT(uForProcessing.`real_name`,' ',uForProcessing.telephone) 
		  IS NOT NULL
		  THEN
		  CONCAT(uForProcessing.`real_name`,' ',uForProcessing.telephone) 
		  ELSE 
		  ''
		  END
  		  AS processingHandledBy,
  		  </if>
  		  <if test="pa.state!=0">
  				case when alm.handle_begin is not null then alm.handle_begin else '' end AS processingHandleBeginTime,
  		  </if>
  		  <if test="pa.state==2">
				CONCAT(
				    FLOOR(
				      TIMESTAMPDIFF(
				        SECOND,
				        alm.create_time,
				        alm.handle_end
				      ) / 86400
				    ),
				    '天',
				    TIMESTAMPDIFF(
				      HOUR,
				      alm.create_time,
				      alm.handle_end
				    ) % 24,
				    '时',
				    TIMESTAMPDIFF(
				      MINUTE,
				      alm.create_time,
				      alm.handle_end
				    ) % 60,
				    '分'
				  ) AS useTime,
				  case when alm.handle_end is not null then alm.handle_end else '' end as handleEndTime,
				CONCAT(
				    hUserE.real_name,
				    ' ',
				    hUserE.telephone
				  ) AS caseHandleUserEnd,
				s.state_name AS handleResult,
				alm.handle_result_by_alarm AS handleResultRemark,
  		  </if>
  		  <if test="pa.state==3">
  		  		<if test="pa.worderNo!=null and pa.worderNo!=''">
				CONCAT(
				    FLOOR(
				      TIMESTAMPDIFF(
				        SECOND,
				        alm.create_time,
				        w.create_time
				      ) / 86400
				    ),
				    '天',
				    TIMESTAMPDIFF(
				      HOUR,
				      alm.create_time,
				      w.create_time
				    ) % 24,
				    '时',
				    TIMESTAMPDIFF(
				      MINUTE,
				      alm.create_time,
				      w.create_time
				    ) % 60,
				    '分'
				  ) AS useTime,
				  </if>
				  <if test="pa.worderNo==null or pa.worderNo==''">
				CONCAT(
				    FLOOR(
				      TIMESTAMPDIFF(
				        SECOND,
				        alm.create_time,
				        alm.handle_end
				      ) / 86400
				    ),
				    '天',
				    TIMESTAMPDIFF(
				      HOUR,
				      alm.create_time,
				      alm.handle_end
				    ) % 24,
				    '时',
				    TIMESTAMPDIFF(
				      MINUTE,
				      alm.create_time,
				      alm.handle_end
				    ) % 60,
				    '分'
				  ) AS useTime,
				  </if>
				  case when alm.handle_end is not null then alm.handle_end else '' end as handleEndTime,
				CONCAT(
				    hUserE.real_name,
				    ' ',
				    hUserE.telephone
				  ) AS caseHandleUserEnd,
				CASE
				    WHEN alm.is_dispatch = 0 
				    THEN '未处理环节' 
				    WHEN alm.is_dispatch = 1 
				    THEN '处理反馈-不派工' 
				    WHEN alm.is_dispatch = 2 
				    THEN '处理反馈-需派工' 
				  END AS isDispatch,
				s.state_name AS handleResult,
				alm.handle_tip_by_alarm AS handleResultRemark,
				<if test="pa.worderNo!=null and pa.worderNo!=''">
					'已转工单' AS stateRemark,
					w.order_no AS orderNo,
					wu.real_name AS worderHandleUserName,
<!-- 					w.create_time AS worderCreateTime, -->
date_sub(w.create_time,interval 8 hour) AS worderCreateTime,
					wu.telephone AS worderHandleUserTel,
					case when w.time_confine=60 then '一小时' when w.time_confine=480 then '八小时' when w.time_confine=1440 then '一天内'  when w.time_confine=4320 then '三天内'  when w.time_confine=7200 then '其他（不紧急）' end AS timeConfine,
				</if>
  		  </if>
		   <if test="pa.state==4">
		   		CONCAT(
				    hUserE.real_name,
				    ' ',
				    hUserE.telephone
				  ) AS caseHandleUserEnd,
				CASE
				    WHEN alm.is_dispatch = 0 
				    THEN '未处理环节' 
				    WHEN alm.is_dispatch = 1 
				    THEN '处理反馈-不派工' 
				    WHEN alm.is_dispatch = 2 
				    THEN '处理反馈-需派工' 
				  END AS isDispatch,
				s.state_name AS handleResult,
				alm.handle_tip_by_alarm AS handleResultRemark,
		   		'已转工单' AS stateRemark,
<!-- 		        alm.handle_end AS alarmHandleEndTime, -->
IFNULL(DATE_SUB(alm.handle_end,INTERVAL 0 HOUR),'') AS alarmHandleEndTime,
		   		w.order_no AS orderNo,
				wu.real_name AS worderHandleUserName,
<!-- 				w.create_time AS worderCreateTime, -->
date_sub(w.create_time,interval 8 hour) AS worderCreateTime,
				wu.telephone AS worderHandleUserTel,
				case when w.time_confine=60 then '一小时' when w.time_confine=480 then '八小时' when w.time_confine=1440 then '一天内'  when w.time_confine=4320 then '三天内'  when w.time_confine=7200 then '其他（不紧急）' end AS timeConfine,
				CONCAT(
				    FLOOR(
				      TIMESTAMPDIFF(
				        SECOND,
				        alm.create_time,
				        alm.handle_end
				      ) / 86400
				    ),
				    '天',
				    TIMESTAMPDIFF(
				      HOUR,
				      alm.create_time,
				      alm.handle_end
				    ) % 24,
				    '时',
				    TIMESTAMPDIFF(
				      MINUTE,
				      alm.create_time,
				      alm.handle_end
				    ) % 60,
				    '分'
				  ) AS alarmHandleUseTime,
				  CONCAT(
				    FLOOR(
				      TIMESTAMPDIFF(
				        SECOND,
				        w.create_time,
				        w.handle_end
				      ) / 86400
				    ),
				    '天',
				    TIMESTAMPDIFF(
				      HOUR,
				      w.create_time,
				      w.handle_end
				    ) % 24,
				    '时',
				    TIMESTAMPDIFF(
				      MINUTE,
				      w.create_time,
				      w.handle_end
				    ) % 60,
				    '分'
				  ) AS worderHandleUseTime,
				  CASE 
				  WHEN w.process_mode=1
				  THEN '维修'
				  WHEN w.process_mode=2
				  THEN '更换'
				  WHEN w.process_mode=3
				  THEN '其他处理'
				  WHEN w.process_mode=4
				  THEN '挂起'
				  ELSE ''
				  END
				  AS worderHandleMode,
<!-- 				  w.handle_end AS worderHandleEndTime, -->
ifnull(date_sub(w.handle_end,interval 0 hour),'') AS worderHandleEndTime,
				  w.error_cause as errorCause,
				  case when w.handle_result is not null then w.handle_result else '' end as unDevHandleResult,
				  case when w.handle_view is not null then w.handle_view else '' end as worderView,
  		   </if>
  		   <if test="pa.state==5">
  		   		CASE 
  		   		WHEN alm.closed_result_id=1
  		   		THEN '误报'
  		   		WHEN alm.closed_result_id=2
  		   		THEN '设备自检'
  		   		WHEN alm.closed_result_id=3
  		   		THEN '人为干扰'
  		   		WHEN alm.closed_result_id=4
  		   		THEN '其他'
  		   		END AS closeResult,
  		   		case when alm.closed_remark is not null then alm.closed_remark else '' end AS closedRemark,
  		   		case when UserC.real_name is not null then UserC.real_name else '' end AS closeUserName,
  		   		case when alm.update_time is not null then alm.update_time else '' end AS closeTime,
  		   		CONCAT(
				    FLOOR(
				      TIMESTAMPDIFF(
				        SECOND,
				        alm.create_time,
				        alm.update_time
				      ) / 86400
				    ),
				    '天',
				    TIMESTAMPDIFF(
				      HOUR,
				      alm.create_time,
				      alm.update_time
				    ) % 24,
				    '时',
				    TIMESTAMPDIFF(
				      MINUTE,
				      alm.create_time,
				      alm.update_time
				    ) % 60,
				    '分'
				  ) AS closeUseTime,
  		   </if>
  		  alm.alarm_source_id AS alarmSourceID
		FROM
		   ${lib.dynamic_dbname}.hk_alarm alm 
		  LEFT JOIN  hotcomm_community.hk_alarm_state sta 
		    ON alm.alarm_source_type = sta.id 
		  LEFT JOIN hotcomm_community.`hk_sys_user` u 
		    ON FIND_IN_SET(u.user_id,REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(handel_user->"$.user",'[',''),']',''),' ',''),'{"id":"',''),'"}',''))
		  <if test="pa.state!=0">
		  LEFT JOIN hotcomm_community.`hk_sys_user` uForProcessing 
		    ON uForProcessing.`user_id` = alm.handle_user_id 
		  </if>
  		  <if test="pa.state==2">
		  LEFT JOIN hotcomm_community.hk_alarm_handle_state s 
		    ON s.id = alm.handle_source_id 
		  LEFT JOIN hotcomm_community.`hk_sys_user` hUserE 
		    ON alm.handle_user_id = hUserE.user_id
  		  </if>
  		  <if test="pa.state==3"> 
		  LEFT JOIN hotcomm_community.hk_alarm_handle_state s 
		    ON s.id = alm.handle_source_id 
		  LEFT JOIN hotcomm_community.`hk_sys_user` hUserE 
		    ON alm.handle_user_id = hUserE.user_id
		    <if test="pa.worderNo!=null and pa.worderNo!=''">
					LEFT JOIN ${lib.dynamic_dbname}.hk_worder w
					ON w.id=alm.wor_id
					LEFT JOIN hotcomm_community.hk_sys_user wu
					ON w.handle_user_id=wu.user_id
			</if>
  		  </if>
	  	  <if test="pa.state==4">
			  		LEFT JOIN hotcomm_community.hk_alarm_handle_state s 
		    		ON s.id = alm.handle_source_id 
		  			LEFT JOIN hotcomm_community.`hk_sys_user` hUserE 
		    		ON alm.handle_user_id = hUserE.user_id
					LEFT JOIN ${lib.dynamic_dbname}.hk_worder w
					ON w.id=alm.wor_id
					LEFT JOIN hotcomm_community.hk_sys_user wu 
					ON w.handle_user_id=wu.user_id
	  	  </if> 
	  	  <if test="pa.state==5">
  		   		LEFT JOIN hotcomm_community.`hk_sys_user` UserC 
		    	ON alm.close_user_id = UserC.user_id
  		  </if>
  		  <if test="pa.type==1">
		  LEFT JOIN ${lib.dynamic_dbname}.hk_device dev
		  on dev.id=alm.alarm_source_id
		  left join hotcomm_community.hk_sys_user do
		  on dev.own_id=do.user_id 
  		  </if>
		WHERE alm.`id` = #{pa.alarmID}
		GROUP BY alm.id
	</select>
	
	<!-- 获取设备基本信息 -->
	<select id="getAlarmCover" resultType="com.hotcomm.community.common.bean.db.process.AlarmTypeStateDM"> 
		SELECT a.`worder_no` AS worderNo,a.`is_dispatch` AS isDispatch,a.`alarm_type` AS alarmType,a.`handel_state` AS handelState FROM ${lib.dynamic_dbname}.hk_alarm a WHERE a.`id`=#{alarmID}
	</select>
	
	<!-- 新增报警时获取设备信息 -->
	<select id="getAlarmDevInfo" resultType="com.hotcomm.community.common.bean.pa.process.alarm.AlarmInsertPA">
		SELECT 
		  CONCAT(
		    d.`dev_type`,
		    '设备',
		    d.`mac`,
		    s.`state_name`
		  ) AS alarmMessage,
		  d.`dev_address` AS alarmAddress,
		  gz.`inner_userid` AS handelUser
		  ,d.`lat`,d.`lon` AS lng,s.id as alarmSourceType,s.level as alarmLevel
		FROM
		  ${library.dynamic_dbname}.hk_device d 
		  LEFT JOIN hotcomm_community.`hk_alarm_state` s 
		    ON s.`id` = #{library.alarmStateId} 
		  LEFT JOIN ${library.dynamic_dbname}.`hk_device_alarm_gz` gz 
		    ON gz.`alarm_mac` = d.`mac` 
		WHERE d.`id` = #{library.devid} 
		GROUP BY d.`id` 
	</select>
	
	<!-- 获取报警基本信息  -->
	<select id="checkAlarmLog" resultType="com.hotcomm.community.common.bean.pa.process.alarm.AlarmInsertPA">
		SELECT 
<!-- 		  COUNT(1) AS checkAlarmCount, -->
		  a.id AS alarmID
		FROM
		  ${lib.dynamic_dbname}.hk_alarm a 
		WHERE a.`alarm_source` = #{pa.alarmSource} 
<!-- 		  AND a.`alarm_source_type` = #{pa.alarmSourceType}   -->
AND a.`alarm_message` = #{pa.alarmMessage}
		  AND a.`handel_state` != 2 
		  AND a.`handel_state` != 3 
		  AND a.`handel_state` != 4 
		  AND a.alarm_source!='陌生人'
ORDER BY a.`create_time` 
LIMIT 1 
<!-- 		group by alarmID -->
	</select>
	
	<!-- 报警入库到报警主表 -->
	<insert id="insertAlarmToMain" parameterType="com.hotcomm.community.common.bean.pa.process.alarm.AlarmInsertPA" useGeneratedKeys="true" keyProperty="alarmID">
		INSERT INTO ${test.dynamic_dbname}.hk_alarm (
		  alarm_source_type,
		  <if test="alarmSourceId!=null and alarmSourceId!=''">
		  alarm_source_id,
		  </if>
		  alarm_source,
		  alarm_message,
		  alarm_view,
		  <if test="alarmAddress!=null">
		  alarm_address,
		  </if>
		  <if test="alarmLevel!=null">
		  alarm_level,
		  </if>
		  <if test="alarmNatureOfVehicle!=null">
		  alarm_nature_of_vehicle,
		  </if>
		  <if test="alarmNatureOfPerson!=null">
		  alarm_nature_of_person,
		  </if>
		  <if test="alarmValue!=null">
		  alarm_value,
		  </if>
		  <if test="handelUser!=null and handelUser!=''">
		  handel_user,	
		  </if>
		  <if test="moduleId!=null">
		  module_id,
		  </if>
		  alarm_type,
		  <if test="userid!=null">
		  create_user,
		  </if>
		  create_time,
		  <if test="userid!=null">
		  update_user,
		  </if>
		   <if test="lat!=null">
		  lat,
		  </if>
		  <if test="lng!=null">
		  lng,
		  </if>
		  update_time
		) 
		VALUES
		  (
		    #{alarmSourceType},
		    <if test="alarmSourceId!=null and alarmSourceId!=''">
		    #{alarmSourceId},
		    </if>
		    #{alarmSource},
		    #{alarmMessage},
			'{"closedView": {"img": [], "mp3": [], "video": []}, "finishView": {"img": [], "mp3": [], "video": []}, "pendingView": {"img": [], "mp3": [], "video": []}, "processedView": {"img": [], "mp3": [], "video": []}}',
		    <if test="alarmAddress !=null and alarmAddress !=''">
		    #{alarmAddress},
		    </if>
		    <if test="alarmLevel!=null">
		    #{alarmLevel},
		    </if>
		    <if test="alarmNatureOfVehicle !=null and alarmNatureOfVehicle !=''">
		    #{alarmNatureOfVehicle},
		    </if>
		    <if test="alarmNatureOfPerson !=null and alarmNatureOfPerson !=''">
		    #{alarmNatureOfPerson},
		    </if>
		    <if test="alarmValue !=null and alarmValue !=''">
		    #{alarmValue},
		    </if>
		    <if test="handelUser!=null and handelUser!=''">
		  	#{handelUser},	
		 	</if>
		    <if test="moduleId !=null and moduleId !=''">
		    #{moduleId},
		    </if>
		    #{alarmType},
		    <if test="userid != null">
		    #{userid},
		    </if>
		    NOW(),
		    <if test="userid != null">
		    #{userid},
		    </if>
		    <if test="lat!=null">
		    #{lat},
		    </if>
		    <if test="lng!=null">
		    #{lng},
		    </if>
		    NOW()
		  )
	</insert>
	
	<!-- 获取报警信息 -->
	<select id="getAlarmMainInfo" resultType="com.hotcomm.community.common.bean.pa.process.alarm.AlarmInsertPA">
			SELECT 
			  case when a.lat is not null then a.lat else '' end as lat,
			  case when a.lng is not null then a.lng else '' end as lng,
			  id AS alarmID,
			  alarm_type AS alarmType,
			  alarm_source_id AS alarmSourceId,
			  alarm_source AS alarmSource,
			  alarm_source_type AS alarmSourceType,
			  alarm_message AS alarmMessage,
			  create_time AS createTime,
			  create_user AS createUser,
			  CASE WHEN alarm_value IS NOT NULL THEN alarm_value ELSE '' END AS alarmValue
			FROM
			  ${lib.dynamic_dbname}.hk_alarm a 
			WHERE a.`id` = #{alarmID}
	</select>
	
	<!-- 新增报警到报警附表 -->
	<insert id="insertAlarmToVice">
			INSERT INTO ${lib.dynamic_dbname}.hk_alarm_log (
			  alarm_type,
			  <if test="pa.alarmSourceId!=null">
			  alarm_source_id,
			  </if>
			  alarm_source,
			  alarm_source_type,
			  alarm_message,
			  create_time,
			  <if test="pa.createUser!=null">
			  create_user,
			  </if>
			  <if test="pa.lng!=null and pa.lng!=''">
			  lng,
			  </if>
			  <if test="pa.lat!=null and pa.lat!=''">
			  lat,
			  </if>
			  alarm_id
			) 
			VALUES
			  (
			    #{pa.alarmType},
			    <if test="pa.alarmSourceId!=null">
			    #{pa.alarmSourceId},
			    </if>
			    #{pa.alarmSource},
			    #{pa.alarmSourceType},
			    #{pa.alarmMessage},
			    NOW(),
			    <if test="pa.createUser!=null">
			    #{pa.createUser},
			    </if>
			    <if test="pa.lng!=null and pa.lng!=''">
			    #{pa.lng},
			    </if>
			    <if test="pa.lat!=null and pa.lat!=''">
			    #{pa.lat},
			    </if>
			    #{pa.alarmID}
			  )
	</insert>
	
	<!-- 获取报警日志信息 -->
	<select id="selectAlarmLogByAlarmId" resultType="java.util.HashMap">
		SELECT 
		  CONCAT(
		    l.`alarm_message`,
		    CASE
		      WHEN l.`alarm_value` IS NOT NULL 
		      THEN l.`alarm_value` 
		      ELSE '' 
		    END
		  ) AS alarmLogContent,
<!-- 		  l.`create_time` AS alarmTime  -->
IFNULL(
    DATE_SUB(l.`create_time`, INTERVAL 0 HOUR),
    ''
  ) AS alarmTime
		FROM
		  ${lib.dynamic_dbname}.hk_alarm_log l 
		WHERE 1=1
		<if test="alarmId!=null">
		AND l.`alarm_id` = #{alarmId} 
		</if>
		ORDER BY alarmTime DESC
	</select>
	
	<!-- 根据类型获取报警数目 -->
	<select id="getAlarmCountByType" resultType="java.util.HashMap">
<!-- 		SELECT IFNULL(t1.allCount,0) AS allCount,IFNULL(t1.finishAlarmCount,0) AS finishAlarmCount,IFNULL(t1.pendingAlarmCount,0) AS pendingAlarmCount,IFNULL(t1.percent,0) AS percent
		FROM (
		SELECT 
		  IFNULL((SELECT 
		    SUM(
		      (SELECT 
		        COUNT(a.`id`) AS alarmCount 
		      FROM
		        ${lib.dynamic_dbname}.hk_alarm a) + 
		      (SELECT 
		        COUNT(e.`id`) AS eventCount 
		      FROM
		        ${lib.dynamic_dbname}.hk_event e)
		    ) AS todayCount),0) AS allCount,
		  IFNULL((SELECT 
		    SUM(
		      (SELECT 
		        COUNT(a.`id`) AS alarmCount 
		      FROM
		        ${lib.dynamic_dbname}.hk_alarm a 
		      WHERE a.`handel_state` = 4) + 
		      (SELECT 
		        COUNT(e.`id`) AS eventCount 
		      FROM
		        ${lib.dynamic_dbname}.hk_event e 
		      WHERE e.`event_status` = 5)
		    ) AS todayCount),0) AS finishAlarmCount,
		  IFNULL((SELECT 
		    SUM(
		      (SELECT 
		        COUNT(a.`id`) AS alarmCount 
		      FROM
		        ${lib.dynamic_dbname}.hk_alarm a 
		      WHERE a.`handel_state` = 0) + 
		      (SELECT 
		        COUNT(e.`id`) AS eventCount 
		      FROM
		        ${lib.dynamic_dbname}.hk_event e 
		      WHERE e.`event_status` = 1)
		    ) AS todayCount),0) AS pendingAlarmCount,
		  IFNULL(
		    (
		        ROUND(
		          (SELECT 
		            SUM(
		              (SELECT 
		                COUNT(a.`id`) AS alarmCount 
		              FROM
		                ${lib.dynamic_dbname}.hk_alarm a 
		                LEFT JOIN ${lib.dynamic_dbname}.hk_worder w 
		                  ON a.`wor_id` = w.`id` 
		              WHERE a.`handel_state` = 4 
		                AND w.time_confine >= TIMESTAMPDIFF(
		                  MINUTE,
		                  w.`create_time`,
		                  w.`handle_end`
		                ))
		            ) + 
		            (SELECT 
		              COUNT(e.`id`) AS alarmCount 
		            FROM
		              ${lib.dynamic_dbname}.hk_event e 
		              LEFT JOIN ${lib.dynamic_dbname}.hk_worder w 
		                ON w.id = e.worder_id 
		            WHERE e.`event_status` = 5 
		              AND e.time_confine >= TIMESTAMPDIFF(
		                MINUTE,
		                e.create_time,
		                w.`handle_end`
		              ))) / 
		          (SELECT 
		            SUM(
		              (SELECT 
		                COUNT(a.`id`) AS alarmCount 
		              FROM
		                ${lib.dynamic_dbname}.hk_alarm a) + 
		              (SELECT 
		                COUNT(e.`id`) AS eventCount 
		              FROM
		                ${lib.dynamic_dbname}.hk_event e)
		            )) * 100,
		          0
		        )
		    ),
		    0
		  ) AS percent 
		FROM
		  ${lib.dynamic_dbname}.hk_alarm a 
		GROUP BY allCount ) t1 RIGHT JOIN (SELECT 1) t2 ON 1=1 -->
		SELECT IFNULL(t1.allCount,0) AS allCount,IFNULL(t1.finishAlarmCount,0) AS finishAlarmCount,IFNULL(t1.pendingAlarmCount,0) AS pendingAlarmCount,IFNULL(t1.percent,0) AS percent
		FROM (
		SELECT 
		  IFNULL((SELECT SUM((SELECT COUNT(a.`id`) AS alarmCount FROM ${lib.dynamic_dbname}.hk_alarm a WHERE LAST_DAY(NOW()) >= a.`create_time` AND a.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')) + (SELECT COUNT(e.`id`) AS eventCount FROM ${lib.dynamic_dbname}.hk_event e WHERE LAST_DAY(NOW()) >= e.`create_time` AND e.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01'))) AS todayCount),0) AS allCount,
		  IFNULL((SELECT SUM((SELECT COUNT(a.`id`) AS alarmCount FROM ${lib.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 4 AND LAST_DAY(NOW()) >= a.`create_time` AND a.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')) + (SELECT COUNT(e.`id`) AS eventCount FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`event_status` = 3 AND LAST_DAY(NOW()) >= e.`create_time` AND e.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01'))) AS todayCount),0) AS finishAlarmCount,
		  IFNULL((SELECT SUM((SELECT COUNT(a.`id`) AS alarmCount FROM ${lib.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND LAST_DAY(NOW()) >= a.`create_time` AND a.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')) + (SELECT COUNT(e.`id`) AS eventCount FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`event_status` = 0 AND LAST_DAY(NOW()) >= e.`create_time` AND e.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01'))) AS todayCount),0) AS pendingAlarmCount,
		  IFNULL((ROUND((SELECT SUM((SELECT COUNT(a.`id`) AS alarmCount FROM ${lib.dynamic_dbname}.hk_alarm a LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON a.`wor_id` = w.`id` WHERE a.`handel_state` = 4 AND w.time_confine >= TIMESTAMPDIFF(MINUTE,w.`create_time`,w.`handle_end`) AND LAST_DAY(NOW()) >= a.`create_time` AND a.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01'))) + (SELECT COUNT(e.`id`) AS alarmCount FROM ${lib.dynamic_dbname}.hk_event e LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON w.id = e.worder_id WHERE e.`event_status` = 3 AND e.time_confine >= TIMESTAMPDIFF(MINUTE,e.create_time,w.`handle_end`) AND LAST_DAY(NOW()) >= e.`create_time` AND e.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01'))) 
		            / 
		          (SELECT 
		            SUM((SELECT COUNT(a.`id`) AS alarmCount FROM ${lib.dynamic_dbname}.hk_alarm a WHERE LAST_DAY(NOW()) >= a.`create_time` AND a.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')) + (SELECT COUNT(e.`id`) AS eventCount FROM ${lib.dynamic_dbname}.hk_event e WHERE LAST_DAY(NOW()) >= e.`create_time` AND e.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01'))
		            )) * 100,
		          0
		        )
		    ),
		    0
		  ) AS percent 
		FROM (SELECT 1=1) t
		LEFT JOIN ${lib.dynamic_dbname}.hk_alarm a ON 1=1
		GROUP BY allCount ) t1 RIGHT JOIN (SELECT 1) t2 ON 1=1
	</select>
	
	<!-- 本月报警来源分布 (报警和事件合并)-->
	<select id="getAlarmCountBySource" resultType="java.util.HashMap">
		SELECT 
  		lableName,
  		CASE
    	WHEN lableName = '设备感知' 
    	THEN alarmCount
    	WHEN lableName = '人工上报' 
    	THEN eventCount 
    	ELSE 0 
  		END AS countInfo,
  		CASE
    	WHEN lableName = '设备感知' 
    	THEN IFNULL(CONCAT(ROUND(alarmCount / (eventCount + alarmCount)*100,0),'','%'),'0%')
    	WHEN lableName = '人工上报' 
    	THEN IFNULL(CONCAT(ROUND(eventCount / (eventCount + alarmCount)*100,0),'','%'),'0%')
    	ELSE CONCAT(0,'','%')
  		END AS percent 
		FROM
  		(SELECT 
    	'设备感知' AS lableName 
  		UNION
  		SELECT 
    	'人工上报' AS lableName 
  		UNION
  		SELECT 
    	'民意舆情' AS lableName) t1 
  		JOIN 
    	(SELECT COUNT(0) AS alarmCount FROM ${lib.dynamic_dbname}.hk_alarm a WHERE LAST_DAY(NOW()) >= a.`create_time` AND a.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')) t2 
  		JOIN 
    	(SELECT COUNT(0) AS eventCount FROM ${lib.dynamic_dbname}.hk_event e WHERE LAST_DAY(NOW()) >= e.create_time AND e.create_time>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')) t3 
	</select>
	
	<!-- 获取报警时段分析 ***月平均值 -->
	<select id="getAlarmCountAndPercentByCase" resultType="java.util.HashMap">
		SELECT 
		  t1.alarmType,
		  SUM(
		    CASE
		      WHEN a.`alarm_type` = 1 
		      AND t1.id = 1 
		      THEN 1 
		      WHEN a.`alarm_type` = 2 
		      AND t1.id = 2 
		      THEN 1 
		      WHEN a.`alarm_type` = 3 
		      AND t1.id = 3 
		      THEN 1 
		      ELSE 0 
		    END
		  ) AS alarmCount,
		  CASE
		    WHEN t1.id = 1 
		    THEN CONCAT(
		      ROUND(
		        SUM(
		          CASE
		            WHEN a.`alarm_type` = 1 
		            THEN 1 
		            ELSE 0 
		          END
		        ) / COUNT(a.id) * 100,
		        0
		      ),
		      '%'
		    ) 
		    WHEN t1.id = 2 
		    THEN CONCAT(
		      ROUND(
		        SUM(
		          CASE
		            WHEN a.`alarm_type` = 2 
		            THEN 1 
		            ELSE 0 
		          END
		        ) / COUNT(a.id) * 100,
		        0
		      ),
		      '%'
		    ) 
		    WHEN t1.id = 3 
		    THEN CONCAT(
		      ROUND(
		        SUM(
		          CASE
		            WHEN a.`alarm_type` = 3 
		            THEN 1 
		            ELSE 0 
		          END
		        ) / COUNT(a.id) * 100,
		        0
		      ),
		      '%'
		    ) 
		    ELSE 0 
		  END AS alarmPercent 
		FROM
		  ${lib.dynamic_dbname}.hk_alarm a 
		  RIGHT JOIN 
		    (SELECT 
		      m.id,
		      CASE
		        WHEN m.id = 1 
		        THEN '设备报警' 
		        WHEN m.id = 2 
		        THEN '车辆报警' 
		        WHEN m.id = 3 
		        THEN '人员报警' 
		      END AS alarmType 
		    FROM
		      hotcomm_community.hk_device_module m 
		    LIMIT 3) t1 
		    ON 1 = 1 
		GROUP BY t1.alarmType 
	</select>
	
	<!-- 报警趋势(环比) -->
 	<select id="getAlarmTrend" resultType="java.util.HashMap">
<!-- 		SELECT 
	  	t1.dayInfo,
	  	t1.currentMonthAlarmCount,
	  	COUNT(e.id)+COUNT(a.`id`) AS lastMonthAlarmCount 
		COUNT(DISTINCT e.id)+COUNT(DISTINCT a.`id`) AS lastMonthAlarmCount 

		FROM
	  	(  
	  	SELECT 
	    timeInfo.logo AS dayInfo,
	    COUNT(DISTINCT e.id)+COUNT(DISTINCT a.id) AS currentMonthAlarmCount 
	  	FROM
	    (  
	    SELECT 
	      DATE_FORMAT(
	        (ADDDATE(CURDATE(), INTERVAL @d HOUR)),
	        '%h'
	      ) AS TheDate,
	      @d := @d + 1 logo 
	    FROM
	      mysql.help_topic,
	      (SELECT 
	        @d := 0) temp) timeInfo 
	    LEFT JOIN ${lib.dynamic_dbname}.hk_alarm a 
	      ON DATE_FORMAT(a.`create_time`, '%d') = timeInfo.logo 
	      AND a.`create_time` &lt; LAST_DAY(CURDATE()) 
	      AND a.`create_time` >= DATE_ADD(
	        CURDATE(),
	        INTERVAL - DAY(CURDATE()) + 1 DAY
	      ) 
	     LEFT JOIN ${lib.dynamic_dbname}.hk_event e 
	      ON DATE_FORMAT(e.create_time, '%d') = timeInfo.logo 
	      AND e.create_time &lt; LAST_DAY(CURDATE()) 
	      AND e.create_time >= DATE_ADD(
	        CURDATE(),
	        INTERVAL - DAY(CURDATE()) + 1 DAY
	      ) 
	  GROUP BY timeInfo.logo 
	  ORDER BY timeInfo.logo 
	  LIMIT 31    
	  ) t1 
	  LEFT JOIN ${lib.dynamic_dbname}.hk_alarm a 
	    ON DATE_FORMAT(a.`create_time`, '%d') = t1.dayInfo 
	    AND a.`create_time` >= DATE_SUB(
	      DATE_SUB(DATE_FORMAT(NOW(), '%y-%m-%d'),INTERVAL EXTRACT(DAY FROM NOW()) - 1 DAY),INTERVAL 1 MONTH) 
	    AND a.`create_time` &lt; DATE_SUB(
	      DATE_SUB(DATE_FORMAT(NOW(), '%y-%m-%d'),INTERVAL EXTRACT(DAY FROM NOW()) DAY),
	      INTERVAL 0 MONTH
	    ) 
	    LEFT JOIN ${lib.dynamic_dbname}.hk_event e 
	    ON DATE_FORMAT(e.create_time, '%d') = t1.dayInfo 
	    AND e.create_time >= DATE_SUB(
	      DATE_SUB(DATE_FORMAT(NOW(), '%y-%m-%d'),INTERVAL EXTRACT(DAY FROM NOW()) - 1 DAY),INTERVAL 1 MONTH) 
	    AND e.create_time &lt; DATE_SUB(
	      DATE_SUB(DATE_FORMAT(NOW(), '%y-%m-%d'),INTERVAL EXTRACT(DAY FROM NOW()) DAY),
	      INTERVAL 0 MONTH
	    ) 
	GROUP BY t1.dayInfo 
	ORDER BY t1.dayInfo  --> 
		SELECT 
		t1.dayInfo,
		t1.currentMonthAlarmCount,
		COUNT(DISTINCT e.id)+COUNT(DISTINCT a.`id`) AS lastMonthAlarmCount 
		FROM(
		SELECT timeInfo.logo AS dayInfo,
		 COUNT(DISTINCT e.id)+COUNT(DISTINCT a.id) AS currentMonthAlarmCount 
		 FROM
		(  
		SELECT 
		DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%h') AS TheDate,
		@d := @d + 1 logo 
		FROM
		mysql.help_topic,
		(SELECT 
		@d := 0) temp) timeInfo 	
	 	LEFT JOIN ${lib.dynamic_dbname}.hk_alarm a ON DATE_FORMAT(a.`create_time`, '%d') = timeInfo.logo AND DATE_FORMAT(a.`create_time`, '%m')=DATE_FORMAT(CURDATE(), '%m') AND DATE_FORMAT(a.`create_time`, '%Y')=DATE_FORMAT(CURDATE(), '%Y')
		LEFT JOIN ${lib.dynamic_dbname}.hk_event e ON DATE_FORMAT(e.`create_time`, '%d') = timeInfo.logo AND DATE_FORMAT(e.`create_time`, '%m')=DATE_FORMAT(CURDATE(), '%m') AND DATE_FORMAT(e.`create_time`, '%Y')=DATE_FORMAT(CURDATE(), '%Y')
		GROUP BY timeInfo.logo 
		ORDER BY timeInfo.logo 
		LIMIT 31   
		) t1 	
	 	LEFT JOIN ${lib.dynamic_dbname}.hk_event e ON DATE_FORMAT(e.`create_time`, '%d') = t1.dayInfo AND DATE_FORMAT(e.`create_time`,'%Y-%m')=DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 MONTH),'%Y-%m')
		LEFT JOIN ${lib.dynamic_dbname}.hk_alarm a ON DATE_FORMAT(a.`create_time`, '%d') = t1.dayInfo AND DATE_FORMAT(a.`create_time`,'%Y-%m')=DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 MONTH),'%Y-%m')
		GROUP BY t1.dayInfo 
		ORDER BY t1.dayInfo 
	</select>
	
	<!-- 本月报警类型分布(事件加上报警) -->
	<select id="getAlarmType" resultType="java.util.HashMap">
		SELECT 
	  	sourceTypeEvent AS sourceType,
	  	CASE <!-- WHEN sourceTypeEvent='交通(事件)' THEN carCountFinally  -->
	  	WHEN sourceTypeEvent='户政(事件)' THEN perCountFinally WHEN sourceTypeEvent='设备(事件)' THEN devCountFinally ELSE countByTypeEvent END AS allCount
		FROM
	  	(SELECT 
	    *,
	    SUM(devCount) AS devCountFinally,
	    SUM(perCount) AS perCountFinally
	    <!-- SUM(carCount) AS carCountFinally -->
	  	FROM
	    (SELECT 
	     *,
	     CASE
	     WHEN a.sourceTypeEvent = '设备(事件)' 
	     AND b.sourceTypeAlarm = '设备(报警)' 
	     THEN a.countByTypeEvent + b.countTypeAlarm 
	     END AS devCount,
	     CASE
	     WHEN a.sourceTypeEvent = '户政(事件)' 
	     AND b.sourceTypeAlarm = '人员(报警)' 
	     THEN a.countByTypeEvent + b.countTypeAlarm 
	     END AS perCount
	     <!-- CASE
	     WHEN a.sourceTypeEvent = '交通(事件)' 
	     AND b.sourceTypeAlarm = '车辆(报警)' 
	     THEN a.countByTypeEvent + b.countTypeAlarm 
	     END AS carCount  -->
	     FROM		
	     (SELECT 
	     t1.`sourceTypeEvent`,
	     CASE
	     WHEN countByTypeEvent IS NOT NULL 
	     THEN countByTypeEvent 
	     ELSE 0 
	     END AS countByTypeEvent 
	     FROM
	     (SELECT 
	      IF(
	         a.source_type = 1,
	         '设备(事件)',
	          IF(
	          a.source_type = 2,
	          '户政(事件)',
	          IF(
	             a.source_type = 3,
	             '消防',
	              IF(
	                a.source_type = 4,
	                '治安',
	                IF(
	                   a.source_type = 5,
	                   '刑事',
	                    IF(
	                      a.source_type = 6,
	                      '交通',
	                      IF(
	                        a.source_type = 7,
	                        '生产安全',
	                        '其他'
	                      )
	                    )
	                  )
	                )
	              )
	            )
	          ) AS sourceTypeEvent,
	          SUM(
	            CASE
	              WHEN e.`id` != 0 
	              THEN 1 
	              ELSE 0 
	            END) AS countByTypeEvent 
	        FROM
	          (SELECT 
	            1 AS source_type 
	          UNION
	          SELECT 
	            2 AS source_type 
	          UNION
	          SELECT 
	            3 AS source_type 
	          UNION
	          SELECT 
	            4 AS source_type 
	          UNION
	          SELECT 
	            5 AS source_type 
	          UNION
	          SELECT 
	            6 AS source_type 
	          UNION
	          SELECT 
	            7 AS source_type 
	          UNION
	          SELECT 
	            8 AS source_type) a 
	          LEFT JOIN ${lib.dynamic_dbname}.hk_event e 
	            ON e.`event_type` = a.`source_type` 
	        WHERE LAST_DAY(NOW()) >= e.create_time 
	          AND e.create_time >= CONCAT(
	            DATE_FORMAT(LAST_DAY(NOW()), '%Y-%m-'),
	            '01'
	          ) 
	        GROUP BY a.`source_type`) a 
	        RIGHT JOIN 
	          (SELECT 
	            IF(
	              a.source_type = 1,
	              '设备(事件)',
	              IF(
	                a.source_type = 2,
	                '户政(事件)',
	                IF(
	                  a.source_type = 3,
	                  '消防',
	                  IF(
	                    a.source_type = 4,
	                    '治安',
	                    IF(
	                      a.source_type = 5,
	                      '刑事',
	                      IF(
	                        a.source_type = 6,
	                        '交通',
	                        IF(
	                          a.source_type = 7,
	                          '生产安全',
	                          '其他'
	                        )
	                      )
	                    )
	                  )
	                )
	              )
	            ) AS sourceTypeEvent 
	          FROM
	            (SELECT 
	              1 AS source_type 
	            UNION
	            SELECT 
	              2 AS source_type 
	            UNION
	            SELECT 
	              3 AS source_type 
	            UNION
	            SELECT 
	              4 AS source_type 
	            UNION
	            SELECT 
	              5 AS source_type 
	            UNION
	            SELECT 
	              6 AS source_type 
	            UNION
	            SELECT 
	              7 AS source_type 
	            UNION
	            SELECT 
	              8 AS source_type) a) t1 
	          ON a.sourceTypeEvent = t1.sourceTypeEvent 
	      GROUP BY t1.`sourceTypeEvent`  
	      ) a 
	      LEFT JOIN 
	        ( 		
	        SELECT 
	          t1.`sourceTypeAlarm`,
	          CASE
	            WHEN countTypeAlarm IS NOT NULL 
	            THEN countTypeAlarm 
	            ELSE 0 
	          END AS countTypeAlarm 
	        FROM
	          (SELECT 
	            IF(
	              a.alarm_type = 1,
	              '设备(报警)',
	              IF(
	                a.alarm_type = 2,
	                '车辆(报警)',
	                '人员(报警)'
	              )
	            ) AS sourceTypeAlarm,
	            SUM(
	              CASE
	                WHEN e.`id` != 0 
	                THEN 1 
	                ELSE 0 
	              END) AS countTypeAlarm 
	          FROM
	            (SELECT 
	              1 AS alarm_type 
	            UNION
	            SELECT 
	              2 AS alarm_type 
	            UNION
	            SELECT 
	              3 AS alarm_type) a 
	            LEFT JOIN ${lib.dynamic_dbname}.hk_alarm e 
	              ON e.`alarm_type` = a.`alarm_type` 
	          WHERE LAST_DAY(NOW()) >= e.`create_time` 
	            AND e.`create_time` >= CONCAT(
	              DATE_FORMAT(LAST_DAY(NOW()), '%Y-%m-'),
	              '01'
	            ) 
	          GROUP BY a.`alarm_type`) a 
	          RIGHT JOIN 
	            (SELECT 
	              IF(
	                a.alarm_type = 1,
	                '设备(报警)',
	                IF(
	                  a.alarm_type = 2,
	                  '车辆(报警)',
	                  '人员(报警)'
	                )
	              ) AS sourceTypeAlarm 
	            FROM
	              (SELECT 
	                1 AS alarm_type 
	              UNION
	              SELECT 
	                2 AS alarm_type 
	              UNION
	              SELECT 
	                3 AS alarm_type) a) t1 
	            ON a.sourceTypeAlarm = t1.sourceTypeAlarm 
	        GROUP BY t1.`sourceTypeAlarm`  
	        ) b 
	        ON 1 = 1) test 
	  	GROUP BY sourceTypeEvent 
	  	ORDER BY sourceTypeEvent) test 
	</select>

	<select id="getAlarmCountByHour" resultType="java.util.HashMap">
		SELECT 
		  COUNT(a.`id`) AS alarmCount,
		  t1.TheDate 
		FROM
		  (SELECT 
		    * 
		  FROM
		    ${lib.dynamic_dbname}.hk_alarm a 
		  WHERE a.`create_time` >= DATE_ADD(
		      CURDATE(),
		      INTERVAL - DAY(CURDATE()) + 1 DAY
		    ) 
		    AND a.`create_time` &lt;= LAST_DAY(CURDATE())) a 
		  RIGHT JOIN 
		    (SELECT 
		      DATE_FORMAT(
		        (ADDDATE(CURDATE(), INTERVAL @d HOUR)),
		        '%H'
		      ) AS TheDate,
		      @d := @d + 1 HOUR 
		    FROM
		      hotcomm_community.hk_diction,
		      (SELECT 
		        @d := 0) temp 
		    LIMIT 24) t1 
		    ON DATE_FORMAT(a.`create_time`, '%H') = t1.TheDate 
		GROUP BY t1.TheDate 
		ORDER BY t1.TheDate 
	</select>
	
	<!-- 获取本月报警设备分布 -->
	<select id="getAlarmCountByDevAlarmType" resultType="java.util.HashMap">
<!-- 		SELECT  -->
<!-- 		  t1.`state_name` AS stateName, -->
<!-- 		  COUNT(a.id) AS alarmCount  -->
<!-- 		FROM -->
<!-- 		  (SELECT  -->
<!-- 		    *  -->
<!-- 		  FROM -->
<!-- 		    hotcomm_community.`hk_alarm_state` s  -->
<!-- 		  WHERE s.`state_name` = '门禁未关'  -->
<!-- 		    OR s.`state_name` = '火灾报警'  -->
<!-- 		    OR s.`state_name` = '漏气报警'  -->
<!-- 		    OR s.`state_name` = '漏电报警'  -->
<!-- 		    OR s.`state_name` = '消防栓水压异常') t1  -->
<!-- 		  LEFT JOIN ${lib.dynamic_dbname}.hk_alarm a  -->
<!-- 		    ON a.`alarm_source_type` = t1.`id`  -->
<!-- 		    AND a.`alarm_type` = 1 AND LAST_DAY(NOW()) >= a.`create_time` AND a.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01') -->
<!-- 		GROUP BY t1.`state_name`  -->

<!-- 		SELECT  -->
<!-- 		  t1.`state_name` AS stateName, -->
<!-- 		  COUNT(a.id) AS alarmCount  -->
<!-- 		FROM -->
<!-- 		  (SELECT  -->
<!-- 		    *  -->
<!-- 		  FROM -->
<!-- 		    hotcomm_community.`hk_alarm_state` s  -->
<!-- 		  WHERE s.`state_name` = '门禁未关'  -->
<!-- 		    OR s.`state_name` = '火灾报警'  -->
<!-- 		    OR s.`state_name` = '漏气报警'  -->
<!-- 		    OR s.`state_name` = '漏电报警'  -->
<!-- 		    OR s.`state_name` = '消防栓水压异常') t1  -->
<!-- 		  LEFT JOIN ${lib.dynamic_dbname}.hk_alarm a  -->
<!-- 		    ON a.`alarm_source_type` = t1.`id`  -->
<!-- 		    AND a.`alarm_type` = 1  -->
<!-- 		GROUP BY t1.`state_name`  -->
			SELECT 
			  CASE
			    WHEN t1.`state_name` = '门长开报警' 
			    THEN '门禁未关' 
			    WHEN t1.`state_name` = '烟雾报警' 
			    THEN '火灾报警' 
			    WHEN t1.`state_name` = '气体泄漏' 
			    THEN '漏气报警' 
			    WHEN t1.`state_name` = '电流异常报警' 
			    THEN '漏电报警' 
			    WHEN t1.`state_name` = '压力异常报警' 
			    THEN '消防栓水压异常' 
			  END AS stateName,
			  COUNT(a.id) AS alarmCount 
			FROM
			  (SELECT 
			    * 
			  FROM
			    hotcomm_community.`hk_alarm_state` s 
			  WHERE s.`state_name` = '门长开报警' 
			    OR s.`state_name` = '烟雾报警' 
			    OR s.`state_name` = '气体泄漏' 
			    OR s.`state_name` = '电流异常报警' 
			    OR s.`state_name` = '压力异常报警') t1 
			  LEFT JOIN ${lib.dynamic_dbname}.hk_alarm a 
			    ON a.`alarm_source_type` = t1.`id` 
			    AND a.`alarm_type` = 1 AND LAST_DAY(NOW()) >= a.`create_time` AND a.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')
			GROUP BY t1.`state_name` 

	</select>
	
	<!-- 本月人口报警统计 -->
	<select id="getAlarmCountByPerType" resultType="java.util.HashMap">
		SELECT 
  		a.`黑名单人员` AS personLable,
 	 	SUM(CASE
    	WHEN a.`黑名单人员` = '黑名单人员' 
    	AND b.type_code = 'F04' 
    	THEN b.alarmCount 
    	WHEN a.`黑名单人员` = '关爱人群' 
    	AND b.type_code = 'F01' 
    	THEN b.alarmCount 
    	WHEN a.`黑名单人员` = '潜在危险人口' 
    	AND b.type_code = 'F02' 
    	THEN b.alarmCount 
    	ELSE 0 
  		END) AS countInfo 
		FROM
  		(SELECT 
    	'黑名单人员' 
  		UNION
  		SELECT 
    	'关爱人群' 
  		UNION
  		SELECT 
    	'潜在危险人口') a 
  		JOIN 
   		(
    	SELECT t1.* FROM (SELECT 
      	COUNT(a.`id`) AS alarmCount,
      	l.`type_code`
    	FROM
      	${lib.dynamic_dbname}.hk_alarm a 
      	RIGHT JOIN ${lib.dynamic_dbname}.hk_person_lable l 
        ON a.`alarm_type` = 3 
        AND a.`alarm_source_type` = l.`id`  
    	WHERE FIND_IN_SET(l.`type_code`, 'F01,F02,F04') AND MONTH(a.`create_time`)= MONTH(NOW()) 
    	GROUP BY l.`type_code` ) t1 RIGHT JOIN (SELECT 1) t2 ON 1=1) b  
		GROUP BY a.`黑名单人员`
	</select>
	
	<!-- 根据设备类型获取报警数目 -->	
	<select id="getAlarmCountByDevModule" resultType="java.util.HashMap">
		SELECT 
		  t1.module_name,
			IFNULL(CONCAT(ROUND(t1.countDetail / t2.countAll * 100,0),'%'),'0')AS alarmPercent,
		  t1.countDetail AS alarmCount 
		FROM
		  (SELECT 
		    t1.module_name,
		    COUNT(a.`id`) AS countDetail 
		  FROM
		    (SELECT 
		      * 
		    FROM
		      hotcomm_community.`hk_device_module` t) t1 
		    LEFT JOIN ${lib.dynamic_dbname}.hk_alarm a 
		      ON a.`module_id` = t1.id 
		      AND a.`alarm_type` = 1 AND LAST_DAY(NOW()) >= a.`create_time` AND a.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')
		  GROUP BY t1.id) t1 
		  LEFT JOIN 
		    (SELECT 
		      COUNT(1) AS countAll 
		    FROM
		      ${lib.dynamic_dbname}.hk_alarm a 
		    WHERE a.`alarm_type` = 1 AND LAST_DAY(NOW()) >= a.`create_time` AND a.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')) t2 
		    ON 1 = 1 
		GROUP BY t1.module_name 
	</select>
	
	<!-- 根据报警等级获取报警数目和占比 -->
	<select id="getAlarmCountPercentByLevel" resultType="java.util.HashMap">
		SELECT 
		  t1.alarmLevel,
		  SUM(
		    CASE
		      WHEN a.`alarm_level` = 1 
		      AND t1.id = 1 
		      THEN 1 
		      WHEN a.`alarm_level` = 2 
		      AND t1.id = 2 
		      THEN 1 
		      WHEN a.`alarm_level` = 3 
		      AND t1.id = 3 
		      THEN 1 
		      WHEN a.`alarm_level` = 4 
		      AND t1.id = 4 
		      THEN 1
		      WHEN a.`alarm_level` = 5 
		      AND t1.id = 5 
		      THEN 1
		      ELSE 0 
		    END
		  ) AS alarmCount,
		  CASE
		    WHEN t1.id = 1 
		    THEN CONCAT(
		      ROUND(
		        SUM(
		          CASE
		            WHEN a.`alarm_level` = 1 
		            THEN 1 
		            ELSE 0 
		          END
		        ) / COUNT(a.id) * 100,
		        0
		      ),
		      '%'
		    ) 
		    WHEN t1.id = 2 
		    THEN CONCAT(
		      ROUND(
		        SUM(
		          CASE
		            WHEN a.`alarm_level` = 2 
		            THEN 1 
		            ELSE 0 
		          END
		        ) / COUNT(a.id) * 100,
		        0
		      ),
		      '%'
		    ) 
		    WHEN t1.id = 3 
		    THEN CONCAT(
		      ROUND(
		        SUM(
		          CASE
		            WHEN a.`alarm_level` = 3 
		            THEN 1 
		            ELSE 0 
		          END
		        ) / COUNT(a.id) * 100,
		        0
		      ),
		      '%'
		    ) 
		    WHEN t1.id = 4 
		    THEN CONCAT(
		      ROUND(
		        SUM(
		          CASE
		            WHEN a.`alarm_level` = 4 
		            THEN 1 
		            ELSE 0 
		          END
		        ) / COUNT(a.id) * 100,
		        0
		      ),
		      '%'
		    )
		    WHEN t1.id = 5 
		    THEN CONCAT(
		      ROUND(
		        SUM(
		          CASE
		            WHEN a.`alarm_level` = 5 
		            THEN 1 
		            ELSE 0 
		          END
		        ) / COUNT(a.id) * 100,
		        0
		      ),
		      '%'
		    ) 
		    ELSE 0 
		  END AS alarmPercent 
		FROM
		  ${lib.dynamic_dbname}.hk_alarm a 
		  RIGHT JOIN 
		    (SELECT 
		      m.id,
		      CASE
		        WHEN m.id = 1 
		        THEN '1级警报' 
		        WHEN m.id = 2 
		        THEN '2级警报' 
		        WHEN m.id = 3 
		        THEN '3级警报' 
		        WHEN m.id = 4 
		        THEN '4级警报'
		        WHEN m.id = 5 
		        THEN '5级警报'
		      END AS alarmLevel 
		    FROM
		      hotcomm_community.hk_device_module m 
		    LIMIT 5) t1 
		    ON 1 = 1 
		GROUP BY t1.alarmLevel 
	</select>
	
	<select id="getCurrentAlarmCountAndLastMonthAlarmCountByDay" resultType="java.util.HashMap">
		SELECT 
		  t1.dayInfo,
		  t1.currentMonthAlarmCount,
		  COUNT(a.`id`) AS lastMonthAlarmCount 
		FROM
		  (SELECT 
		    timeInfo.logo AS dayInfo,
		    COUNT(a.id) AS currentMonthAlarmCount 
		  FROM
		    (SELECT 
		      DATE_FORMAT(
		        (ADDDATE(CURDATE(), INTERVAL @d HOUR)),
		        '%h'
		      ) AS TheDate,
		      @d := @d + 1 logo 
		    FROM
		      mysql.help_topic,
		      (SELECT 
		        @d := 0) temp) timeInfo 
		    LEFT JOIN ${lib.dynamic_dbname}.hk_alarm a 
		      ON DATE_FORMAT(a.`create_time`, '%d') = timeInfo.logo 
		      AND a.`create_time` &lt;= LAST_DAY(CURDATE()) 
		      AND a.`create_time` >= DATE_ADD(
		        CURDATE(),
		        INTERVAL - DAY(CURDATE()) + 1 DAY
		      ) 
		  GROUP BY timeInfo.logo 
		  ORDER BY timeInfo.logo 
		  LIMIT 31) t1 
		  LEFT JOIN ${lib.dynamic_dbname}.hk_alarm a 
		    ON DATE_FORMAT(a.`create_time`, '%d') = t1.dayInfo 
		    AND a.`create_time` >= DATE_SUB(
		      DATE_SUB(
		        DATE_FORMAT(NOW(), '%y-%m-%d'),
		        INTERVAL EXTRACT(DAY FROM NOW()) - 1 DAY
		      ),
		      INTERVAL 1 MONTH
		    ) 
		    AND a.`create_time` &lt;= DATE_SUB(
		      DATE_SUB(
		        DATE_FORMAT(NOW(), '%y-%m-%d'),
		        INTERVAL EXTRACT(DAY FROM NOW()) DAY
		      ),
		      INTERVAL 0 MONTH
		    ) 
		GROUP BY t1.dayInfo 
		ORDER BY t1.dayInfo 
	</select>
	
	<!-- 获取设备信息***关联报警 -->
	<select id="getDevRelationAlarm" resultType="com.hotcomm.community.common.bean.pa.process.worder.WorderCreateAlarmInfoPA">
		SELECT 
		  a.lng,a.lat,
		  a.`id` AS sourceId,
		  a.`alarm_message` AS sourceTitle,
		  a.`alarm_address` AS sourceInfo,
		  a.`create_time` AS sourceCreateTime,
		  CASE
		    WHEN a.handel_state = 0 
		    THEN '未处理' 
		    WHEN a.handel_state = 1 
		    THEN '处理中' 
		    WHEN a.handel_state = 2 
		    THEN '由报警人员处理' 
		    WHEN a.handel_state = 3 
		    THEN '由工单人员处理' 
		    WHEN a.handel_state = 4 
		    THEN '已关闭' 
		  END AS sourceStateName ,
		  CASE WHEN a.alarm_type=1 THEN a.`module_id` ELSE '' END AS moduleId,
 		  CASE WHEN a.alarm_type=1 THEN a.`alarm_source_id` ELSE '' END AS devId 
		FROM
		  ${library.dynamic_dbname}.hk_alarm a 
		WHERE 1=1  
		  <if test="queryType==1">
		  AND a.alarm_type = 1 
		  AND a.alarm_source_id = #{devId}
		  </if>
		  <if test="queryType==2"> 
		  <if test="alarmId!=null and alarmId!=''">
		  AND a.id IN (${alarmId})
		  </if>
		  AND a.handel_state IN (0,1,3)
		  <if test="selectStartTime!=null and selectStartTime!=''">
		  AND a.create_time>=#{selectStartTime}
		  </if>
		  <if test="selectEndTime!=null and selectEndTime!=''">
		  AND a.create_time&lt;=#{selectEndTime}
		  </if>
		  <if test="selectWord!=null and selectWord!=''">
		  AND a.alarm_message LIKE CONCAT('%',#{selectWord},'%') 
		  </if>
		  </if>
	</select>
	
	<!-- 获取设备信息***创建工单用 -->
	<select id="getDevInfoForCreate" resultType="com.hotcomm.community.common.bean.pa.process.worder.WorderCreateDevInfoPA">
		SELECT 
		  d.lat,d.lon as lng,
		  d.`dev_type` AS devType,
		  d.`id` AS devId,
		  d.`dev_num` AS devNum,
		  d.`dev_address` AS address, 
		  d.`module_id` AS moduleId
		  ,
		  CASE
		    WHEN COUNT(a.id) > 0 
		    THEN '是' 
		    ELSE '否' 
		  END AS alarmState 
		FROM
		  ${library.dynamic_dbname}.hk_device d 
		  <if test="queryType==1">
		  	inner join ${library.dynamic_dbname}.hk_alarm a on a.alarm_type=1 and a.alarm_source_id=d.id and a.handel_state=0 
		  </if>
		  <if test="queryType==0">
		 	 LEFT JOIN ${library.dynamic_dbname}.hk_alarm a 
    			ON a.`alarm_source_id` = d.`id` 
    	  </if>
		WHERE 1=1
		  <if test="deviceModule!=null and deviceModule!=''">
		  AND d.`module_id` = #{deviceModule} 
		  </if>
		  <if test="mac!=null and mac!=''">
		  AND d.`mac` = #{mac}
		  </if>
		  <if test="devId!='' and devId!=null and devId!='null'.toString()">
		  and d.`id` in (${devId})
		  </if>
		  GROUP BY d.`id` 
	</select>
	
	<!-- 获取事件信息***创建工单用 -->
	<select id="getEventInfo" resultType="com.hotcomm.community.common.bean.pa.process.worder.WorderCreateEventInfoPA">
		SELECT 
		  e.lat,e.lng,
		  e.handle_user_id as handleUserId,
		  e.event_desc as eventDesc,
		  e.`event_title` AS sourceTitle,
		  e.`id` AS sourceId,
		  e.`event_address` AS address,
		  e.`create_time` AS sourceCreateTime,
		  CASE
		    WHEN u.real_name IS NOT NULL 
		    THEN u.real_name 
		    ELSE '' 
		  END AS eventCreateUser,
		  CASE
		    WHEN e.event_status = 0 
		    THEN '待处理' 
		    WHEN e.event_status = 1
		    THEN '已转工单' 
		    WHEN e.event_status = 2
		    THEN '处理中' 
		    WHEN e.event_status = 3 
    		THEN '已处理' 
		    WHEN e.event_status = 4 
		    THEN '已关闭' 
		  END AS sourceStateName
		FROM
		  ${library.dynamic_dbname}.hk_event e 
		  LEFT JOIN hotcomm_community.hk_sys_user u 
		    ON e.`reported_user_id` = u.`user_id` 
		WHERE 1=1 and e.event_status not in (1,2,3,4)
		  <if test="queryType==1">
		  AND e.event_type = 1 
		  AND e.module_id=#{deviceModule}
		  AND e.source_id=#{devId}
		  </if>
		  <if test="queryType==2"> 
		  <if test="eventStr!=null and eventStr!=''">
		  AND e.id IN (${eventStr})
		  </if>
		  </if>
		  <if test="selectStartTime!=null and selectStartTime!=''">
		  AND e.event_htime>=#{selectStartTime}
		  </if>
		  <if test="selectEndTime!=null and selectEndTime!=''">
		  AND e.event_htime&lt;=#{selectEndTime}
		  </if>
		  <if test="selectWord!=null and selectWord!=''">
		  AND e.event_title LIKE CONCAT('%',#{selectWord},'%') 
		  </if>
		  GROUP BY e.id
	</select>
	
	<!-- 创建工单 -->
	<insert id="creatWorder" parameterType="com.hotcomm.community.common.bean.pa.process.worder.WorderCreatePA"  useGeneratedKeys="true" keyProperty="worderId">
		INSERT INTO ${map.dynamic_dbname}.hk_worder
		(
		order_title,
		order_desc,
		source_type,
		time_confine,
		<if test="sourceType==1">
			source_id,
			<if test="devId!=null and devId!=''">
			device_id,
			</if>
			<if test="moduleId!=null and moduleId!=''">
			module_id,
			</if>
			<if test="address!=null">
			source_address,
			</if>
			<if test="lng!=null">
			lng,
			</if>
			<if test="lat!=null">
			lat,
			</if>
		</if>
		<if test="sourceType==2">
			source_id,
			<if test="devId!=null">
			device_id,
			</if>
			<if test="moduleId!=null">
			module_id,
			</if>
			<if test="address!=null">
			source_address,
			</if>
			<if test="lng!=null">
			lng,
			</if>
			<if test="lat!=null">
			lat,
			</if>
		</if>
		<if test="sourceType==3">
			<if test="devId!=null">
			device_id,
			</if>
			<if test="sourceId!=null">
			source_id,
			</if>
			<if test="moduleId!=null">
			module_id,
			</if>
			<if test="address!=null">
			source_address,
			</if>
			<if test="lng!=null">
			lng,
			</if>
			<if test="lat!=null">
			lat,
			</if>
		</if>
		handle_user_id,order_status,handle_view,create_time,create_user_id,update_time,update_user,leader_tip
		)
		VALUES
		(
		#{orderTitle},
		#{orderDesc},
		<if test="sourceType==3 and sourceId==null">
		3,
		</if>
		<if test="sourceId!=null and sourceType==1">
		1,
		</if>
		<if test="sourceId!=null and sourceType==2">
		2,
		</if>
		<if test="sourceType==4">
		4,
		</if>
		#{orderTimeInfo},
		<if test="sourceType==1">
			#{sourceId},
			<if test="devId!=null and devId!=''">
			#{devId},
			</if>
			<if test="moduleId!=null and moduleId!=''">
			#{moduleId},
			</if>
			<if test="address!=null">
			#{address},
			</if>
			<if test="lng!=null">
			#{lng},
			</if>
			<if test="lat!=null">
			#{lat},
			</if>
		</if>
		<if test="sourceType==2">
			#{sourceId},
			<if test="devId!=null">
			#{devId},
			</if>
			<if test="moduleId!=null">
			#{moduleId},
			</if>
			<if test="address!=null">
			#{address},
			</if>
			<if test="lng!=null">
			#{lng},
			</if>
			<if test="lat!=null">
			#{lat},
			</if>
		</if>
		<if test="sourceType==3">
			<if test="devId!=null">
			#{devId},
			</if>
			<if test="sourceId!=null">
			#{sourceId},
			</if>
			<if test="moduleId!=null">
			#{moduleId},
			</if>
			<if test="address!=null">
			#{address},
			</if>
			<if test="lng!=null">
			#{lng},
			</if>
			<if test="lat!=null">
			#{lat},
			</if>
		</if>
		<if test="eventType!=null">
		#{handleUserId},
		</if>
		<if test="eventType==null">
<!-- 		#{userId}, -->
#{handleUserId},
		</if>
		0,'{"worderFinishView": {"mp3": [], "image": [], "video": []}, "worderHandleView": {"mp3": [], "image": [], "video": []}, "worderPendingView": {"mp3": [], "image": [], "video": []}, "worderProcessedView": {"mp3": [], "image": [], "video": []}}',NOW(),
		<if test="eventType!=null">
		#{handleUserId},
		</if>
		<if test="eventType==null">
		#{userId},
<!-- #{handleUserId}, -->
		</if>
		NOW()
		<if test="eventType!=null">
		,#{handleUserId},
		</if>
		<if test="eventType==null">
		,#{userId},
<!-- ,#{handleUserId}, -->
		</if>
		'{"leaderTip": {"tip": [{"id": "1", "content": "快速查明原因，并且杜绝后患", "user_id": "1", "leader_name": "李佳"}, {"id": "2", "content": "各部门注意安全", "user_id": "1", "leader_name": "尚书"}]}}'
		)
	</insert>
	
	<!-- 获取工单详情 -->
	<select id="getWorderDetail" resultType="java.util.HashMap">
		SELECT 
			  CASE
			    WHEN w.source_type = 1 
			    THEN 1 
			    WHEN w.source_type = 2 
			    THEN 2 
			    ELSE '' 
			  END AS infoType,
			  CASE
			    WHEN w.source_type = 1 
			    THEN w.source_id 
			    WHEN w.source_type = 2 
			    THEN w.source_id 
			    ELSE '' 
			  END AS infoId,
			  CASE
			    WHEN a.handel_state = 0 AND w.source_type=1
			    THEN 1 
			    WHEN a.handel_state = 1 AND w.source_type=1
			    THEN 2 
			    WHEN a.handel_state = 3 AND w.source_type=1
			    AND a.wor_id IS NULL
			    THEN 3 
			    WHEN a.handel_state = 3 AND w.source_type=1
			    AND a.wor_id IS NOT NULL
			    THEN 4 
			    WHEN a.handel_state = 4 AND w.source_type=1
			    THEN 5 
			    WHEN a.handel_state = 2 AND w.source_type=1
			    THEN 6 
			    WHEN a.handel_state = 5 AND w.source_type=1
			    THEN 7 
			    WHEN e.event_status = 0 AND w.source_type=2
			    THEN 1 
			    WHEN e.event_status = 1 AND w.source_type=2
			    THEN 2 
			    WHEN e.event_status = 2 AND w.source_type=2
			    THEN 3 
			    WHEN e.event_status = 3 AND w.source_type=2
			    THEN 4 
			    WHEN e.event_status = 4 AND w.source_type=2
			    THEN 5 
			    ELSE '' 
			  END AS infoPageState,
		w.source_type AS sourceType,
		CASE
		WHEN w.`order_status` = 1
		THEN 1
		WHEN w.`order_status` = 2
		THEN 2
		WHEN w.`order_status` = 3
		THEN 3
		WHEN w.`order_status` = 4
		THEN 4
		END AS pageState,
		<if test="state==2">
			CONCAT(
			    u4.`real_name`,
			    ' ',
			    u4.`telephone`
			  ) AS worderProcessingHandleUser,
			w.handle_begin AS worderHandleBeginTime,
		</if>
		<if test="state==3">
			'挂起' AS processMode,
<!-- 			  w.handle_end AS worderHandleEndTime, -->
			  ifnull(date_sub(w.handle_end,interval 0 hour),'') AS worderHandleEndTime,
			  CASE WHEN w.device_id IS NOT NULL THEN w.error_cause ELSE '' END AS errorRemark,
			  CASE WHEN w.device_id IS NULL THEN w.handle_result ELSE '' END AS worderhandleRemark,
			  case when w.handle_view->"$.worderHandleHangView" is not null then w.handle_view->"$.worderHandleHangView" else '' end AS hangViewJson,
		</if>
		<if test="state==4">
				CONCAT(
				    FLOOR(
				      TIMESTAMPDIFF(
				        SECOND,
				        w.handle_begin,
				        w.handle_end
				      ) / 86400
				    ),
				    '天',
				    TIMESTAMPDIFF(
				      HOUR,
				      w.handle_begin,
				      w.handle_end
				    ) % 24,
				    '时',
				    TIMESTAMPDIFF(
				      MINUTE,
				      w.handle_begin,
				      w.handle_end
				    ) % 60,
				    '分'
				  ) AS worderUseTime,
			  CASE
			    WHEN w.process_mode AND w.device_id IS NOT NULL  = 1 
			    THEN '设备维修' 
			    WHEN w.process_mode AND w.device_id IS NOT NULL  = 2 
			    THEN '设备更换' 
			    WHEN w.process_mode AND w.device_id IS NOT NULL  = 3 
			    THEN '其他处理' 
			    WHEN w.process_mode AND w.device_id IS NOT NULL  = 4 
			    THEN '工单挂起' 
			    ELSE '' 
			  END AS processMode,
<!-- 			  w.handle_end AS worderHandleEndTime, -->
ifnull(date_sub(w.handle_end,interval 0 hour),'') AS worderHandleEndTime,
			  CASE
			    WHEN w.error_cause  IS NOT NULL 
			    THEN w.error_cause 
			    ELSE '' 
			  END AS errorCause,
			  CASE WHEN w.device_id IS NULL THEN w.handle_result ELSE '' END AS worderhandleResult,
			  ifnull(w.handle_view->"$.worderHandleFinishView",'') AS finishViewJson,
		</if>
<!-- 		     以下共有部分 -->
		  w.order_no AS orderNo,
<!-- 		  w.`create_time` AS orderCreateTime, -->
			date_sub(w.`create_time`,interval 8 hour) AS orderCreateTime,
		  w.`order_title` AS orderTitle,
		  case when w.time_confine=60 then '一小时' when w.time_confine=480 then '八小时' when w.time_confine=1440 then '一天内'  when w.time_confine=4320 then '三天内'  when w.time_confine=7200 then '其他' end AS timeConfine,
		  case when w.time_confine=60 then '非常紧急' when w.time_confine=480 then '比较紧急' when w.time_confine=1440 then '紧急'  when w.time_confine=4320 then '一般'  when w.time_confine=7200 then '不紧急' end AS orderGrade,
		  w.`order_desc` AS orderDesc,
		  CONCAT(
		    u1.`real_name`,
		    ' ',
		    u1.`telephone`
		  ) AS worderCreateUser,
		  CONCAT(
		    u2.`real_name`,
		    ' ',
		    u2.`telephone`
		  ) AS worderHandleUser,
<!-- 		     以上共有部分 -->
<!-- 		     以下设备部分 -->
		  <if test="type==3">
		  d.`dev_type` AS devType,
		  d.`mac` AS mac,
		  d.`dev_address` AS devAddress,
		  d.`lat` AS devLat,
		  d.`lon` AS devLng,
		  REPLACE(
		    REPLACE(
		      REPLACE(
		        REPLACE(
		          d.`video_list`,
		          '{"video": ["',
		          ''
		        ),
		        '"]}',
		        ''
		      ),
		      ' "',
		      ''
		    ),
		    '"',
		    ''
		  ) AS videoList,
		  </if>
<!-- 		     以上设备部分 -->
<!-- 		     以下报警部分 -->
		  <if test="type==1">
		  a.alarm_message AS alarmTitle,
		  a.alarm_address AS alarmAddress,
<!-- 		  a.create_time AS alarmTime, -->
ifnull(date_sub(a.create_time,interval 0 hour),'') AS alarmTime,
		  CASE
		    WHEN a.`handel_state` = 0 
		    THEN '未处理' 
		    WHEN a.`handel_state` = 1 
		    THEN '报警处理中' 
		    WHEN a.`handel_state` = 2 
		    THEN '报警已处理' 
		    WHEN a.`handel_state` = 3 
		    AND a.`worder_no` IS NOT NULL 
		    AND a.`worder_no` != '' 
		    THEN '报警已处理,无法解决,工单处理中' 
		    WHEN a.`handel_state` = 3 
		    AND a.`worder_no` IS NULL 
		    OR a.`worder_no` = '' 
		    THEN '报警已处理,无法解决,等待转工单中' 
		    WHEN a.`handel_state` = 4 
		    THEN '报警转工单处理完成' 
		    WHEN a.`handel_state` = 5 
		    THEN '已关闭' 
		  END AS alarmState,
		  </if>
<!-- 		     以上报警部分 -->
<!-- 		     以下事件部分 -->
		  <if test="type==2">
		  e.event_title AS eventTitle,
		  e.event_address AS eventAddress,
<!-- 		  e.create_time AS eventCreateTime, -->
			date_sub(e.create_time,interval 8 hour) AS eventCreateTime,
		  CONCAT(
		    u3.`real_name`,
		    ' ',
		    u3.`telephone`
		  ) AS eventReportUser,
		  CASE WHEN w.order_status =4 THEN '已处理' ELSE '未处理' END AS eventState,
		  </if>
<!-- 		     以上事件部分 -->
		  w.leader_tip AS leaderTipJson,
		  CASE
		    WHEN w.hang_state = 1 
		    THEN 2 
		    ELSE 1 
		  END AS canvaType,
			CASE
			    WHEN w.order_status = 1 
			    THEN 1 
			    WHEN w.order_status = 2 
			    THEN 2 
			    WHEN w.order_status = 3 
			    AND w.hang_state = 0 
			    THEN 3 
			    WHEN w.order_status = 3 
			    AND w.hang_state = 1 
			    THEN 4 
			    WHEN w.order_status = 4 
			    AND w.hang_state = 0 
			    THEN 3 
			    WHEN w.order_status = 4 
			    AND w.hang_state = 1 
			    THEN 4 
			  END AS canvaProgress 
		FROM
		  ${library.dynamic_dbname}.hk_worder w 
		  LEFT JOIN ${library.dynamic_dbname}.hk_device d 
		    ON d.`id` = w.`device_id` 
		    AND w.`source_type` = 3 
		  LEFT JOIN ${library.dynamic_dbname}.hk_alarm a 
		    ON w.`source_type` = 1 
		    AND w.`source_id` = a.`id` 
		  LEFT JOIN ${library.dynamic_dbname}.hk_event e 
		    ON w.`source_type` = 2 
		    AND w.`source_id` = e.`id` 
		  LEFT JOIN hotcomm_community.`hk_sys_user` u1 
		    ON u1.`user_id` = w.`create_user_id` 
		  LEFT JOIN hotcomm_community.`hk_sys_user` u2 
		    ON u2.`user_id` = w.`handle_user_id` 
		  LEFT JOIN hotcomm_community.`hk_sys_user` u3 
		    ON u3.user_id = e.reported_user_id 
		  LEFT JOIN hotcomm_community.`hk_sys_user` u4
    		ON u4.user_id = w.`handle_user_id` 
		WHERE w.`id` = #{wid} 
	</select>
	
	<!-- 获取事件详情 -->
	<select id="getEventDetail" resultType="java.util.HashMap">
			SELECT 
			  case when e.video_relation is not null then e.video_relation else '' end as videoRelation,e.source_id as sourceId,
			  e.leader_tip as leaderTips,
			  CASE WHEN w.handle_view IS NOT NULL THEN w.handle_view ELSE '' END AS worderView,
<!-- 			  e.create_time AS  reportTime, -->
date_sub(e.create_time,interval 8 hour) AS reportTime, 
			  e.`event_title` AS eventTitle, 
			  CASE 
			  WHEN e.event_type=1 THEN '设备'
			  WHEN e.event_type=2 THEN '户政'
			  WHEN e.event_type=3 THEN '消防'
			  WHEN e.event_type=4 THEN '治安'
			  WHEN e.event_type=5 THEN '刑事'
			  WHEN e.event_type=6 THEN '交通'
			  WHEN e.event_type=7 THEN '生产安全'
			  WHEN e.event_type=8 THEN '其他'
			  END AS eventType,
			  CASE 
			  WHEN e.time_confine=60 THEN '非常紧急'
			  WHEN e.time_confine=480 THEN '比较紧急'
			  WHEN e.time_confine=1440 THEN '紧急'
			  WHEN e.time_confine=4320 THEN '一般'
			  WHEN e.time_confine=7200 THEN '不紧急'
			  END AS emergencyLevel,
			  e.event_desc AS eventDesc,
			  e.event_view AS eventView,
			  e.event_htime AS eventHtime,
			  e.event_address AS eventAddress,
			  e.lng AS eventLng,
			  e.lat AS eventLat,
			  uOfReported.real_name as reportUserName,
			  uOfReported.telephone as reportUserTelephone,
			  case when e.event_status=0 then '待处理' when e.event_status=1 then '已转工单' when e.event_status=2 then '处理中' when e.event_status=3 then '已处理' when e.event_status=4 then '已关闭' end as eventState,
			  <if test="state==1 or state==2 or state==3">
			  <if test="state==1 or state==2">
			  '已转工单' AS  stateValidation,
			  <if test="state==1">
			  '是' AS isDispatch,
			  </if>
			  </if>
			  CASE 
			  WHEN e.time_confine=60 THEN '一小时内'
			  WHEN e.time_confine=480 THEN '八小时内'
			  WHEN e.time_confine=1440 THEN '一天内'
			  WHEN e.time_confine=4320 THEN '三天内'
			  WHEN e.time_confine=7200 THEN '其他'
			  END AS eventTimeConfine,
			  w.order_no AS orderNo,
			  uOfWorderCreateUser.real_name AS distributionUser,
			  uOfWorderCreateUser.telephone AS distributionUserTelephone,
<!-- 			  w.create_time AS distributionTime, -->
date_sub(w.create_time,interval 8 hour) AS distributionTime,
			  case when w.time_confine=60 then '一小时' when w.time_confine=480 then '八小时' when w.time_confine=1440 then '一天内'  when w.time_confine=4320 then '三天内'  when w.time_confine=7200 then '其他' end AS worderTimeConfine,
			  <if test="state==3">
			  CONCAT(
				    FLOOR(
				      TIMESTAMPDIFF(
				        SECOND,
				        e.create_time,
				        w.handle_end
				      ) / 86400
				    ),
				    '天',
				    TIMESTAMPDIFF(
				      HOUR,
				      e.create_time,
				      w.handle_end
				    ) % 24,
				    '时',
				    TIMESTAMPDIFF(
				      MINUTE,
				      e.create_time,
				      w.handle_end
				    ) % 60,
				    '分'
				  ) AS useTime,
			  </if>
			  </if>
			  <if test="state==2 or state==3">
			  uOfWorderProcessingHandleUser.real_name AS worderProcessingHandleUser,
			  uOfWorderProcessingHandleUser.telephone AS worderProcessingTelephone,
			  w.handle_begin AS worderHandleBeginTime,
			  </if>
			  <if test="state==3">
			  uOfWorderProcessedHandleUser.real_name AS worderProcessedHandleUser,
			  uOfWorderProcessedHandleUser.telephone AS worderProcessedHandleTelephone,
			  w.handle_result AS worderHandleResult,
			  case when e.event_status=3 then w.handle_end when e.event_status=4 then e.close_time end AS worderHandleEndTime,
			  </if>
			  <if test="state==4">
			  '否' AS isDispatch,
			  CASE WHEN e.close_reason_id=1 THEN '不需要处理' WHEN e.close_reason_id=2 THEN '事件已消除' WHEN e.close_reason_id=3 THEN '误会' WHEN e.close_reason_id=4 THEN '其他' END AS eventCloseReason,
			  e.close_mark AS eventCloseMark,
			  case when uOfEventCloseU.real_name is not null then uOfEventCloseU.real_name end AS closeUserName,
			  case when uOfEventCloseU.telephone is not null then uOfEventCloseU.telephone end AS closeUserTelephone,
			  </if>
			  CASE WHEN e.event_status=0 THEN 1 WHEN e.event_status=1 THEN 2 WHEN e.event_status=2 THEN 3 WHEN e.event_status=3 THEN 4 WHEN e.event_status=4 THEN 5 END AS pageState,
			  CASE WHEN e.event_status!=4 THEN 1 ELSE 2 END AS canvaType,
			  CASE WHEN e.event_status=4 THEN 2 WHEN e.event_status=0 THEN 1 WHEN e.event_status=1 THEN 2 WHEN e.event_status=2 THEN 3 WHEN e.event_status=3 THEN 4 END AS canvaProgress
			FROM
			  ${library.dynamic_dbname}.hk_event e 
			  LEFT JOIN hotcomm_community.`hk_sys_user` uOfReported
			  ON uOfReported.user_id=e.reported_user_id
			  LEFT JOIN ${library.dynamic_dbname}.hk_worder w 
			  ON w.id=e.worder_id
			  LEFT JOIN hotcomm_community.`hk_sys_user` uOfWorderCreateUser
			  ON uOfWorderCreateUser.user_id=w.create_user_id
			  LEFT JOIN hotcomm_community.`hk_sys_user` uOfWorderProcessingHandleUser
			  ON uOfWorderProcessingHandleUser.user_id=w.handle_user_id
			  LEFT JOIN hotcomm_community.`hk_sys_user` uOfWorderProcessedHandleUser
			  ON uOfWorderProcessedHandleUser.user_id=w.handle_user_id
			  LEFT JOIN hotcomm_community.`hk_sys_user` uOfEventCloseU
			  ON uOfEventCloseU.user_id=e.close_user_id
			WHERE e.`id` = #{eid} 
	</select>
	
	<!-- 后台首页报警,设备感知,人员上报,民意舆情统计 -->
	<select id="getAlarmHTCountBySource" resultType="java.util.HashMap">
		SELECT 
  		lableName,
  		CASE
    	WHEN lableName = '设备感知' 
    	THEN alarmCount
    	WHEN lableName = '人工上报' 
    	THEN eventCount 
    	ELSE 0 
  		END AS countInfo,
  		CASE
    	WHEN lableName = '设备感知' 
    	THEN CONCAT(ROUND(alarmCount / (eventCount + alarmCount)*100,0),'','%')
    	WHEN lableName = '人工上报' 
    	THEN CONCAT(ROUND(eventCount / (eventCount + alarmCount)*100,0),'','%')
    	ELSE 0
  		END AS percent 
		FROM
  		(SELECT 
    	'设备感知' AS lableName 
  		UNION
  		SELECT 
    	'人工上报' AS lableName 
  		UNION
  		SELECT 
    	'民意舆情' AS lableName) t1 
  		JOIN 
    	(SELECT COUNT(0) AS alarmCount FROM ${lib.dynamic_dbname}.hk_alarm a WHERE YEARWEEK(DATE_FORMAT(a.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())) t2 
  		JOIN 
    	(SELECT COUNT(0) AS eventCount FROM ${lib.dynamic_dbname}.hk_event e WHERE YEARWEEK(DATE_FORMAT(e.create_time,'%Y-%m-%d')) = YEARWEEK(NOW())) t3 
	</select>
	
	<!-- 报警后台首页,按报警类型统计 -->
	<select id="getAlarmHTCountByAllSource" resultType="java.util.HashMap">
			SELECT t1.sourceType,t1.allCount,
			CONCAT( ROUND( t1.allCount / (t2.alarmCount+t3.eventCount)*100,0),'','%' ) AS percent
		     FROM (SELECT 
			  sourceTypeEvent AS sourceType,
			  CASE <!-- WHEN sourceTypeEvent='交通(事件)' THEN carCountFinally  -->
			  WHEN sourceTypeEvent='户政(事件)' THEN perCountFinally WHEN sourceTypeEvent='设备(事件)' THEN devCountFinally ELSE countByTypeEvent END AS allCount
			  FROM
			  (SELECT 
			    *,
			    SUM(devCount) AS devCountFinally,
			    SUM(perCount) AS perCountFinally
			    <!-- SUM(carCount) AS carCountFinally -->
			  	FROM
			    (SELECT 
			     *,
			     CASE WHEN a.sourceTypeEvent = '设备(事件)' AND b.sourceTypeAlarm = '设备(报警)' THEN a.countByTypeEvent + b.countTypeAlarm END AS devCount,
			     CASE WHEN a.sourceTypeEvent = '户政(事件)' AND b.sourceTypeAlarm = '人员(报警)' THEN a.countByTypeEvent + b.countTypeAlarm END AS perCount
			     <!-- CASE WHEN a.sourceTypeEvent = '交通(事件)' AND b.sourceTypeAlarm = '车辆(报警)' THEN a.countByTypeEvent + b.countTypeAlarm END AS carCount --> 
			     FROM		
			     (SELECT 
			     t1.`sourceTypeEvent`,
			     CASE
			     WHEN countByTypeEvent IS NOT NULL 
			     THEN countByTypeEvent 
			     ELSE 0 
			     END AS countByTypeEvent 
			     FROM
			     (SELECT 
			      IF(a.source_type = 1,'设备(事件)',IF(a.source_type = 2,'户政(事件)',IF(a.source_type = 3,'消防',IF(a.source_type = 4,'治安',IF(a.source_type = 5,'刑事',IF(a.source_type = 6,'交通',IF(a.source_type = 7,'生产安全','其他'))))))) AS sourceTypeEvent,
			          SUM(
			            CASE
			              WHEN e.`id` != 0 
			              THEN 1 
			              ELSE 0 
			            END) AS countByTypeEvent 
			        FROM
			          (SELECT 
			            1 AS source_type 
			          UNION
			          SELECT 
			            2 AS source_type 
			          UNION
			          SELECT 
			            3 AS source_type 
			          UNION
			          SELECT 
			            4 AS source_type 
			          UNION
			          SELECT 
			            5 AS source_type 
			          UNION
			          SELECT 
			            6 AS source_type 
			          UNION
			          SELECT 
			            7 AS source_type 
			          UNION
			          SELECT 
			            8 AS source_type) a 
			          LEFT JOIN ${lib.dynamic_dbname}.hk_event e 
			            ON e.`event_type` = a.`source_type` 	        
			        WHERE YEARWEEK(DATE_FORMAT(e.create_time,'%Y-%m-%d')) = YEARWEEK(NOW())
			        GROUP BY a.`source_type`) a 
			        RIGHT JOIN 
			          (SELECT 
			            IF(a.source_type = 1,'设备(事件)',IF(a.source_type = 2,'户政(事件)',IF(a.source_type = 3,'消防',IF(a.source_type = 4,'治安',IF(a.source_type = 5,'刑事',IF(a.source_type = 6,'交通',IF(a.source_type = 7,'生产安全','其他'))))))	  	                     
			            ) AS sourceTypeEvent 
			          FROM
			            (SELECT 
			              1 AS source_type 
			            UNION
			            SELECT 
			              2 AS source_type 
			            UNION
			            SELECT 
			              3 AS source_type 
			            UNION
			            SELECT 
			              4 AS source_type 
			            UNION
			            SELECT 
			              5 AS source_type 
			            UNION
			            SELECT 
			              6 AS source_type 
			            UNION
			            SELECT 
			              7 AS source_type 
			            UNION
			            SELECT 
			              8 AS source_type) a) t1 
			          ON a.sourceTypeEvent = t1.sourceTypeEvent 
			      GROUP BY t1.`sourceTypeEvent`  
			      ) a 
			      LEFT JOIN 
			        ( 		
			        SELECT 
			          t1.`sourceTypeAlarm`,
			          CASE
			            WHEN countTypeAlarm IS NOT NULL 
			            THEN countTypeAlarm 
			            ELSE 0 
			          END AS countTypeAlarm 
			        FROM
			          (SELECT 
			            IF(
			              a.alarm_type = 1,
			              '设备(报警)',
			              IF(
			                a.alarm_type = 2,
			                '车辆(报警)',
			                '人员(报警)'
			              )
			            ) AS sourceTypeAlarm,
			            SUM(
			              CASE
			                WHEN e.`id` != 0 
			                THEN 1 
			                ELSE 0 
			              END) AS countTypeAlarm 
			          FROM
			            (SELECT 
			              1 AS alarm_type 
			            UNION
			            SELECT 
			              2 AS alarm_type 
			            UNION
			            SELECT 
			              3 AS alarm_type) a 
			            LEFT JOIN ${lib.dynamic_dbname}.hk_alarm e 
			              ON e.`alarm_type` = a.`alarm_type`
			          WHERE YEARWEEK(DATE_FORMAT(e.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())
			          GROUP BY a.`alarm_type`) a 
			          RIGHT JOIN 
			            (SELECT 
			              IF(
			                a.alarm_type = 1,
			                '设备(报警)',
			                IF(
			                  a.alarm_type = 2,
			                  '车辆(报警)',
			                  '人员(报警)'
			                )
			              ) AS sourceTypeAlarm 
			            FROM
			              (SELECT 
			                1 AS alarm_type 
			              UNION
			              SELECT 
			                2 AS alarm_type 
			              UNION
			              SELECT 
			                3 AS alarm_type) a) t1 
			            ON a.sourceTypeAlarm = t1.sourceTypeAlarm 
			        GROUP BY t1.`sourceTypeAlarm`  
			        ) b 
			        ON 1 = 1) test 
			  	GROUP BY sourceTypeEvent 
			  	ORDER BY sourceTypeEvent) test ) t1 
		LEFT JOIN 
		  (SELECT 
		    COUNT(1) AS alarmCount FROM ${lib.dynamic_dbname}.hk_alarm a WHERE YEARWEEK(DATE_FORMAT(a.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())) t2 
		  ON 1 = 1 
		LEFT JOIN 
		  (SELECT 
		    COUNT(1) AS eventCount FROM ${lib.dynamic_dbname}.hk_event e WHERE YEARWEEK(DATE_FORMAT(e.create_time,'%Y-%m-%d')) = YEARWEEK(NOW())) t3 
		  ON 1 = 1 
	</select>
	
	<!-- 报警后台首页,本周发生事件数量/件 -->
	<select id="getAlarmHTCountByWeek" resultType="java.util.HashMap">
<!-- 	SELECT
		test1.x,
		test1.testCount + test2.testCount AS countAlarm
		FROM
		(SELECT X,testCount FROM
		(SELECT *,SUM(countInfo1+countInfo2+countInfo3+countInfo4+countInfo5+countInfo6+countInfo7) AS testCount FROM 
		(SELECT 
		a.x,
		CASE WHEN a.x='周日' AND b.dayInfo>=d.fristDate AND b.dayInfo &lt;= e.lastDate-6  THEN b.devCount ELSE 0 END AS countInfo7,
		CASE WHEN a.x='周一' AND b.dayInfo>=d.fristDate+1 AND b.dayInfo &lt;= e.lastDate-5 THEN b.devCount ELSE 0 END AS countInfo1,
		CASE WHEN a.x='周二' AND b.dayInfo>=d.fristDate+2 AND b.dayInfo &lt;= e.lastDate-4 THEN b.devCount ELSE 0 END AS countInfo2,
		CASE WHEN a.x='周三' AND b.dayInfo>=d.fristDate+3 AND b.dayInfo &lt;= e.lastDate-3 THEN b.devCount ELSE 0 END AS countInfo3,
		CASE WHEN a.x='周四' AND b.dayInfo>=d.fristDate+4 AND b.dayInfo &lt;= e.lastDate-2 THEN b.devCount ELSE 0 END AS countInfo4,
		CASE WHEN a.x='周五' AND b.dayInfo>=d.fristDate+5 AND b.dayInfo &lt;= e.lastDate-1 THEN b.devCount ELSE 0 END AS countInfo5,
		CASE WHEN a.x='周六' AND b.dayInfo>=d.fristDate+6 AND b.dayInfo &lt;= e.lastDate  THEN b.devCount ELSE 0 END AS countInfo6
		FROM
		(
		SELECT 
		  timeInfo.`周日` AS X
		FROM
		  (
		  SELECT '周日'
		  UNION
		  SELECT '周一' UNION SELECT '周二' UNION SELECT '周三' 
		  UNION
		  SELECT '周四' UNION SELECT '周五' UNION SELECT '周六'  
		) timeInfo 
		 ) a
		LEFT JOIN (SELECT DATE_FORMAT(create_time, '%d') dayInfo,COUNT(a.id) AS devCount FROM ${lib.dynamic_dbname}.`hk_alarm` a WHERE YEARWEEK(DATE_FORMAT(a.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW()) GROUP BY dayInfo ORDER BY dayInfo ASC) b ON 1=1
		LEFT JOIN (SELECT DATE_FORMAT(DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) +1 DAY), '%d') AS fristDate FROM ${lib.dynamic_dbname}.hk_alarm a GROUP BY fristDate) d ON 1=1
		LEFT JOIN (SELECT DATE_FORMAT(DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) - 5 DAY), '%d') AS lastDate FROM ${lib.dynamic_dbname}.hk_alarm a GROUP BY lastDate) e ON 1=1
		) te
		GROUP BY X
		) test)test1
		LEFT JOIN
		(SELECT X,testCount FROM
		(SELECT *,SUM(countInfo1+countInfo2+countInfo3+countInfo4+countInfo5+countInfo6+countInfo7) AS testCount FROM 
		(SELECT 
		a.x,
		CASE WHEN a.x='周日' AND b.dayInfo>=d.fristDate AND b.dayInfo&lt;=e.lastDate-6  THEN b.devCount ELSE 0 END AS countInfo7,
		CASE WHEN a.x='周一' AND b.dayInfo>=d.fristDate+1 AND b.dayInfo&lt;=e.lastDate-5 THEN b.devCount ELSE 0 END AS countInfo1,
		CASE WHEN a.x='周二' AND b.dayInfo>=d.fristDate+2 AND b.dayInfo&lt;=e.lastDate-4 THEN b.devCount ELSE 0 END AS countInfo2,
		CASE WHEN a.x='周三' AND b.dayInfo>=d.fristDate+3 AND b.dayInfo&lt;=e.lastDate-3 THEN b.devCount ELSE 0 END AS countInfo3,
		CASE WHEN a.x='周四' AND b.dayInfo>=d.fristDate+4 AND b.dayInfo&lt;=e.lastDate-2 THEN b.devCount ELSE 0 END AS countInfo4,
		CASE WHEN a.x='周五' AND b.dayInfo>=d.fristDate+5 AND b.dayInfo&lt;=e.lastDate-1 THEN b.devCount ELSE 0 END AS countInfo5,
		CASE WHEN a.x='周六' AND b.dayInfo>=d.fristDate+6 AND b.dayInfo&lt;=e.lastDate  THEN b.devCount ELSE 0 END AS countInfo6
		FROM
		(
		SELECT 
		  timeInfo.`周日` AS X
		FROM
		  (
		  SELECT '周日'
		  UNION
		  SELECT '周一' UNION SELECT '周二' UNION SELECT '周三' 
		  UNION
		  SELECT '周四' UNION SELECT '周五' UNION SELECT '周六'  
		) timeInfo 
		 ) a
		LEFT JOIN (SELECT DATE_FORMAT(create_time, '%d') dayInfo,COUNT(e.id) AS devCount FROM ${lib.dynamic_dbname}.`hk_event` e WHERE YEARWEEK(DATE_FORMAT(e.create_time,'%Y-%m-%d')) = YEARWEEK(NOW()) GROUP BY dayInfo ORDER BY dayInfo ASC) b ON 1=1
		LEFT JOIN (SELECT DATE_FORMAT(DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) +1 DAY), '%d') AS fristDate FROM ${lib.dynamic_dbname}.hk_event e GROUP BY fristDate) d ON 1=1
		LEFT JOIN (SELECT DATE_FORMAT(DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) - 5 DAY), '%d') AS lastDate FROM ${lib.dynamic_dbname}.hk_event e GROUP BY lastDate) e ON 1=1
		) test
		GROUP BY X
		) test)test2 ON test1.x = test2.x
		GROUP BY test1.x 
 -->
 		SELECT
		test1.x,
		test1.testCount + test2.testCount AS countAlarm
		FROM
		(SELECT X,testCount FROM
		(SELECT *,SUM(countInfo1+countInfo2+countInfo3+countInfo4+countInfo5+countInfo6+countInfo7) AS testCount FROM 
		(SELECT 
		a.x,
		CASE WHEN a.x='周日' AND b.dayInfo>=DATE_FORMAT(d.fristDate,'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '6' DAY),'%d')  THEN b.devCount ELSE 0 END AS countInfo7,
		CASE WHEN a.x='周一' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 1 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '5' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo1,
		CASE WHEN a.x='周二' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 2 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '4' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo2,
		CASE WHEN a.x='周三' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 3 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '3' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo3,
		CASE WHEN a.x='周四' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 4 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '2' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo4,
		CASE WHEN a.x='周五' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 5 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '1' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo5,
		CASE WHEN a.x='周六' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 6 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(e.lastDate,'%d')  THEN b.devCount ELSE 0 END AS countInfo6
		FROM
		(
		SELECT 
		  timeInfo.`周日` AS X
		FROM
		  (
		  SELECT '周日'
		  UNION
		  SELECT '周一' UNION SELECT '周二' UNION SELECT '周三' 
		  UNION
		  SELECT '周四' UNION SELECT '周五' UNION SELECT '周六'  
		) timeInfo 
		 ) a
		LEFT JOIN (SELECT DATE_FORMAT(create_time, '%d') dayInfo,COUNT(a.id) AS devCount FROM ${lib.dynamic_dbname}.`hk_alarm` a WHERE YEARWEEK(DATE_FORMAT(a.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW()) GROUP BY dayInfo ORDER BY dayInfo ASC) b ON 1=1
		LEFT JOIN (SELECT DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) +1 DAY) AS fristDate FROM ${lib.dynamic_dbname}.hk_alarm a GROUP BY fristDate) d ON 1=1
		LEFT JOIN (SELECT DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) - 5 DAY) AS lastDate FROM ${lib.dynamic_dbname}.hk_alarm a GROUP BY lastDate) e ON 1=1
		) te
		GROUP BY X
		) test)test1
		LEFT JOIN
		(SELECT X,testCount FROM
		(SELECT *,SUM(countInfo1+countInfo2+countInfo3+countInfo4+countInfo5+countInfo6+countInfo7) AS testCount FROM 
		(SELECT 
		a.x,
		CASE WHEN a.x='周日' AND b.dayInfo>=DATE_FORMAT(d.fristDate,'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '6' DAY),'%d')  THEN b.devCount ELSE 0 END AS countInfo7,
		CASE WHEN a.x='周一' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 1 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '5' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo1,
		CASE WHEN a.x='周二' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 2 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '4' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo2,
		CASE WHEN a.x='周三' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 3 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '3' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo3,
		CASE WHEN a.x='周四' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 4 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '2' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo4,
		CASE WHEN a.x='周五' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 5 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '1' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo5,
		CASE WHEN a.x='周六' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 6 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(e.lastDate,'%d')  THEN b.devCount ELSE 0 END AS countInfo6
		FROM
		(
		SELECT 
		  timeInfo.`周日` AS X
		FROM
		  (
		  SELECT '周日'
		  UNION
		  SELECT '周一' UNION SELECT '周二' UNION SELECT '周三' 
		  UNION
		  SELECT '周四' UNION SELECT '周五' UNION SELECT '周六'  
		) timeInfo 
		 ) a
		LEFT JOIN (SELECT t1.* FROM (SELECT DATE_FORMAT(create_time, '%d') dayInfo,COUNT(e.id) AS devCount FROM ${lib.dynamic_dbname}.`hk_event` e WHERE YEARWEEK(DATE_FORMAT(e.create_time,'%Y-%m-%d')) = YEARWEEK(NOW()) GROUP BY dayInfo ORDER BY dayInfo ASC) t1 RIGHT JOIN (SELECT 1) t2 ON 1=1) b ON 1=1
		LEFT JOIN (SELECT DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) +1 DAY) AS fristDate FROM ${lib.dynamic_dbname}.hk_event e GROUP BY fristDate) d ON 1=1
		LEFT JOIN (SELECT DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) - 5 DAY) AS lastDate FROM ${lib.dynamic_dbname}.hk_event e GROUP BY lastDate) e ON 1=1
		) test
		GROUP BY X
		) test)test2 ON test1.x = test2.x
		GROUP BY test1.x
	</select>
	
	<!-- 态势分析 ,报警趋势分析-->
	<select id="getSTAlarmCountByTrend" resultType="com.hotcomm.community.common.bean.ui.process.alarm.AlarmTrendUM">
		SELECT a.dateInfo,IFNULL(b.devCount,'0') AS devCount,IFNULL(d.perCount,'0') AS perCount,IFNULL(e.opiCount,'0') AS opiCount
		FROM
		<if test="queryType==1">
		(SELECT DATE_SUB(CURDATE(), INTERVAL @i := @i + 1 DAY) AS dateInfo
		  FROM 
		 (SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1)  tmp 
		  LEFT JOIN
		 (SELECT @i := - 1) t ON 1=1 ) a
		 LEFT JOIN (SELECT COUNT(a.`id`) AS devCount,DATE_FORMAT(a.`create_time`,'%Y-%m-%d') AS devTime FROM ${lib.dynamic_dbname}.hk_alarm a WHERE  DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 30 DAY) GROUP BY devTime) b ON b.devTime = a.dateInfo
		 LEFT JOIN (SELECT COUNT(e.`id`) AS perCount,DATE_FORMAT(e.create_time,'%Y-%m-%d') AS devTime FROM ${lib.dynamic_dbname}.hk_event e WHERE DATE(e.create_time)>=DATE_SUB(CURDATE(), INTERVAL 30 DAY) GROUP BY devTime) d ON d.devTime = a.dateInfo
		 LEFT JOIN (SELECT COUNT(e.`id`) AS opiCount,DATE_FORMAT(e.create_time,'%Y-%m-%d') AS devTime FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`event_type` = 2 AND DATE(e.create_time)>=DATE_SUB(CURDATE(), INTERVAL 30 DAY) GROUP BY devTime) e ON e.devTime = a.dateInfo
		 </if>
		 <if test="queryType==2">
		 (SELECT DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL @i:= @i + 1 MONTH),'%Y-%m') AS dateInfo
		 FROM 
		 (SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 )  tmp 
		  LEFT JOIN
		 (SELECT @i:= -1) t ON 1=1 ) a
		 LEFT JOIN (SELECT COUNT(a.`id`) AS devCount,DATE_FORMAT(a.`create_time`,'%Y-%m') AS devTime FROM ${lib.dynamic_dbname}.hk_alarm a WHERE DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 1 YEAR) GROUP BY devTime) b ON b.devTime = a.dateInfo
		 LEFT JOIN (SELECT COUNT(e.`id`) AS perCount,DATE_FORMAT(e.create_time,'%Y-%m') AS perTime FROM ${lib.dynamic_dbname}.hk_event e WHERE  DATE(e.create_time)>=DATE_SUB(CURDATE(), INTERVAL 1 YEAR) GROUP BY perTime) d ON d.perTime = a.dateInfo
		 LEFT JOIN (SELECT COUNT(e.`id`) AS opiCount,DATE_FORMAT(e.create_time,'%Y-%m') AS devTime FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`event_type` = 2 AND DATE(e.create_time)>=DATE_SUB(CURDATE(), INTERVAL 1 YEAR) GROUP BY devTime) e ON e.devTime = a.dateInfo 
		 </if>
		 <if test="queryType==3">
		 (SELECT DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL @i:= @i + 1 MONTH),'%Y-%m') AS dateInfo
		 FROM 
		 (SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 )  tmp 
		  LEFT JOIN
		 (SELECT @i:= -1) t ON 1=1 ) a
		 LEFT JOIN (SELECT COUNT(a.`id`) AS devCount,DATE_FORMAT(a.`create_time`,'%Y-%m') AS devTime FROM ${lib.dynamic_dbname}.hk_alarm a WHERE DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 3 YEAR) GROUP BY devTime) b ON b.devTime = a.dateInfo
		 LEFT JOIN (SELECT COUNT(e.`id`) AS perCount,DATE_FORMAT(e.create_time,'%Y-%m') AS perTime FROM ${lib.dynamic_dbname}.hk_event e WHERE DATE(e.create_time)>=DATE_SUB(CURDATE(), INTERVAL 3 YEAR) GROUP BY perTime) d ON d.perTime = a.dateInfo
		 LEFT JOIN (SELECT COUNT(e.`id`) AS opiCount,DATE_FORMAT(e.create_time,'%Y-%m') AS devTime FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`event_type` = 2 AND DATE(e.create_time)>=DATE_SUB(CURDATE(), INTERVAL 3 YEAR) GROUP BY devTime) e ON e.devTime = a.dateInfo 		 
		 </if>
		 ORDER BY a.dateInfo
	</select>
	
	<!-- 态势分析,报警时段分析 -->
	<select id="getSTAlarmCountByHour" resultType="java.util.HashMap">
		SELECT
		test1.x,
		test1.testCount + test2.testCount AS countAlarm
		FROM
		(SELECT X,testCount FROM
		(SELECT *,SUM(countInfo1+countInfo2+countInfo3+countInfo4+countInfo5+countInfo6+countInfo7+countInfo8+countInfo9+countInfo10+countInfo11+countInfo12) AS testCount FROM 
		(SELECT 
		a.x,
		CASE WHEN a.x='0-2' AND b.hours>=0 AND b.hours&lt;2 THEN b.devCount ELSE 0 END AS countInfo1,
		CASE WHEN a.x='2-4' AND b.hours>=2 AND b.hours&lt;4 THEN b.devCount ELSE 0 END AS countInfo2,
		CASE WHEN a.x='4-6' AND b.hours>=4 AND b.hours&lt;6 THEN b.devCount ELSE 0 END AS countInfo3,
		CASE WHEN a.x='6-8' AND b.hours>=6 AND b.hours&lt;8 THEN b.devCount ELSE 0 END AS countInfo4,
		CASE WHEN a.x='8-10' AND b.hours>=8 AND b.hours&lt;10 THEN b.devCount ELSE 0 END AS countInfo5
		,CASE WHEN a.x='10-12' AND b.hours>=10 AND b.hours&lt;12 THEN b.devCount ELSE 0 END AS countInfo6,
		CASE WHEN a.x='12-14' AND b.hours>=12 AND b.hours&lt;14 THEN b.devCount ELSE 0 END AS countInfo7,
		CASE WHEN a.x='14-16' AND b.hours>=14 AND b.hours&lt;16 THEN b.devCount ELSE 0 END AS countInfo8,
		CASE WHEN a.x='16-18' AND b.hours>=16 AND b.hours&lt;18 THEN b.devCount ELSE 0 END AS countInfo9,
		CASE WHEN a.x='18-20' AND b.hours>=18 AND b.hours&lt;20 THEN b.devCount ELSE 0 END AS countInfo10,
		CASE WHEN a.x='20-22' AND b.hours>=20 AND b.hours&lt;22 THEN b.devCount ELSE 0 END AS countInfo11,
		CASE WHEN a.x='22-24' AND b.hours>=22 AND b.hours&lt;24 THEN b.devCount ELSE 0 END AS countInfo12
		FROM
		(
		SELECT 
		  timeInfo.`0-2` AS X
		FROM
		  (SELECT '0-2' UNION SELECT '2-4' UNION SELECT '4-6' 
		  UNION
		  SELECT '6-8' UNION SELECT '8-10' UNION SELECT '10-12' 
		  UNION
		  SELECT '12-14' UNION SELECT '14-16' UNION SELECT '16-18' 
		  UNION
		  SELECT '18-20' UNION SELECT '20-22' UNION SELECT  '22-24') timeInfo 
		 ) a
		 LEFT JOIN 
		 (SELECT DATE_FORMAT(create_time, '%H') hours,COUNT(a.id) AS devCount FROM ${lib.dynamic_dbname}.`hk_alarm` a 
		<!-- 1最近30天 2最近一年 3最近三年 -->
		<if test="queryType==1">
		    WHERE DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(create_time)
		</if> 
		<if test="queryType==2">
		    WHERE DATE_SUB(CURDATE(), INTERVAL 1 YEAR)  &lt;= DATE(create_time)
		</if>
		<if test="queryType==3">
		    WHERE DATE_SUB(CURDATE(), INTERVAL 3 YEAR)  &lt;= DATE(create_time)
		</if>
		GROUP BY hours
		ORDER BY hours ASC) b
		ON 1=1
		) test
		GROUP BY X
		) test
		)test1
		LEFT JOIN 
		(
		SELECT X,testCount FROM
		(SELECT *,SUM(countInfo1+countInfo2+countInfo3+countInfo4+countInfo5+countInfo6+countInfo7+countInfo8+countInfo9+countInfo10+countInfo11+countInfo12) AS testCount FROM 
		(SELECT 
		a.x,
		CASE WHEN a.x='0-2' AND b.hours>=0 AND b.hours&lt;2 THEN b.eventCount ELSE 0 END AS countInfo1,
		CASE WHEN a.x='2-4' AND b.hours>=2 AND b.hours&lt;4 THEN b.eventCount ELSE 0 END AS countInfo2,
		CASE WHEN a.x='4-6' AND b.hours>=4 AND b.hours&lt;6 THEN b.eventCount ELSE 0 END AS countInfo3,
		CASE WHEN a.x='6-8' AND b.hours>=6 AND b.hours&lt;8 THEN b.eventCount ELSE 0 END AS countInfo4,
		CASE WHEN a.x='8-10' AND b.hours>=8 AND b.hours&lt;10 THEN b.eventCount ELSE 0 END AS countInfo5,
		CASE WHEN a.x='10-12' AND b.hours>=10 AND b.hours&lt;12 THEN b.eventCount ELSE 0 END AS countInfo6,
		CASE WHEN a.x='12-14' AND b.hours>=12 AND b.hours&lt;14 THEN b.eventCount ELSE 0 END AS countInfo7,
		CASE WHEN a.x='14-16' AND b.hours>=14 AND b.hours&lt;16 THEN b.eventCount ELSE 0 END AS countInfo8,
		CASE WHEN a.x='16-18' AND b.hours>=16 AND b.hours&lt;18 THEN b.eventCount ELSE 0 END AS countInfo9,
		CASE WHEN a.x='18-20' AND b.hours>=18 AND b.hours&lt;20 THEN b.eventCount ELSE 0 END AS countInfo10,
		CASE WHEN a.x='20-22' AND b.hours>=20 AND b.hours&lt;22 THEN b.eventCount ELSE 0 END AS countInfo11,
		CASE WHEN a.x='22-24' AND b.hours>=22 AND b.hours&lt;24 THEN b.eventCount ELSE 0 END AS countInfo12
		FROM
		(
		SELECT 
		  timeInfo.`0-2` AS X
		FROM
		  (SELECT '0-2' UNION SELECT '2-4' UNION SELECT '4-6' 
		  UNION
		  SELECT '6-8' UNION SELECT '8-10' UNION SELECT '10-12' 
		  UNION
		  SELECT '12-14' UNION SELECT '14-16' UNION SELECT '16-18' 
		  UNION
		  SELECT '18-20' UNION SELECT '20-22' UNION SELECT  '22-24') timeInfo 
		 ) a
		 LEFT JOIN 
		 (SELECT DATE_FORMAT(create_time, '%H') hours,COUNT(e.id) AS eventCount FROM ${lib.dynamic_dbname}.`hk_event` e 
			<!-- 1最近30天 2最近一年 3最近三年 -->
		         <if test="queryType==1">
		             WHERE DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(create_time)
		         </if> 
		         <if test="queryType==2">
		             WHERE DATE_SUB(CURDATE(), INTERVAL 1 YEAR)  &lt;= DATE(create_time)
		         </if>
		         <if test="queryType==3">
		             WHERE DATE_SUB(CURDATE(), INTERVAL 3 YEAR)  &lt;= DATE(create_time)
		         </if>
		GROUP BY hours
		ORDER BY hours ASC) b
		ON 1=1
		) test
		GROUP BY X
		) test
		) test2 ON test1.x = test2.x
		GROUP BY test1.x
	</select>
	
	<!-- 态势分析,报警时段分析饼图 -->
	<select id="getSTAlarmCountByPie" resultType="java.util.HashMap">
		SELECT
		test1.x,
		test1.testCount + test2.testCount AS countAlarm
		FROM
		(SELECT X,testCount FROM
		(SELECT *,SUM(countInfo1+countInfo2+countInfo3) AS testCount FROM 
		(SELECT 
		a.x,
		CASE WHEN a.x='0-6' AND b.hours>=0 AND b.hours&lt;6 THEN b.devCount ELSE 0 END AS countInfo1,
		CASE WHEN a.x='6-20' AND b.hours>=6 AND b.hours&lt;20 THEN b.devCount ELSE 0 END AS countInfo2,
		CASE WHEN a.x='20-0' AND b.hours>=20 AND b.hours&lt;0 THEN b.devCount ELSE 0 END AS countInfo3
		FROM
		(
		SELECT 
		  timeInfo.`0-6` AS X
		FROM
		  (SELECT '0-6'
		  UNION
		  SELECT '6-20' 
		  UNION
		  SELECT '20-0' ) timeInfo 
		 ) a
		 LEFT JOIN 
		 (SELECT DATE_FORMAT(create_time, '%H') hours,COUNT(a.id) AS devCount FROM ${lib.dynamic_dbname}.`hk_alarm` a 
		 <!-- 1最近30天 2最近一年 3最近三年 -->
		<if test="queryType==1">
		    WHERE DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(create_time)
		</if> 
		<if test="queryType==2">
		    WHERE DATE_SUB(CURDATE(), INTERVAL 1 YEAR)  &lt;= DATE(create_time)
		</if>
		<if test="queryType==3">
		    WHERE DATE_SUB(CURDATE(), INTERVAL 3 YEAR)  &lt;= DATE(create_time)
		</if>
		GROUP BY hours
		ORDER BY hours ASC) b
		ON 1=1
		) test
		GROUP BY X
		) test
		)test1
		LEFT JOIN 
		(
		SELECT X,testCount FROM
		(SELECT *,SUM(countInfo1+countInfo2+countInfo3) AS testCount FROM 
		(SELECT 
		a.x,
		CASE WHEN a.x='0-6' AND b.hours>=0 AND b.hours&lt;6 THEN b.eventCount ELSE 0 END AS countInfo1,
		CASE WHEN a.x='6-20' AND b.hours>=6 AND b.hours&lt;20 THEN b.eventCount ELSE 0 END AS countInfo2,
		CASE WHEN a.x='20-0' AND b.hours>=20 AND b.hours&lt;0 THEN b.eventCount ELSE 0 END AS countInfo3
		FROM
		(
		SELECT 
		  timeInfo.`0-6` AS X
		FROM
		  (SELECT '0-6'
		  UNION
		  SELECT '6-20'
		  UNION
		  SELECT '20-0'
		 ) timeInfo 
		 ) a
		 LEFT JOIN 
		 (SELECT DATE_FORMAT(create_time, '%H') hours,COUNT(e.id) AS eventCount FROM ${lib.dynamic_dbname}.`hk_event` e 
			<!-- 1最近30天 2最近一年 3最近三年 -->
		         <if test="queryType==1">
		             WHERE DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(create_time)
		         </if> 
		         <if test="queryType==2">
		             WHERE DATE_SUB(CURDATE(), INTERVAL 1 YEAR)  &lt;= DATE(create_time)
		         </if>
		         <if test="queryType==3">
		             WHERE DATE_SUB(CURDATE(), INTERVAL 3 YEAR)  &lt;= DATE(create_time)
		         </if>
		GROUP BY hours
		ORDER BY hours ASC) b
		ON 1=1
		) test
		GROUP BY X
		) test
		) test2 ON test1.x = test2.x
		GROUP BY test1.x
	</select>
	
	<!-- 态势分析,报警类型分布 -->
	<select id="getSTAlarmCountBySourceType" resultType="java.util.HashMap">
		  SELECT 
		  sourceTypeEvent AS sourceType,
		  CASE <!-- WHEN sourceTypeEvent='交通(事件)' THEN carCountFinally  -->
		  WHEN sourceTypeEvent='户政(事件)' THEN perCountFinally WHEN sourceTypeEvent='设备(事件)' THEN devCountFinally ELSE countByTypeEvent END AS allCount
		FROM
		  (SELECT 
		    *,
		    SUM(devCount) AS devCountFinally,
		    SUM(perCount) AS perCountFinally
		    <!-- SUM(carCount) AS carCountFinally -->
		  FROM
		    (SELECT 
		      *,
		      CASE
		        WHEN a.sourceTypeEvent = '设备(事件)' 
		        AND b.sourceTypeAlarm = '设备(报警)' 
		        THEN a.countByTypeEvent + b.countTypeAlarm 
		      END AS devCount,
		      CASE
		        WHEN a.sourceTypeEvent = '户政(事件)' 
		        AND b.sourceTypeAlarm = '人员(报警)' 
		        THEN a.countByTypeEvent + b.countTypeAlarm 
		      END AS perCount
		      <!-- CASE
		        WHEN a.sourceTypeEvent = '交通(事件)' 
		        AND b.sourceTypeAlarm = '车辆(报警)' 
		        THEN a.countByTypeEvent + b.countTypeAlarm 
		      END AS carCount  -->
		    FROM
		      (	
		      SELECT 
		        t1.`sourceTypeEvent`,
		        CASE
		          WHEN countByTypeEvent IS NOT NULL 
		          THEN countByTypeEvent 
		          ELSE 0 
		        END AS countByTypeEvent 
		      FROM
		        (SELECT 
		          IF(a.source_type = 1,'设备(事件)',IF(a.source_type = 2,'户政(事件)',IF(a.source_type = 3,'消防',IF(a.source_type = 4,'治安',IF(a.source_type = 5,'刑事',IF(a.source_type = 6,'交通',IF(a.source_type = 7,'生产安全','其他'))))))) AS sourceTypeEvent,
		          SUM(
		            CASE
		              WHEN e.`id` != 0 
		              THEN 1 
		              ELSE 0 
		            END) AS countByTypeEvent 
		        FROM
		          (SELECT 
		            1 AS source_type 
		          UNION
		          SELECT 
		            2 AS source_type 
		          UNION
		          SELECT 
		            3 AS source_type 
		          UNION
		          SELECT 
		            4 AS source_type 
		          UNION
		          SELECT 
		            5 AS source_type 
		          UNION
		          SELECT 
		            6 AS source_type 
		          UNION
		          SELECT 
		            7 AS source_type 
		          UNION
		          SELECT 
		            8 AS source_type) a 
		          LEFT JOIN ${lib.dynamic_dbname}.hk_event e 
		            ON e.`event_type` = a.`source_type` 
			<!-- 1最近30天 2最近一年 3最近三年 -->
		         <if test="queryType==1">
		             WHERE DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(create_time)
		         </if> 
		         <if test="queryType==2">
		             WHERE DATE_SUB(CURDATE(), INTERVAL 1 YEAR)  &lt;= DATE(create_time)
		         </if>
		         <if test="queryType==3">
		             WHERE DATE_SUB(CURDATE(), INTERVAL 3 YEAR)  &lt;= DATE(create_time)
		         </if>
		        GROUP BY a.`source_type`) a 
		        RIGHT JOIN 
		          (SELECT 
		            IF(a.source_type = 1,'设备(事件)',IF(a.source_type = 2,'户政(事件)',IF(a.source_type = 3,'消防',IF(a.source_type = 4,'治安',IF(a.source_type = 5,'刑事',IF(a.source_type = 6,'交通',IF(a.source_type = 7,'生产安全','其他'))))))) AS sourceTypeEvent 
		          FROM
		            (SELECT 
		              1 AS source_type 
		            UNION
		            SELECT 
		              2 AS source_type 
		            UNION
		            SELECT 
		              3 AS source_type 
		            UNION
		            SELECT 
		              4 AS source_type 
		            UNION
		            SELECT 
		              5 AS source_type 
		            UNION
		            SELECT 
		              6 AS source_type 
		            UNION
		            SELECT 
		              7 AS source_type 
		            UNION
		            SELECT 
		              8 AS source_type) a) t1 
		          ON a.sourceTypeEvent = t1.sourceTypeEvent 
		      GROUP BY t1.`sourceTypeEvent`  
		      ) a 
		      LEFT JOIN 
		        ( 		
		        SELECT 
		          t1.`sourceTypeAlarm`,
		          CASE
		            WHEN countTypeAlarm IS NOT NULL 
		            THEN countTypeAlarm 
		            ELSE 0 
		          END AS countTypeAlarm 
		        FROM
		          (SELECT 
		            IF(a.alarm_type = 1,'设备(报警)',IF(a.alarm_type = 2,'车辆(报警)','人员(报警)')) AS sourceTypeAlarm,
		            SUM(
		              CASE
		                WHEN e.`id` != 0 
		                THEN 1 
		                ELSE 0 
		              END) AS countTypeAlarm 
		          FROM
		            (SELECT 
		              1 AS alarm_type 
		            UNION
		            SELECT 
		              2 AS alarm_type 
		            UNION
		            SELECT 
		              3 AS alarm_type) a 
		            LEFT JOIN ${lib.dynamic_dbname}.hk_alarm e 
		              ON e.`alarm_type` = a.`alarm_type`
					  <!-- 1最近30天 2最近一年 3最近三年 -->
		              <if test="queryType==1">
		              	WHERE DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(create_time)
		              </if> 
		              <if test="queryType==2">
		                WHERE DATE_SUB(CURDATE(), INTERVAL 1 YEAR)  &lt;= DATE(create_time)
		              </if>
		              <if test="queryType==3">
		              	WHERE DATE_SUB(CURDATE(), INTERVAL 3 YEAR)  &lt;= DATE(create_time)
		              </if>
		          GROUP BY a.`alarm_type`) a 
		          RIGHT JOIN 
		            (SELECT 
		              IF(a.alarm_type = 1,'设备(报警)',IF(a.alarm_type = 2,'车辆(报警)','人员(报警)')) AS sourceTypeAlarm 
		            FROM
		              (SELECT 
		                1 AS alarm_type 
		              UNION
		              SELECT 
		                2 AS alarm_type 
		              UNION
		              SELECT 
		                3 AS alarm_type) a) t1 
		            ON a.sourceTypeAlarm = t1.sourceTypeAlarm 
		        GROUP BY t1.`sourceTypeAlarm`  	
		        ) b 
		        ON 1 = 1) test 
		  GROUP BY sourceTypeEvent 
		  ORDER BY sourceTypeEvent) test 
	</select>
	
	<!-- 态势分析,报警类型分布(单独查出车辆统计) -->
	<select id="getSTAlarmCountBySourceTypeCar" resultType="java.util.HashMap">
		SELECT 
		test.sourceTYpe,
		a.allCount
		FROM
		(SELECT COUNT(1) AS allCount FROM ${lib.dynamic_dbname}.hk_alarm a
		<!-- 1最近30天 2最近一年 3最近三年 --> 
		<if test="queryType==1">
		WHERE a.alarm_type=2 AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(a.create_time)
		</if> 
		<if test="queryType==2">
		WHERE a.alarm_type=2 AND DATE_SUB(CURDATE(), INTERVAL 1 YEAR)  &lt;= DATE(a.create_time)
		</if>
		<if test="queryType==3">
		WHERE a.alarm_type=2 AND DATE_SUB(CURDATE(), INTERVAL 3 YEAR)  &lt;= DATE(a.create_time)
		</if>
		) a
		LEFT JOIN
		(SELECT
		CASE WHEN test.alarm_type = 1 THEN '车辆' END AS sourceType
 		FROM
 		(SELECT 1 AS alarm_type) test) test ON 1=1
	</select>
	
	<!-- 态势分析,未处理报警总数 -->
	<select id="getSTAlarmCountNotDealCount" resultType="java.util.HashMap">
		SELECT
		SUM(a) AS alarmCount
		FROM 
		(SELECT 
		COUNT(a.`handel_state`) AS a
		FROM ${lib.dynamic_dbname}.hk_alarm a
		WHERE a.`handel_state` = 0
		UNION ALL 
		SELECT
		COUNT(e.`event_status`) AS a
		FROM ${lib.dynamic_dbname}.hk_event e
		WHERE e.`event_status` = 0
		) c 
	</select>
	
	<!-- 态势分析,未处理报警列表 -->
	<select id="getSTAlarmCountNotDealCountList" resultType="com.hotcomm.community.common.bean.ui.process.alarm.AlarmNotDealListUM">
		SELECT 
		 * 
		FROM
		(SELECT 
		 a.`alarm_message` AS Title,
		 a.`create_time` AS reportTime,
		 a.`alarm_address` AS Address,
		 CONCAT(au.real_name, ' ', au.telephone) AS handleUser 
		 FROM (SELECT 1=1) t
		 LEFT JOIN ${lib.dynamic_dbname}.hk_alarm a ON 1=1 
		 LEFT JOIN hotcomm_community.`hk_sys_user` au ON a.`handle_user_id` = au.`user_id` 
		 WHERE a.`handel_state` = 0) t1 
		UNION 
		SELECT 
		e.`event_title` AS Title,
		e.create_time AS reportTime,
		e.`event_address` AS Address,
		CONCAT(eu.real_name, ' ', eu.telephone) AS handleUser 
		FROM (SELECT 1=1) t1
		LEFT JOIN ${lib.dynamic_dbname}.hk_event e ON 1=1
		LEFT JOIN hotcomm_community.`hk_sys_user` eu 
		ON e.`handle_user_id` = eu.`user_id` 
		WHERE e.`event_status` = 0
		ORDER BY reportTime DESC
	</select>
	
	<!-- 态势分析,获取累计处理报警总数 -->
	<select id="getSTAlarmCountProcess" resultType="java.util.HashMap">
		SELECT 
		IFNULL(t1.dealCount,'0') AS dealCount,
		IFNULL(t1.dealWith,'0') AS dealWith,
		IFNULL(t1.laterDeal,'0') AS laterDeal,
		IFNULL(t1.precent,'0') AS precent 
		FROM 
		(
		(SELECT
		e.eventCount+a.alarmCount AS dealCount,
		IFNULL(e.deal+a.deal,'0') AS dealWith,
		IFNULL(e.laterDeal+a.laterDeal,'0') AS laterDeal,
		IFNULL(CONCAT(ROUND(((e.deal+a.deal) / (e.allEventCount+a.allAlarmCount))*100,0),'','%'),'0') AS precent
		FROM
		(SELECT 
		<!-- 1最近30天 2最近一年 3最近三年 -->
		<if test="queryType==1">
		(SELECT COUNT(e.`id`) FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`worder_id` IS NOT NULL AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(e.create_time)) AS allEventCount,
		(SELECT COUNT(e.`event_status`) FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`worder_id` IS NOT NULL AND e.`event_status` = 3  AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(create_time)) AS eventCount,
		(SELECT SUM(CASE WHEN w.time_confine >= TIMESTAMPDIFF(MINUTE,  w.create_time ,w.handle_end) THEN 1 ELSE 0 END ) AS deal FROM ${lib.dynamic_dbname}.hk_event e LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON w.id=e.worder_id WHERE w.`source_type`=2 AND e.`event_status`=3 AND e.`worder_id` IS NOT NULL AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(e.create_time)) AS deal,
		(SELECT SUM(CASE WHEN w.time_confine &lt; TIMESTAMPDIFF(MINUTE,  w.create_time ,w.handle_end) AND w.handle_end IS NOT NULL THEN 1 ELSE 0 END ) AS deal FROM ${lib.dynamic_dbname}.hk_event e LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON w.id=e.worder_id WHERE w.`source_type`=2 AND e.`event_status`=3 AND e.`worder_id` IS NOT NULL AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(e.create_time)) AS laterDeal
		</if>
		<if test="queryType==2">
		(SELECT COUNT(e.`id`) FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`worder_id` IS NOT NULL AND DATE_SUB(CURDATE(), INTERVAL 1 YEAR) &lt;= DATE(e.create_time)) AS allEventCount,
		(SELECT COUNT(e.`event_status`) FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`worder_id` IS NOT NULL AND e.`event_status` = 3  AND DATE_SUB(CURDATE(), INTERVAL 1 YEAR) &lt;= DATE(create_time)) AS eventCount,
		(SELECT SUM(CASE WHEN w.time_confine >= TIMESTAMPDIFF(MINUTE,  w.create_time ,w.handle_end) THEN 1 ELSE 0 END ) AS deal FROM ${lib.dynamic_dbname}.hk_event e LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON w.id=e.worder_id WHERE w.`source_type`=2 AND e.`event_status`=3 AND e.`worder_id` IS NOT NULL AND DATE_SUB(CURDATE(), INTERVAL 1 YEAR) &lt;= DATE(e.create_time)) AS deal,
		(SELECT SUM(CASE WHEN w.time_confine &lt; TIMESTAMPDIFF(MINUTE,  w.create_time ,w.handle_end) AND w.handle_end IS NOT NULL THEN 1 ELSE 0 END ) AS deal FROM ${lib.dynamic_dbname}.hk_event e LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON w.id=e.worder_id WHERE w.`source_type`=2 AND e.`event_status`=3 AND e.`worder_id` IS NOT NULL AND DATE_SUB(CURDATE(), INTERVAL 1 YEAR) &lt;= DATE(e.create_time)) AS laterDeal
		</if>
		<if test="queryType==3">
		(SELECT COUNT(e.`id`) FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`worder_id` IS NOT NULL AND DATE_SUB(CURDATE(), INTERVAL 3 YEAR) &lt;= DATE(e.create_time)) AS allEventCount,
		(SELECT COUNT(e.`event_status`) FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`worder_id` IS NOT NULL AND e.`event_status` = 3  AND DATE_SUB(CURDATE(), INTERVAL 3 YEAR) &lt;= DATE(create_time)) AS eventCount,
		(SELECT SUM(CASE WHEN w.time_confine >= TIMESTAMPDIFF(MINUTE,  w.create_time ,w.handle_end) THEN 1 ELSE 0 END ) AS deal FROM ${lib.dynamic_dbname}.hk_event e LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON w.id=e.worder_id WHERE w.`source_type`=2 AND e.`event_status`=3 AND e.`worder_id` IS NOT NULL AND DATE_SUB(CURDATE(), INTERVAL 3 YEAR) &lt;= DATE(e.create_time)) AS deal,
		(SELECT SUM(CASE WHEN w.time_confine &lt; TIMESTAMPDIFF(MINUTE,  w.create_time ,w.handle_end) AND w.handle_end IS NOT NULL THEN 1 ELSE 0 END ) AS deal FROM ${lib.dynamic_dbname}.hk_event e LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON w.id=e.worder_id WHERE w.`source_type`=2 AND e.`event_status`=3 AND e.`worder_id` IS NOT NULL AND DATE_SUB(CURDATE(), INTERVAL 3 YEAR) &lt;= DATE(e.create_time)) AS laterDeal
		</if>
		FROM
		${lib.dynamic_dbname}.hk_event e
		) e
		LEFT JOIN
		(SELECT
		<if test="queryType==1">
		(SELECT COUNT(a.`id`) FROM ${lib.dynamic_dbname}.hk_alarm a WHERE a.`wor_id` IS NOT NULL AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(a.`create_time`)) AS allAlarmCount,
		(SELECT COUNT(a.`id`) FROM ${lib.dynamic_dbname}.hk_alarm a WHERE a.`wor_id` IS NOT NULL AND a.`handel_state` = 4 AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(a.`create_time`)) AS alarmCount,
		(SELECT SUM(CASE WHEN w.time_confine >= TIMESTAMPDIFF(MINUTE,  w.`create_time` ,w.`handle_end`) THEN 1 ELSE 0 END ) AS deal FROM ${lib.dynamic_dbname}.hk_alarm a LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON a.`worder_no` = w.`order_no` WHERE a.`handel_state` = 4 AND w.`order_status` = 4 AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(a.`create_time`)) AS deal,
		(SELECT SUM(CASE WHEN w.time_confine &lt; TIMESTAMPDIFF(MINUTE,  w.`create_time` ,w.`handle_end`) THEN 1 ELSE 0 END ) AS deal FROM ${lib.dynamic_dbname}.hk_alarm a LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON a.`worder_no` = w.`order_no` WHERE a.`handel_state` = 4 AND w.`order_status` = 4 AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) &lt;= DATE(a.`create_time`)) AS laterDeal
		</if> 
		<if test="queryType==2">
		(SELECT COUNT(a.`id`) FROM ${lib.dynamic_dbname}.hk_alarm a WHERE a.`wor_id` IS NOT NULL AND DATE_SUB(CURDATE(), INTERVAL 1 YEAR) &lt;= DATE(a.`create_time`)) AS allAlarmCount,
		(SELECT COUNT(a.`id`) FROM ${lib.dynamic_dbname}.hk_alarm a WHERE a.`wor_id` IS NOT NULL AND a.`handel_state` = 4 AND DATE_SUB(CURDATE(), INTERVAL 1 YEAR) &lt;= DATE(a.`create_time`)) AS alarmCount,
		(SELECT SUM(CASE WHEN w.time_confine >= TIMESTAMPDIFF(MINUTE,  w.`create_time` ,w.`handle_end`) THEN 1 ELSE 0 END ) AS deal FROM ${lib.dynamic_dbname}.hk_alarm a LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON a.`worder_no` = w.`order_no` WHERE a.`handel_state` = 4 AND w.`order_status` = 4 AND DATE_SUB(CURDATE(), INTERVAL 1 YEAR) &lt;= DATE(a.`create_time`)) AS deal,
		(SELECT SUM(CASE WHEN w.time_confine &lt; TIMESTAMPDIFF(MINUTE,  w.`create_time` ,w.`handle_end`) THEN 1 ELSE 0 END ) AS deal FROM ${lib.dynamic_dbname}.hk_alarm a LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON a.`worder_no` = w.`order_no` WHERE a.`handel_state` = 4 AND w.`order_status` = 4 AND DATE_SUB(CURDATE(), INTERVAL 1 YEAR) &lt;= DATE(a.`create_time`)) AS laterDeal
		</if>
		<if test="queryType==3">
		(SELECT COUNT(a.`id`) FROM ${lib.dynamic_dbname}.hk_alarm a WHERE a.`wor_id` IS NOT NULL AND DATE_SUB(CURDATE(), INTERVAL 3 YEAR) &lt;= DATE(a.`create_time`)) AS allAlarmCount,
		(SELECT COUNT(a.`id`) FROM ${lib.dynamic_dbname}.hk_alarm a WHERE a.`wor_id` IS NOT NULL AND a.`handel_state` = 4 AND DATE_SUB(CURDATE(), INTERVAL 3 YEAR) &lt;= DATE(a.`create_time`)) AS alarmCount,
		(SELECT SUM(CASE WHEN w.time_confine >= TIMESTAMPDIFF(MINUTE,  w.`create_time` ,w.`handle_end`) THEN 1 ELSE 0 END ) AS deal FROM ${lib.dynamic_dbname}.hk_alarm a LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON a.`worder_no` = w.`order_no` WHERE a.`handel_state` = 4 AND w.`order_status` = 4 AND DATE_SUB(CURDATE(), INTERVAL 3 YEAR) &lt;= DATE(a.`create_time`)) AS deal,
		(SELECT SUM(CASE WHEN w.time_confine &lt; TIMESTAMPDIFF(MINUTE,  w.`create_time` ,w.`handle_end`) THEN 1 ELSE 0 END ) AS deal FROM ${lib.dynamic_dbname}.hk_alarm a LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON a.`worder_no` = w.`order_no` WHERE a.`handel_state` = 4 AND w.`order_status` = 4 AND DATE_SUB(CURDATE(), INTERVAL 3 YEAR) &lt;= DATE(a.`create_time`)) AS laterDeal
		</if>
		FROM
		${lib.dynamic_dbname}.hk_alarm a
		) a ON 1=1
		GROUP BY dealCount))t1 RIGHT JOIN (SELECT 1) t2 ON 1=1
	</select>
	
	<!-- 态势分析,获取今日报警总数 -->
	<select id="getSTAlarmTodayCount" resultType="java.util.HashMap">
		SELECT
		a.todayCount,
		b.devalarmCount,
		b.devundisposed,
		b.devbeingProcessed,
		b.devprocessed,
		b.devoverProcessed,
		c.pereventCount,
		c.perundisposed,
		c.perbeingProcessed,
		c.perprocessed,
		c.peroverProcessed,
		d.opieventCount,
		d.opiundisposed,
		d.opibeingProcessed,
		d.opiprocessed,
		d.opioverProcessed
		FROM
		(SELECT SUM((SELECT COUNT(a.`id`) AS alarmCount FROM ${lib.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` != 5 AND TO_DAYS(a.`create_time`) = TO_DAYS(NOW())) + (SELECT COUNT(e.`event_status`) AS eventCount FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`event_status` != 4 AND TO_DAYS(e.create_time) = TO_DAYS(NOW()))+(SELECT COUNT(e.`event_status`) AS eventCount FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`event_status` != 4 AND e.`event_type` = 2 AND TO_DAYS(e.create_time) = TO_DAYS(NOW()))) AS todayCount) a
		LEFT JOIN
		(SELECT
		COUNT(a.`id`) AS devalarmCount,
		(SELECT COUNT(a.`id`) FROM ${lib.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND TO_DAYS(a.`create_time`) = TO_DAYS(NOW())) AS devundisposed,
		(SELECT COUNT(a.`id`) FROM ${lib.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 1 OR a.`handel_state` = 3 AND TO_DAYS(a.`create_time`) = TO_DAYS(NOW()) ) AS devbeingProcessed,
		(SELECT COUNT(a.`id`) FROM ${lib.dynamic_dbname}.hk_alarm a WHERE TO_DAYS(a.`create_time`) = TO_DAYS(NOW()) AND (a.`handel_state` = 4 OR a.`handel_state` = 2) ) AS devprocessed,
		(SELECT COUNT(a.`id`) FROM ${lib.dynamic_dbname}.hk_alarm a LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON a.`wor_id`=w.`id` WHERE w.time_confine &lt; TIMESTAMPDIFF(MINUTE,  w.`create_time` ,w.`handle_end`) AND TO_DAYS(a.`create_time`) = TO_DAYS(NOW())) AS devoverProcessed
		FROM ${lib.dynamic_dbname}.hk_alarm a
		WHERE a.`handel_state` != 5 AND TO_DAYS(a.`create_time`) = TO_DAYS(NOW())) b ON 1=1
		LEFT JOIN
		(SELECT
		COUNT(e.`event_status`) AS pereventCount,
		(SELECT COUNT(e.`event_status`) FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`event_status` = 0 AND TO_DAYS(e.create_time) = TO_DAYS(NOW())) AS perundisposed,
		(SELECT COUNT(e.`event_status`) FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`event_status` = 2 OR e.`event_status` = 1 AND TO_DAYS(e.create_time) = TO_DAYS(NOW())) AS perbeingProcessed,
		(SELECT COUNT(e.`event_status`) FROM ${lib.dynamic_dbname}.hk_event e LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON w.id=e.worder_id WHERE e.`event_status` = 3 AND e.`time_confine` >= TIMESTAMPDIFF(MINUTE,  e.`create_time` ,w.`handle_end`) AND TO_DAYS(e.create_time) = TO_DAYS(NOW())) AS perprocessed,
		(SELECT COUNT(e.`event_status`) FROM ${lib.dynamic_dbname}.hk_event e LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON w.id=e.worder_id WHERE e.`event_status` = 3 AND e.`time_confine` &lt;= TIMESTAMPDIFF(MINUTE,  e.create_time ,w.handle_end) AND TO_DAYS(e.create_time) = TO_DAYS(NOW())) AS peroverProcessed
		FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`event_status` != 4 AND TO_DAYS(e.create_time) = TO_DAYS(NOW())
		) c ON 1=1
		LEFT JOIN
		(SELECT
		COUNT(e.`event_status`) AS opieventCount,
		(SELECT COUNT(e.`event_status`) FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`event_status` = 0 AND e.`event_type` = 2 AND TO_DAYS(e.create_time) = TO_DAYS(NOW())) AS opiundisposed,
		(SELECT COUNT(e.`event_status`) FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`event_status` = 2 AND e.`event_type` = 2 AND TO_DAYS(e.create_time) = TO_DAYS(NOW())) AS opibeingProcessed,
		(SELECT COUNT(e.`event_status`) FROM ${lib.dynamic_dbname}.hk_event e LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON w.id=e.worder_id WHERE e.`event_status` = 3 AND e.`event_type` = 2 AND e.`time_confine` >= TIMESTAMPDIFF(MINUTE,  e.`create_time` ,w.`handle_end`) AND TO_DAYS(e.create_time) = TO_DAYS(NOW())) AS opiprocessed,
		(SELECT COUNT(e.`event_status`) FROM ${lib.dynamic_dbname}.hk_event e LEFT JOIN ${lib.dynamic_dbname}.hk_worder w ON w.id=e.worder_id WHERE e.`event_status` = 3 AND e.`event_type` = 2 AND e.`time_confine` &lt;= TIMESTAMPDIFF(MINUTE,  e.create_time ,w.handle_end) AND TO_DAYS(e.create_time) = TO_DAYS(NOW())) AS opioverProcessed
		FROM ${lib.dynamic_dbname}.hk_event e WHERE e.`event_status` != 4 AND e.`event_type` = 2 AND TO_DAYS(e.create_time) = TO_DAYS(NOW())
		) d ON 1=1

	</select>
	
	<!-- 事件分页 -->
	<select id="eventPage"
		resultType="com.hotcomm.community.common.bean.ui.process.event.EventPageUM">
		SELECT 
			2 as reportType,
		  e.lat,e.lng,
		    case when w.id is not null then w.id else '' end as worderId,
		  	CASE
			WHEN w.`order_status` = 1
			THEN 1
			WHEN w.`order_status` = 2
			THEN 2
			WHEN w.`order_status` = 3
			THEN 3
			WHEN w.`order_status` = 4
			THEN 4
			else ''
			END AS worderPageState,
		  CASE WHEN e.event_status=0 THEN 1 WHEN e.event_status=1 THEN 2 WHEN e.event_status=2 THEN 3 WHEN e.event_status=3 THEN 4 WHEN e.event_status=4 THEN 5 END AS pageState,
		  e.`id` AS id,
		  e.`event_no` AS eventNo,
		  e.`event_desc` AS eventDesc,
		  case when e.event_status=0 then '待处理' when e.event_status=1 then '已转工单' when e.event_status=2 then '处理中' when e.event_status=3 then '已处理' when e.event_status=4 then '已关闭' end as eventState,
		  CASE 
		    WHEN e.`event_type` = 1 
		    THEN '设备事件' 
		    WHEN e.`event_type` = 2 
		    THEN '户政事件' 
		    WHEN e.`event_type` = 3 
		    THEN '消防事件' 
		    WHEN e.`event_type` = 4 
		    THEN '治安事件' 
		    WHEN e.`event_type` = 5 
		    THEN '刑事事件' 
		    WHEN e.`event_type` = 6 
		    THEN '交通事件' 
		    WHEN e.`event_type` = 7 
		    THEN '生产安全事件' 
		    WHEN e.`event_type` = 8 
		    THEN '其他事件' 
		  END AS sourceType,
		  CASE WHEN e.time_confine=60 THEN '非常紧急' WHEN e.time_confine=480 THEN '比较紧急' WHEN e.time_confine=1440 THEN '紧急' WHEN e.time_confine=4320 THEN '一般' WHEN e.time_confine=7200 THEN '不紧急'  ELSE '不紧急' END AS eventGrade,
		  e.`create_time` AS reporteTime,
		  IFNULL(case when e.event_status=3 then w.handle_end when e.event_status=4 then e.close_time END,'') AS handleEnd,
		  e.`event_address` AS sourceAddress,
		  CASE WHEN e.worder_id IS NOT NULL THEN CONCAT(uw.real_name, ' ', uw.telephone) ELSE IFNULL(CONCAT(us.real_name, ' ', us.telephone),'') END AS handleUser,
		  CASE WHEN CONCAT(u.real_name, ' ', u.telephone) IS NOT NULL THEN CONCAT(u.real_name, ' ', u.telephone) ELSE '' END AS reporteName,
		  case when w.`order_no` is not null then w.`order_no` else '' end AS worderNo 
		FROM
		  ${library.dynamic_dbname}.hk_event e 
		  LEFT JOIN hotcomm_community.hk_sys_user u 
		    ON e.`reported_user_id` = u.`user_id` 
		  LEFT JOIN hotcomm_community.hk_sys_user us 
		    ON e.`handle_user_id` = us.`user_id` 
		  LEFT JOIN ${library.dynamic_dbname}.hk_worder w 
		    ON e.worder_id = w.`id` 
		  LEFT JOIN hotcomm_community.hk_sys_user uw 
		    ON w.`handle_user_id` = uw.`user_id` 
		<!-- 根据处理人查询 -->
<!-- 		<if test="eventPagePA.handleUser !=null and eventPagePA.handleUser !=''"> -->
<!-- 		inner join ${library.dynamic_dbname}.hk_worder wu on wu.id=e.worder_id and wu.handle_user_id=#{eventPagePA.handleUser} -->
<!-- 		</if> -->
		WHERE 1 = 1     
		<!-- 判断列表类型 0.正常列表 1.工单历史记录 -->
		<if test="eventPagePA.pageType == 0">
			and e.`event_status` NOT IN (3,4)
		</if>
		<if test="eventPagePA.pageType == 1">
			and e.`event_status` IN (3,4)
		</if>
		<!-- 根据事件状态查询 -->
		<if test="eventPagePA.eventStatus!=null">
			and e.event_status=${eventPagePA.eventStatus}
		</if>
		<!-- 根据处理人查询 -->
		<if test="eventPagePA.handleUser !=null and eventPagePA.handleUser !=''">
		and (e.handle_user_id=#{eventPagePA.handleUser} or w.handle_user_id=#{eventPagePA.handleUser})
		</if>
		<!-- 根据事件类型查询 -->
		<if test="eventPagePA.sourceType != null and eventPagePA.sourceType !=''">
			and e.event_type=${eventPagePA.sourceType}
		</if>
		<!-- 根据紧急程度查询 -->
		<if test="eventPagePA.eventGrade != null and eventPagePA.eventGrade !=''">
			and e.time_confine=${eventPagePA.eventGrade}
		</if>
		<!-- 根据上报人查询 -->
		<if test="eventPagePA.reporteName !=null and eventPagePA.reporteName !=''">
			and e.reported_user_id=${eventPagePA.reporteName}
		</if>
		<!-- 根据上报时间查询 -->
		<if test="eventPagePA.startTime !=null and eventPagePA.startTime != ''">
			and e.create_time>=#{eventPagePA.startTime}
		</if>
		<if test="eventPagePA.handleEnd !=null and eventPagePA.handleEnd != ''">
		    and e.create_time &lt;=#{eventPagePA.handleEnd}
		</if>
		<if test="eventPagePA.eventNo !=null and eventPagePA.eventNo !=''">
			and (e.event_no=#{eventPagePA.eventNo} or e.event_title like '%${eventPagePA.eventNo}%')
		</if>
		order by e.create_time desc
	</select>
	
	<!-- 关闭事件 -->
	<update id="closeEvent">
		UPDATE ${library.dynamic_dbname}.hk_event e SET
		e.`event_view` = #{pa.eventView},e.`close_mark`=#{pa.closedRemark},e.`close_reason_id`=#{pa.closeResultId},e.`event_status`=4,close_time=NOW(),e.close_user_id=#{pa.userid}
		WHERE e.`id` =#{pa.eventId}
	</update>
	
	<!-- 新增事件 -->
	<insert id="EventNewPA" parameterType="com.hotcomm.community.common.bean.pa.process.event.EventNewPA"  useGeneratedKeys="true" keyProperty="eventId">
		insert into ${map.dynamic_dbname}.hk_event
		(handle_user_id,create_time,event_type,event_status,event_source,event_title,event_htime,event_view,time_confine,lng,lat,
		<if test="eventDesc!=null and eventDesc!=''">
		event_desc,
		</if>
		<if test="addressStr!=null and addressStr!=''">
		event_address,
		</if>
		<if test="videoRelation!=null and videoRelation!=''">
		video_relation,
		</if>
		<if test="sourceId!=null and sourceId!=''">
		source_id,
		</if>
		reported_user_id,leader_tip
		)
		values
		(#{handleUserId},NOW(),${sourceType},0,#{eventSourceFrom},#{eventTitle},
		#{eventHTime},#{eventView},#{timeConfine},#{addressLong},#{addressLat},
		<if test="eventDesc!=null and eventDesc!=''">
		#{eventDesc},
		</if>
		<if test="addressStr!=null and addressStr!=''">
		#{addressStr},
		</if>
		<if test="videoRelation!=null and videoRelation!=''">
		#{videoRelation},
		</if>
		<if test="sourceId!=null and sourceId!=''">
		${sourceId},
		</if>
		#{userid},'{"leaderTip": {"tip": [{"id": "1", "content": "快速查明原因，并且杜绝后患", "user_id": "1", "leader_name": "李佳"}, {"id": "2", "content": "设备安全性很重要，希望各部门注意", "user_id": "1", "leader_name": "尚书"}]}}'
		)
	</insert>
	
	<!-- 工单列表分页 -->
	<select id="worderPage"
		resultType="com.hotcomm.community.common.bean.ui.process.worder.WorderListUM">
		SELECT
		  CASE
		    WHEN w.source_type = 1 
		    THEN 1 
		    WHEN w.source_type = 2 
		    THEN 2 
		    ELSE '' 
		  END AS infoType,
		  CASE
		    WHEN w.source_type = 1 
		    THEN w.source_id 
		    WHEN w.source_type = 2 
		    THEN w.source_id 
		    ELSE '' 
		  END AS infoId,
		  CASE
		    WHEN w.source_type = 1 
		    THEN alarmPageState 
		    WHEN w.source_type = 2 
		    THEN eventPageState 
		    ELSE '' 
		  END AS infoPageState,
		w.lng,w.lat,
		CASE
		WHEN w.`order_status` = 1
		THEN 1
		WHEN w.`order_status` = 2
		THEN 2
		WHEN w.`order_status` = 3
		THEN 3
		WHEN w.`order_status` = 4
		THEN 4
		END AS pageState,
		w.`id` AS id,
		w.`order_no` AS orderNo,
		w.`order_title` AS orderTitle,
		case when w.time_confine=60 then '一小时' when w.time_confine=480 then '八小时' when w.time_confine=1440 then '一天内'  when w.time_confine=4320 then '三天内'  when w.time_confine=7200 then '其他' end AS timeConfine,
		w.`create_time` AS startTime,
		w.`source_address` AS sourceAddress,
		case when w.`handle_end` is not null then w.`handle_end` else '' end AS handleEnd,
		CASE
		WHEN w.`order_status` = 1
		THEN '待处理'
		WHEN w.`order_status` = 2
		THEN '处理中'
		WHEN w.`order_status` = 3
		THEN '挂起'
		WHEN w.`order_status` = 4
		THEN '已处理'
		END AS orderStatus,
		t1.information,
		case when CONCAT(u.real_name, ' ', u.telephone) is not null then CONCAT(u.real_name, ' ', u.telephone) else '' end AS handleUser,
		case when CONCAT(us.real_name, ' ', us.telephone) is not null then CONCAT(us.real_name, ' ', us.telephone) else '' end AS creatUser
		FROM
		${library.dynamic_dbname}.hk_worder w
		LEFT JOIN ${library.base_dbname}.hk_sys_user u ON u.user_id=w.`handle_user_id`
		LEFT JOIN ${library.base_dbname}.hk_sys_user us ON us.user_id = w.`create_user_id`
		LEFT JOIN (SELECT 
				      CASE
				        WHEN a.handel_state = 0 
				        THEN 1 
				        WHEN a.handel_state = 1 
				        THEN 2 
				        WHEN a.handel_state = 3 
				        AND a.worder_no IS NULL 
				        OR a.`worder_no` = '' 
				        THEN 3 
				        WHEN a.handel_state = 3 
				        AND a.worder_no IS NOT NULL 
				        AND a.`worder_no` != '' 
				        THEN 4 
				        WHEN a.handel_state = 4 
				        THEN 5 
				        WHEN a.handel_state = 2 
				        THEN 6 
				        WHEN a.handel_state = 5 
				        THEN 7 
				      END AS alarmPageState,
				      w.id,
				      CASE
				        WHEN e.event_status = 0 
				        THEN 1 
				        WHEN e.event_status = 1 
				        THEN 2 
				        WHEN e.event_status = 2 
				        THEN 3 
				        WHEN e.event_status = 3 
				        THEN 4 
				        WHEN e.event_status = 4 
				        THEN 5 
				        ELSE '' 
				      END AS eventPageState,
				      CASE
				        WHEN w.source_type = 1 
				        THEN CONCAT('报警', a.id) 
				        WHEN w.source_type = 2 
				        THEN CONCAT('事件', e.event_no) 
				        WHEN w.source_type = 3 
				        THEN CONCAT('设备', d.dev_num) 
				        WHEN w.source_type = 4 
				        THEN '其他' 
				      END AS information 
		FROM
		${library.dynamic_dbname}.hk_worder w 
		LEFT JOIN ${library.dynamic_dbname}.hk_device d ON w.`source_id` =  d.`id`
		LEFT JOIN ${library.dynamic_dbname}.hk_event e ON w.`source_id` = e.`id`
		LEFT JOIN ${library.dynamic_dbname}.hk_alarm a ON w.`source_id` =  a.`id`) t1 ON t1.id=w.id
		where 1=1 
		<!-- 判断列表类型 0.正常列表 1.工单历史记录 -->
		<if test=" worderListPA.pageType == 0">
			and w.`order_status` != 4 
		</if>
		<if test=" worderListPA.pageType == 1">
		 	and w.`order_status` = 4
		</if>
		<!-- 根据工单编号查询 -->
		<if test="worderListPA.orderNo !=null and worderListPA.orderNo !=''">
			and w.order_no=#{worderListPA.orderNo}
		</if>
		<!-- 根据创建时间查询 -->
		<if test="worderListPA.startTime !=null and worderListPA.startTime != ''">
			and w.create_time>=#{worderListPA.startTime}
		</if>
		<if test="worderListPA.handleEnd !=null and worderListPA.handleEnd != ''">
		    and w.create_time &lt;=#{worderListPA.handleEnd}
		</if>
		<!-- 根据处理人查询 -->
		<if test="worderListPA.handleUser !=null and worderListPA.handleUser != ''">
			and w.handle_user_id=${worderListPA.handleUser}
		</if>
		<!-- 根据状态查询 -->
		<if test="worderListPA.orderStatus != null and worderListPA.orderStatus != ''">
			and w.order_status=${worderListPA.orderStatus}
		</if>
		<!-- 根据要求处理时间查询 -->	
		<if test="worderListPA.orderInfo !=null and worderListPA.orderInfo != '' and worderListPA.orderInfo !=0">
			and w.time_confine=${worderListPA.orderInfo}
		</if>
		order by w.create_time desc
	</select>
	
	<!-- 工单概况 -->
	<!-- 本月工单总数,本月待处理工单,本月工单及时处理率 -->
	<select id="getWorderCount" resultType="com.hotcomm.community.common.bean.ui.process.worder.WorderGkUM">
		SELECT
		<!-- 本月工单总数 -->
		(SELECT COUNT(*) FROM ${library.dynamic_dbname}.hk_worder w WHERE LAST_DAY(NOW()) >= w.`create_time` AND w.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')) AS orderCount,
		<!-- 本月待处理工单 -->
		(SELECT COUNT(w.`order_status`) AS watingOrder FROM ${library.dynamic_dbname}.hk_worder w WHERE LAST_DAY(NOW()) >= w.`create_time` AND w.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01') AND w.`order_status` = 1) AS waitingOrder,
		<!-- 本月工单处理及时率 -->
		IFNULL( ROUND( SUM(
		CASE
		WHEN w.time_confine >= TIMESTAMPDIFF(MINUTE,  w.`create_time` ,w.`handle_end`) AND w.`order_status` = 4
		THEN 1
		ELSE 0
		END 
		) / 
		COUNT(w.`order_status`)*100,0),'0')  AS percent
		FROM ${library.dynamic_dbname}.hk_worder w
		WHERE LAST_DAY(NOW()) >= w.`create_time`
		AND w.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')
	</select>
	
	<!-- 本月工单来源分布 -->
	<select id="getWorderSource" resultType="com.hotcomm.community.common.bean.ui.process.worder.WorderGkSourceUM">
<!-- 		SELECT 
		IF(a.source_type=1,'报警',IF(a.source_type=2,'事件',IF(a.source_type=3,'设备','其他'))) AS sourceType,
		SUM(CASE WHEN w.`id` != 0 THEN 1 ELSE 0 END) AS countByType,
		CONCAT(ROUND( COUNT(w.`source_type`)/(SELECT COUNT(1) FROM ${library.dynamic_dbname}.hk_worder)*100,0),'','%') AS percent 
		FROM (
		SELECT 1 AS source_type
		UNION
		SELECT 2 AS source_type
		UNION
		SELECT 3 AS source_type
		UNION
		SELECT 4 AS source_type
		) a
		LEFT JOIN 
		${library.dynamic_dbname}.hk_worder w ON a.source_type = w.source_type
		GROUP BY a.`source_type`  -->
		SELECT 
		IF(a.source_type=1,'报警',IF(a.source_type=2,'事件',IF(a.source_type=3,'设备','其他'))) AS sourceType,
		SUM(CASE WHEN w.`id` != 0 THEN 1 ELSE 0 END) AS countByType,
		CONCAT(ROUND( COUNT(w.`source_type`)/(SELECT COUNT(1) FROM ${library.dynamic_dbname}.hk_worder w WHERE LAST_DAY(NOW()) >= w.`create_time` AND w.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01'))*100,0),'','%') AS percent 
		FROM (
		SELECT 1 AS source_type
		UNION
		SELECT 2 AS source_type
		UNION
		SELECT 3 AS source_type
		UNION
		SELECT 4 AS source_type
		) a
		LEFT JOIN 
		${library.dynamic_dbname}.hk_worder w ON a.source_type = w.source_type AND LAST_DAY(NOW()) >= w.`create_time` AND w.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')
		GROUP BY a.`source_type` 
	</select>
	
	<!-- 本月工单处理状态 -->
	<select id="getWorderState" resultType="com.hotcomm.community.common.bean.ui.process.worder.WorderGkStatusUM">
			SELECT
			IFNULL(a.orderCount,'0') AS orderCount,
			IFNULL(a.pendingCount,'0') AS pendingCount,
			IFNULL(a.hungCount,'0') AS hungCount,
			IFNULL(a.processCount,'0') AS processCount
			FROM
			(SELECT 
			(SELECT COUNT(*) FROM ${library.dynamic_dbname}.hk_worder w WHERE LAST_DAY(NOW()) >= w.`create_time` AND w.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')) AS orderCount,
			(SELECT COUNT(*) FROM ${library.dynamic_dbname}.hk_worder w WHERE w.order_status =1 AND LAST_DAY(NOW()) >= w.`create_time` AND w.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')) AS pendingCount,
			(SELECT COUNT(*) FROM ${library.dynamic_dbname}.hk_worder w WHERE w.order_status =3 AND LAST_DAY(NOW()) >= w.`create_time` AND w.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')) AS hungCount,
			(SELECT COUNT(*) FROM ${library.dynamic_dbname}.hk_worder w WHERE w.order_status =4 AND LAST_DAY(NOW()) >= w.`create_time` AND w.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')) AS processCount
			FROM
			${library.dynamic_dbname}.hk_worder ) a RIGHT JOIN (SELECT 1) t2 ON 1=1 GROUP BY orderCount
	</select>
	
	<!-- 本月工单数量 -->
	<select id="getWorderdata" resultType="com.hotcomm.community.common.bean.ui.process.worder.WorderGkOrderCountUM">
		SELECT 
		timeConfig.`timeInfo`,
		COUNT(w.`id`) AS orderCount
		FROM
		${library.dynamic_dbname}.hk_worder w 
		RIGHT JOIN 
		(SELECT 
		 @tempDay := DATE_ADD(@tempDay, INTERVAL 1 DAY) AS timeInfo 
		 FROM
		 ${library.base_dbname}.`hk_diction` t 
		 JOIN 
		 (SELECT @tempDay := DATE_SUB(DATE_ADD(CURDATE(),INTERVAL - DAY(CURDATE()) + 1 DAY),INTERVAL 1 DAY)) b 
		    WHERE @tempDay &lt; LAST_DAY(CURDATE())) AS timeConfig 
		    ON DATE_FORMAT(w.`create_time`, '%Y-%m-%d') = DATE_FORMAT(timeConfig.`timeInfo`,'%Y-%m-%d') 
		GROUP BY timeConfig.`timeInfo` 
		ORDER BY timeConfig.`timeInfo` 
	</select>
	
	<!-- 工单处理及时率趋势 -->
	<select id="getWorderProTrend" resultType="com.hotcomm.community.common.bean.ui.process.worder.WorderGkProRateUM">
		SELECT 
      	timeConfig.`timeInfo` AS orderDate,
		IFNULL((CONCAT( ROUND( SUM(
		CASE
		WHEN w.`time_confine` >= TIMESTAMPDIFF(MINUTE,  w.`create_time` ,w.`handle_end`) AND w.`order_status`=4
		THEN 1
		ELSE 0
		END 
		) /  COUNT(w.`order_status`)*100,0),'' )),0 )AS percent
    	FROM
      	${library.dynamic_dbname}.hk_worder w 
      	RIGHT JOIN 
        (SELECT 
          @tempDay := DATE_ADD(@tempDay, INTERVAL 1 DAY) AS timeInfo 
        FROM
          ${library.base_dbname}.`hk_diction` t 
          JOIN 
            (SELECT 
              @tempDay := DATE_SUB(
                DATE_ADD(
                  CURDATE(),
                  INTERVAL - DAY(CURDATE()) + 1 DAY
                ),
                INTERVAL 1 DAY
              )) b 
        WHERE @tempDay &lt; LAST_DAY(CURDATE())) AS timeConfig 
        ON DATE_FORMAT(w.`create_time`, '%Y-%m-%d') = DATE_FORMAT(
          timeConfig.`timeInfo`,
          '%Y-%m-%d'
        ) 
    	GROUP BY timeConfig.`timeInfo` 
    	ORDER BY timeConfig.`timeInfo` 
	</select>
	
	<!-- 后台首页待处理统计 -->
	<select id="getWorder" resultType="com.hotcomm.community.common.bean.ui.home.PendingSituationUM">
<!-- 		SELECT 
		IFNULL(t1.orderNum,'0') AS orderNum,
		IFNULL(t1.orderNumPercent,'0') AS orderNumPercent,
		IFNULL(t1.reportAlertNum,'0') AS reportAlertNum,
		IFNULL(t1.reportAlertNumPercent,'0') AS reportAlertNumPercent,
		IFNULL(t1.populationAlertNum,'0') AS populationAlertNum,
		IFNULL(t1.populationAlertPercent,'0') AS populationAlertPercent,
		IFNULL(t1.deviceAlertNum,'0') AS deviceAlertNum,
		IFNULL(t1.deviceAlertPercent,'0') AS deviceAlertPercent,
		IFNULL(t1.carAlertNum,'0') AS carAlertNum,
		IFNULL(t1.carAlertPercent,'0') AS carAlertPercent
		FROM (SELECT
		(SELECT COUNT(w.`id`) FROM ${library.dynamic_dbname}.hk_worder w WHERE w.`order_status` = 1) AS orderNum,
		(ROUND( (SELECT COUNT(w.`order_status`) FROM ${library.dynamic_dbname}.hk_worder w WHERE w.`order_status` = 1) / (SELECT COUNT(w.`id`) FROM ${library.dynamic_dbname}.hk_worder w)*100,0)) AS orderNumPercent, 
		(SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0) AS reportAlertNum ,
		(ROUND( (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0) / (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a)*100,0)) AS reportAlertNumPercent,
		(SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 3) AS populationAlertNum,
		(ROUND( (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 3) / (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a)*100,0)) AS populationAlertPercent,
		(SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 1) AS deviceAlertNum,
		(ROUND( (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 1) / (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a)*100,0)) AS deviceAlertPercent,
		(SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 2) AS carAlertNum,
		(ROUND( (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 2) / (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a)*100,0)) AS carAlertPercent
		FROM ${library.dynamic_dbname}.hk_worder w LEFT JOIN ${library.dynamic_dbname}.hk_alarm a ON 1=1
		GROUP BY orderNum) t1 RIGHT JOIN (SELECT 1) t2 ON 1=1 -->
		SELECT
		(SELECT COUNT(w.`id`) FROM ${library.dynamic_dbname}.hk_worder w WHERE w.`order_status` = 1) AS orderNum,
		CASE
		WHEN (SELECT COUNT(w.`id`) FROM ${library.dynamic_dbname}.hk_worder w) = 0
		THEN 0
		ELSE (FLOOR( (SELECT COUNT(w.`order_status`) FROM ${library.dynamic_dbname}.hk_worder w WHERE w.`order_status` = 1) / (SELECT COUNT(w.`id`) FROM ${library.dynamic_dbname}.hk_worder w)*100)) END AS orderNumPercent, 
		(SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0) AS reportAlertNum ,
		CASE
		WHEN (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a) = 0
		THEN 0
<!-- 		ELSE (FLOOR( (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0) / (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a)*100)) END AS reportAlertNumPercent, -->
		ELSE (FLOOR( (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 3) / (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a)*100)+FLOOR( (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 1) / (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a)*100)+FLOOR( (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 2) / (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a)*100)) END AS reportAlertNumPercent,
		(SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 3) AS populationAlertNum,
		CASE
		WHEN (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a) = 0
		THEN 0
		ELSE (FLOOR( (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 3) / (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a)*100)) END AS populationAlertPercent,
		(SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 1) AS deviceAlertNum,
		CASE
		WHEN (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a) = 0
		THEN 0
		ELSE (FLOOR( (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 1) / (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a)*100)) END AS deviceAlertPercent,
		(SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 2) AS carAlertNum,
		CASE
		WHEN (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a) = 0
		THEN 0
		ELSE (FLOOR( (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state` = 0 AND a.`alarm_type` = 2) / (SELECT COUNT(a.`id`) FROM ${library.dynamic_dbname}.hk_alarm a)*100)) END AS carAlertPercent
		FROM (SELECT 1=1) t LEFT JOIN ${library.dynamic_dbname}.hk_alarm a ON 1=1 LEFT JOIN ${library.dynamic_dbname}.hk_worder w ON 1=1
		GROUP BY orderNum
	</select>
	
	<!-- 获取工单后台首页 ,报警类型统计 -->
	<select id="getHTWorderSourceCount" resultType="java.util.HashMap">
		SELECT 
  		lableName,
  		CASE
    	WHEN lableName = '报警' 
    	THEN alarmCount
    	WHEN lableName = '设备' 
    	THEN devCount
    	WHEN lableName = '事件' 
    	THEN eventCount
    	WHEN lableName = '其他' 
    	THEN otherCount
    	ELSE 0 
  		END AS countInfo,
  		CASE
    	WHEN lableName = '报警' 
    	THEN IFNULL(CONCAT(ROUND(alarmCount / (eventCount + alarmCount + devCount + otherCount)*100,0),'','%'),'0')
    	WHEN lableName = '设备' 
    	THEN IFNULL(CONCAT(ROUND(devCount / (eventCount + alarmCount + devCount + otherCount)*100,0),'','%'),'0')
    	WHEN lableName = '事件'
    	THEN IFNULL(CONCAT(ROUND(eventCount / (eventCount + alarmCount + devCount + otherCount)*100,0),'','%'),'0')
    	WHEN lableName = '其他'
    	THEN IFNULL(CONCAT(ROUND(otherCount / (eventCount + alarmCount + devCount + otherCount)*100,0),'','%'),'0')
    	ELSE 0
  		END AS percent 
		FROM
  		(SELECT 
    	'报警' AS lableName 
  		UNION
  		SELECT 
    	'设备' AS lableName 
  		UNION
  		SELECT 
    	'事件' AS lableName
    	UNION
  		SELECT 
    	'其他' AS lableName) t1 
  		JOIN 
    	(SELECT COUNT(0) AS alarmCount FROM ${library.dynamic_dbname}.hk_worder w WHERE w.source_type=1 AND YEARWEEK(DATE_FORMAT(w.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())) t2 
  		JOIN 
    	(SELECT COUNT(0) AS devCount FROM ${library.dynamic_dbname}.hk_worder w WHERE w.source_type=3 AND YEARWEEK(DATE_FORMAT(w.create_time,'%Y-%m-%d')) = YEARWEEK(NOW())) t3 
    	JOIN 
    	(SELECT COUNT(0) AS eventCount FROM ${library.dynamic_dbname}.hk_worder w WHERE w.source_type=2 AND YEARWEEK(DATE_FORMAT(w.create_time,'%Y-%m-%d')) = YEARWEEK(NOW())) t4 
    	JOIN 
    	(SELECT COUNT(0) AS otherCount FROM ${library.dynamic_dbname}.hk_worder w WHERE w.source_type=4 AND YEARWEEK(DATE_FORMAT(w.create_time,'%Y-%m-%d')) = YEARWEEK(NOW())) t5
	</select>
	
	<!-- 获取工单后台首页 ,工单状态的统计-->
	<select id="getHTWorderBystatus" resultType="java.util.HashMap">
		<!-- SELECT t1.* FROM (SELECT 
		(SELECT COUNT(0) FROM ${library.dynamic_dbname}.hk_worder w WHERE YEARWEEK(DATE_FORMAT(w.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())) AS orderCount,
		(SELECT COUNT(0) FROM ${library.dynamic_dbname}.hk_worder w WHERE w.order_status = 4 AND YEARWEEK(DATE_FORMAT(w.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())) AS processedCount,
		(SELECT COUNT(0) FROM ${library.dynamic_dbname}.hk_worder w WHERE w.order_status = 1 AND YEARWEEK(DATE_FORMAT(w.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())) AS pendingCoutn,
		(SELECT COUNT(0) FROM ${library.dynamic_dbname}.hk_worder w WHERE w.order_status = 3 AND YEARWEEK(DATE_FORMAT(w.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())) AS hungCount
		FROM 
		${library.dynamic_dbname}.hk_worder
		GROUP BY orderCount) t1 RIGHT JOIN (SELECT 1) t2 ON 1=1 -->
		SELECT 
        IFNULL(t1.orderCount,'0') AS orderCount,
        IFNULL(t1.processedCount,'0') AS processedCount,
        IFNULL(t1.pendingCoutn,'0') AS pendingCoutn,
        IFNULL(t1.hungCount,'0') AS hungCount
        FROM (SELECT 
		(SELECT COUNT(0) FROM ${library.dynamic_dbname}.hk_worder w WHERE YEARWEEK(DATE_FORMAT(w.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())) AS orderCount,
		(SELECT COUNT(0) FROM ${library.dynamic_dbname}.hk_worder w WHERE w.order_status = 4 AND YEARWEEK(DATE_FORMAT(w.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())) AS processedCount,
		(SELECT COUNT(0) FROM ${library.dynamic_dbname}.hk_worder w WHERE w.order_status = 1 AND YEARWEEK(DATE_FORMAT(w.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())) AS pendingCoutn,
		(SELECT COUNT(0) FROM ${library.dynamic_dbname}.hk_worder w WHERE w.order_status = 3 AND YEARWEEK(DATE_FORMAT(w.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())) AS hungCount
		FROM 
		${library.dynamic_dbname}.hk_worder
		GROUP BY orderCount) t1 RIGHT JOIN (SELECT 1) t2 ON 1=1
	</select>
	
	<!-- 获取工单后台首页,每周的及时处理率 -->
	<select id="getHTWorderByWeek" resultType="java.util.HashMap">
<!-- 		SELECT
		test1.x,
		IFNULL(ROUND((test2.testCount/test1.testCount)*100,'0'),'0') AS percent
		FROM
		(SELECT X,testCount FROM
		(SELECT *,SUM(countInfo1+countInfo2+countInfo3+countInfo4+countInfo5+countInfo6+countInfo7) AS testCount FROM 
		(SELECT 
		a.x,
		CASE WHEN a.x='周日' AND b.dayInfo>=d.fristDate AND b.dayInfo &lt;= e.lastDate-6  THEN b.devCount ELSE 0 END AS countInfo7,
		CASE WHEN a.x='周一' AND b.dayInfo>=d.fristDate+1 AND b.dayInfo &lt;= e.lastDate-5 THEN b.devCount ELSE 0 END AS countInfo1,
		CASE WHEN a.x='周二' AND b.dayInfo>=d.fristDate+2 AND b.dayInfo &lt;= e.lastDate-4 THEN b.devCount ELSE 0 END AS countInfo2,
		CASE WHEN a.x='周三' AND b.dayInfo>=d.fristDate+3 AND b.dayInfo &lt;= e.lastDate-3 THEN b.devCount ELSE 0 END AS countInfo3,
		CASE WHEN a.x='周四' AND b.dayInfo>=d.fristDate+4 AND b.dayInfo &lt;= e.lastDate-2 THEN b.devCount ELSE 0 END AS countInfo4,
		CASE WHEN a.x='周五' AND b.dayInfo>=d.fristDate+5 AND b.dayInfo &lt;= e.lastDate-1 THEN b.devCount ELSE 0 END AS countInfo5,
		CASE WHEN a.x='周六' AND b.dayInfo>=d.fristDate+6 AND b.dayInfo &lt;= e.lastDate  THEN b.devCount ELSE 0 END AS countInfo6
		FROM
		(
		SELECT 
		  timeInfo.`周日` AS X
		FROM
		  (
		  SELECT '周日'
		  UNION
		  SELECT '周一' UNION SELECT '周二' UNION SELECT '周三' 
		  UNION
		  SELECT '周四' UNION SELECT '周五' UNION SELECT '周六'  
		) timeInfo 
		 ) a
		LEFT JOIN (SELECT DATE_FORMAT(create_time, '%d') dayInfo,COUNT(w.id) AS devCount FROM ${library.dynamic_dbname}.hk_worder w WHERE YEARWEEK(DATE_FORMAT(w.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW()) GROUP BY dayInfo ORDER BY dayInfo ASC) b ON 1=1
		LEFT JOIN (SELECT DATE_FORMAT(DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) +1 DAY), '%d') AS fristDate FROM ${library.dynamic_dbname}.hk_worder w GROUP BY fristDate) d ON 1=1
		LEFT JOIN (SELECT DATE_FORMAT(DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) - 5 DAY), '%d') AS lastDate FROM ${library.dynamic_dbname}.hk_worder w GROUP BY lastDate) e ON 1=1
		) te
		GROUP BY X
		) test)test1
		LEFT JOIN
		(SELECT X,testCount FROM
		(SELECT *,SUM(countInfo1+countInfo2+countInfo3+countInfo4+countInfo5+countInfo6+countInfo7) AS testCount FROM 
		(SELECT 
		a.x,
		CASE WHEN a.x='周日' AND b.dayInfo>=d.fristDate AND b.dayInfo&lt;=e.lastDate-6  THEN b.devCount ELSE 0 END AS countInfo7,
		CASE WHEN a.x='周一' AND b.dayInfo>=d.fristDate+1 AND b.dayInfo&lt;=e.lastDate-5 THEN b.devCount ELSE 0 END AS countInfo1,
		CASE WHEN a.x='周二' AND b.dayInfo>=d.fristDate+2 AND b.dayInfo&lt;=e.lastDate-4 THEN b.devCount ELSE 0 END AS countInfo2,
		CASE WHEN a.x='周三' AND b.dayInfo>=d.fristDate+3 AND b.dayInfo&lt;=e.lastDate-3 THEN b.devCount ELSE 0 END AS countInfo3,
		CASE WHEN a.x='周四' AND b.dayInfo>=d.fristDate+4 AND b.dayInfo&lt;=e.lastDate-2 THEN b.devCount ELSE 0 END AS countInfo4,
		CASE WHEN a.x='周五' AND b.dayInfo>=d.fristDate+5 AND b.dayInfo&lt;=e.lastDate-1 THEN b.devCount ELSE 0 END AS countInfo5,
		CASE WHEN a.x='周六' AND b.dayInfo>=d.fristDate+6 AND b.dayInfo&lt;=e.lastDate  THEN b.devCount ELSE 0 END AS countInfo6
		FROM
		(
		SELECT 
		  timeInfo.`周日` AS X
		FROM
		  (
		  SELECT '周日'
		  UNION
		  SELECT '周一' UNION SELECT '周二' UNION SELECT '周三' 
		  UNION
		  SELECT '周四' UNION SELECT '周五' UNION SELECT '周六'  
		) timeInfo 
		 ) a
		LEFT JOIN (SELECT t1.* FROM(SELECT DATE_FORMAT(create_time, '%d') dayInfo,COUNT(w.id) AS devCount FROM ${library.dynamic_dbname}.hk_worder w WHERE w.order_status = 4 AND w.time_confine >= TIMESTAMPDIFF(MINUTE,w.`create_time`,w.`handle_end`) AND YEARWEEK(DATE_FORMAT(w.create_time,'%Y-%m-%d')) = YEARWEEK(NOW()) GROUP BY dayInfo ORDER BY dayInfo ASC)t1 RIGHT JOIN (SELECT 1) t2 ON 1=1) b ON 1=1
		LEFT JOIN (SELECT DATE_FORMAT(DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) +1 DAY), '%d') AS fristDate FROM ${library.dynamic_dbname}.hk_worder w GROUP BY fristDate) d ON 1=1
		LEFT JOIN (SELECT DATE_FORMAT(DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) - 5 DAY), '%d') AS lastDate FROM ${library.dynamic_dbname}.hk_worder w GROUP BY lastDate) e ON 1=1
		) test
		GROUP BY X
		) test)test2 ON test1.x = test2.x
		GROUP BY test1.x -->
		SELECT
		test1.x,
		IFNULL(ROUND((test2.testCount/test1.testCount)*100,'0'),'0') AS percent
		FROM
		(SELECT X,testCount FROM
		(SELECT *,SUM(countInfo1+countInfo2+countInfo3+countInfo4+countInfo5+countInfo6+countInfo7) AS testCount FROM 
		(SELECT 
		a.x,
		CASE WHEN a.x='周日' AND b.dayInfo>=DATE_FORMAT(d.fristDate,'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '6' DAY),'%d')  THEN b.devCount ELSE 0 END AS countInfo7,
		CASE WHEN a.x='周一' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 1 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '5' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo1,
		CASE WHEN a.x='周二' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 2 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '4' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo2,
		CASE WHEN a.x='周三' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 3 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '3' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo3,
		CASE WHEN a.x='周四' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 4 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '2' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo4,
		CASE WHEN a.x='周五' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 5 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '1' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo5,
		CASE WHEN a.x='周六' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 6 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(e.lastDate,'%d')  THEN b.devCount ELSE 0 END AS countInfo6
		FROM
		(
		SELECT 
		  timeInfo.`周日` AS X
		FROM
		  (
		  SELECT '周日'
		  UNION
		  SELECT '周一' UNION SELECT '周二' UNION SELECT '周三' 
		  UNION
		  SELECT '周四' UNION SELECT '周五' UNION SELECT '周六'  
		) timeInfo 
		 ) a
		LEFT JOIN (SELECT DATE_FORMAT(create_time, '%d') dayInfo,COUNT(w.id) AS devCount FROM ${library.dynamic_dbname}.hk_worder w WHERE YEARWEEK(DATE_FORMAT(w.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW()) GROUP BY dayInfo ORDER BY dayInfo ASC) b ON 1=1
		LEFT JOIN (SELECT DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) +1 DAY) AS fristDate FROM ${library.dynamic_dbname}.hk_worder w GROUP BY fristDate) d ON 1=1
		LEFT JOIN (SELECT DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) - 5 DAY) AS lastDate FROM ${library.dynamic_dbname}.hk_worder w GROUP BY lastDate) e ON 1=1
		) te
		GROUP BY X
		) test)test1
		LEFT JOIN
		(SELECT X,testCount FROM
		(SELECT *,SUM(countInfo1+countInfo2+countInfo3+countInfo4+countInfo5+countInfo6+countInfo7) AS testCount FROM 
		(SELECT 
		a.x,
		CASE WHEN a.x='周日' AND b.dayInfo>=DATE_FORMAT(d.fristDate,'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '6' DAY),'%d')  THEN b.devCount ELSE 0 END AS countInfo7,
		CASE WHEN a.x='周一' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 1 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '5' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo1,
		CASE WHEN a.x='周二' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 2 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '4' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo2,
		CASE WHEN a.x='周三' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 3 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '3' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo3,
		CASE WHEN a.x='周四' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 4 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '2' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo4,
		CASE WHEN a.x='周五' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 5 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(DATE_SUB(e.lastDate, INTERVAL '1' DAY),'%d') THEN b.devCount ELSE 0 END AS countInfo5,
		CASE WHEN a.x='周六' AND b.dayInfo>=DATE_FORMAT(DATE_ADD(d.fristDate,INTERVAL 6 DAY),'%d') AND b.dayInfo &lt;= DATE_FORMAT(e.lastDate,'%d')  THEN b.devCount ELSE 0 END AS countInfo6
		FROM
		(
		SELECT 
		  timeInfo.`周日` AS X
		FROM
		  (
		  SELECT '周日'
		  UNION
		  SELECT '周一' UNION SELECT '周二' UNION SELECT '周三' 
		  UNION
		  SELECT '周四' UNION SELECT '周五' UNION SELECT '周六'  
		) timeInfo 
		 ) a
		LEFT JOIN (SELECT t1.* FROM(SELECT DATE_FORMAT(create_time, '%d') dayInfo,COUNT(w.id) AS devCount FROM ${library.dynamic_dbname}.hk_worder w WHERE w.order_status = 4 AND w.time_confine >= TIMESTAMPDIFF(MINUTE,w.`create_time`,w.`handle_end`) AND YEARWEEK(DATE_FORMAT(w.create_time,'%Y-%m-%d')) = YEARWEEK(NOW()) GROUP BY dayInfo ORDER BY dayInfo ASC)t1 RIGHT JOIN (SELECT 1) t2 ON 1=1) b ON 1=1
		LEFT JOIN (SELECT DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) +1 DAY) AS fristDate FROM ${library.dynamic_dbname}.hk_worder w GROUP BY fristDate) d ON 1=1
		LEFT JOIN (SELECT DATE_SUB(CURDATE(),INTERVAL WEEKDAY(CURDATE()) - 5 DAY) AS lastDate FROM ${library.dynamic_dbname}.hk_worder w GROUP BY lastDate) e ON 1=1
		) test
		GROUP BY X
		) test)test2 ON test1.x = test2.x
		GROUP BY test1.x
	</select>
	
	<!-- 后台首页,报警,单独查出报警车辆的总数,及所占百分比 -->
	<select id="getHTAlarmCarCount" resultType="java.util.HashMap">
		SELECT 
		test.sourceTYpe,
		a.allCount,
		CONCAT(ROUND((a.allCount/b.countAll)*100,0),'','%' ) AS percent
		FROM
		(SELECT COUNT(1) AS allCount FROM ${lib.dynamic_dbname}.hk_alarm a WHERE a.`alarm_type` = 2 AND YEARWEEK(DATE_FORMAT(a.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())) a
		LEFT JOIN
		(SELECT
		CASE WHEN test.alarm_type = 1 THEN '车辆' END AS sourceType
		FROM
		(SELECT 1 AS alarm_type) test) test ON 1=1
		LEFT JOIN
		(SELECT a.alarmCount+e.eventCount AS countAll
		FROM
		(SELECT COUNT(1) AS alarmCount FROM ${lib.dynamic_dbname}.hk_alarm a WHERE YEARWEEK(DATE_FORMAT(a.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())) a
		LEFT JOIN
		(SELECT COUNT(1) AS eventCount FROM ${lib.dynamic_dbname}.hk_event e WHERE YEARWEEK(DATE_FORMAT(e.`create_time`,'%Y-%m-%d')) = YEARWEEK(NOW())) e ON 1=1
		) b ON 1=1
	</select>
	
	<!-- 报警总况,报警,单独查出报警车辆的总数 -->
	<select id="getAlarmTypeCar" resultType="java.util.HashMap">
		SELECT 
		test.sourceTYpe,
		a.allCount
		FROM
		(SELECT COUNT(1) AS allCount FROM ${lib.dynamic_dbname}.hk_alarm a WHERE a.`alarm_type` = 2 AND LAST_DAY(NOW()) >= a.`create_time` AND a.`create_time`>= CONCAT(DATE_FORMAT(LAST_DAY(NOW()),'%Y-%m-'),'01')) a
		LEFT JOIN
		(SELECT
		CASE WHEN test.alarm_type = 1 THEN '车辆' END AS sourceType
 		FROM
 		(SELECT 1 AS alarm_type) test) test ON 1=1
	
	</select>
	
	<select id="getEventRelationDev" resultType="java.util.HashMap">
		SELECT 
		  m.`module_name` AS module,
		  d.`mac`,
		  u.`real_name` AS responsibleName,
		  u.`telephone` AS responsibleTel,
		  d.`dev_address`,
		  d.`lon` AS lng,
		  d.`lat` 
		FROM
		  ${library.dynamic_dbname}.hk_device d 
		  LEFT JOIN hotcomm_community.`hk_device_module` m 
		    ON m.`id` = d.`module_id` 
		  LEFT JOIN hotcomm_community.`hk_sys_user` u 
		    ON u.`user_id` = d.`own_id` 
		WHERE d.`id` = #{id} 
	</select>
	
	<!-- 综合作业,工单列表,及时处理率,当日工单总数 -->
	<select id="getZYWorderList" resultType="com.hotcomm.community.common.bean.ui.process.worder.WorderZYOrderListUM">
		SELECT a.dateInfo, IFNULL(ROUND(b.devCount/c.allWorderCount*100,0),0) AS percent,IFNULL(c.allWorderCount,0) AS worderCount
		FROM
		(SELECT DATE_SUB(CURDATE(), INTERVAL @i := @i + 1 DAY) AS dateInfo
		  FROM 
		 (SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL 
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1 UNION ALL
		  SELECT 1)  tmp 
		  LEFT JOIN
		 (SELECT @i := - 1) t ON 1=1 ) a
		 LEFT JOIN (SELECT COUNT(w.`id`) AS devCount,DATE_FORMAT(w.`create_time`,'%Y-%m-%d') AS devTime FROM ${library.dynamic_dbname}.hk_worder w WHERE w.`order_status`=4 AND DATE(w.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY) AND w.time_confine >= TIMESTAMPDIFF(MINUTE,w.`create_time`,w.`handle_end`) GROUP BY devTime) b ON b.devTime = a.dateInfo
		 LEFT JOIN (SELECT COUNT(w.`id`) AS allWorderCount,DATE_FORMAT(w.`create_time`,'%Y-%m-%d') AS devTime FROM ${library.dynamic_dbname}.hk_worder w WHERE DATE(w.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY) GROUP BY devTime) c ON c.devTime = a.dateInfo
		 ORDER BY a.dateInfo
	</select>
	
	<!-- 综合作业,设备感知,按时间段统计(周一) -->
	<select id="getZYAlarmCountByMonday" resultType="com.hotcomm.community.common.bean.ui.process.alarm.AlarmZYGetTimeUM">
		SELECT a.alarmMonday,a.alarmMondayCount+e.eventMondayCount AS MondayCount
		FROM
		(SELECT t1.TheDate AS alarmMonday,COUNT(a.`id`) AS alarmMondayCount
		FROM 
		(SELECT * FROM ${library.dynamic_dbname}.hk_alarm a WHERE DATE_FORMAT(a.`create_time`,'%w')=1 AND DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) a 
		RIGHT JOIN 
		(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1 
		ON DATE_FORMAT(a.`create_time`, '%H') = t1.TheDate 
		GROUP BY t1.TheDate 
		ORDER BY t1.TheDate) a 	
		LEFT JOIN
		(SELECT t1.TheDate AS eventMonday,COUNT(e.`id`) AS eventMondayCount
		FROM 
		(SELECT * FROM ${library.dynamic_dbname}.hk_event e WHERE DATE_FORMAT(e.`event_htime`,'%w')=1 AND DATE(e.`event_htime`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) e 
		RIGHT JOIN 
		(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1 
		ON DATE_FORMAT(e.`event_htime`, '%H') = t1.TheDate 
		GROUP BY t1.TheDate 
		ORDER BY t1.TheDate) e 
		ON a.alarmMonday=e.eventMonday
		GROUP BY a.alarmMonday
	</select>
	
	<!-- 综合作业,设备感知,按时间段统计(周二) -->
	<select id="getZYAlarmCountByTuesday" resultType="com.hotcomm.community.common.bean.ui.process.alarm.AlarmZYGetTimeUM">
<!-- 		SELECT a.alarmMonday,a.alarmMondayCount+e.eventMondayCount AS MondayCount -->
<!-- 		FROM -->
<!-- 		(SELECT t1.TheDate AS alarmMonday,COUNT(a.`id`) AS alarmMondayCount -->
<!-- 		FROM  -->
<!-- 		(SELECT * FROM ${library.dynamic_dbname}.hk_alarm a WHERE DATE_FORMAT(a.`create_time`,'%w')=2 AND DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) a  -->
<!-- 		RIGHT JOIN  -->
<!-- 		(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1  -->
<!-- 		ON DATE_FORMAT(a.`create_time`, '%H') = t1.TheDate  -->
<!-- 		GROUP BY t1.TheDate  -->
<!-- 		ORDER BY t1.TheDate) a 	 -->
<!-- 		LEFT JOIN -->
<!-- 		(SELECT t1.TheDate AS eventTuesday,COUNT(e.`id`) AS eventMondayCount -->
<!-- 		FROM  -->
<!-- 		(SELECT * FROM ${library.dynamic_dbname}.hk_event e WHERE DATE_FORMAT(e.`event_htime`,'%w')=2 AND DATE(e.`event_htime`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) e  -->
<!-- 		RIGHT JOIN  -->
<!-- 		(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1  -->
<!-- 		ON DATE_FORMAT(e.`event_htime`, '%H') = t1.TheDate  -->
<!-- 		GROUP BY t1.TheDate  -->
<!-- 		ORDER BY t1.TheDate) e  -->
<!-- 		ON a.alarmTuesday=e.eventTuesday -->
<!-- 		GROUP BY a.alarmTuesday -->
			SELECT a.alarmMonday,a.alarmMondayCount+e.eventMondayCount AS MondayCount
			FROM
			(SELECT t1.TheDate AS alarmMonday,COUNT(a.`id`) AS alarmMondayCount
			FROM 
			(SELECT * FROM ${library.dynamic_dbname}.hk_alarm a WHERE DATE_FORMAT(a.`create_time`,'%w')=2 AND DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) a 
			RIGHT JOIN 
			(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1 
			ON DATE_FORMAT(a.`create_time`, '%H') = t1.TheDate 
			GROUP BY t1.TheDate 
			ORDER BY t1.TheDate) a 	
			LEFT JOIN
			(SELECT t1.TheDate AS eventMonday,COUNT(e.`id`) AS eventMondayCount
			FROM 
			(SELECT * FROM ${library.dynamic_dbname}.hk_event e WHERE DATE_FORMAT(e.`event_htime`,'%w')=2 AND DATE(e.`event_htime`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) e 
			RIGHT JOIN 
			(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1 
			ON DATE_FORMAT(e.`event_htime`, '%H') = t1.TheDate 
			GROUP BY t1.TheDate 
			ORDER BY t1.TheDate) e 
			ON a.alarmMonday=e.eventMonday
			GROUP BY a.alarmMonday
	</select>
	
	<!-- 综合作业,设备感知,按时间段统计(周三) -->
	<select id="getZYAlarmCountByWednesday" resultType="com.hotcomm.community.common.bean.ui.process.alarm.AlarmZYGetTimeUM">
<!-- 		SELECT a.alarmWednesday,a.alarmWednesdayCount+e.eventWednesdayCount AS WednesdayCount -->
<!-- 		FROM -->
<!-- 		(SELECT t1.TheDate AS alarmWednesday,COUNT(a.`id`) AS alarmWednesdayCount -->
<!-- 		FROM  -->
<!-- 		(SELECT * FROM ${library.dynamic_dbname}.hk_alarm a WHERE DATE_FORMAT(a.`create_time`,'%w')=3 AND DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) a  -->
<!-- 		RIGHT JOIN  -->
<!-- 		(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1  -->
<!-- 		ON DATE_FORMAT(a.`create_time`, '%H') = t1.TheDate  -->
<!-- 		GROUP BY t1.TheDate  -->
<!-- 		ORDER BY t1.TheDate) a 	 -->
<!-- 		LEFT JOIN -->
<!-- 		(SELECT t1.TheDate AS eventWednesday,COUNT(e.`id`) AS eventWednesdayCount -->
<!-- 		FROM  -->
<!-- 		(SELECT * FROM ${library.dynamic_dbname}.hk_event e WHERE DATE_FORMAT(e.`event_htime`,'%w')=3 AND DATE(e.`event_htime`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) e  -->
<!-- 		RIGHT JOIN  -->
<!-- 		(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1  -->
<!-- 		ON DATE_FORMAT(e.`event_htime`, '%H') = t1.TheDate  -->
<!-- 		GROUP BY t1.TheDate  -->
<!-- 		ORDER BY t1.TheDate) e  -->
<!-- 		ON a.alarmWednesday=e.eventWednesday -->
<!-- 		GROUP BY a.alarmWednesday -->
			SELECT a.alarmMonday,a.alarmMondayCount+e.eventMondayCount AS MondayCount
			FROM
			(SELECT t1.TheDate AS alarmMonday,COUNT(a.`id`) AS alarmMondayCount
			FROM 
			(SELECT * FROM ${library.dynamic_dbname}.hk_alarm a WHERE DATE_FORMAT(a.`create_time`,'%w')=3 AND DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) a 
			RIGHT JOIN 
			(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1 
			ON DATE_FORMAT(a.`create_time`, '%H') = t1.TheDate 
			GROUP BY t1.TheDate 
			ORDER BY t1.TheDate) a 	
			LEFT JOIN
			(SELECT t1.TheDate AS eventMonday,COUNT(e.`id`) AS eventMondayCount
			FROM 
			(SELECT * FROM ${library.dynamic_dbname}.hk_event e WHERE DATE_FORMAT(e.`event_htime`,'%w')=3 AND DATE(e.`event_htime`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) e 
			RIGHT JOIN 
			(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1 
			ON DATE_FORMAT(e.`event_htime`, '%H') = t1.TheDate 
			GROUP BY t1.TheDate 
			ORDER BY t1.TheDate) e 
			ON a.alarmMonday=e.eventMonday
			GROUP BY a.alarmMonday
	</select>
	
	<!-- 综合作业,设备感知,按时间段统计(周四) -->
	<select id="getZYAlarmCountByThursday" resultType="com.hotcomm.community.common.bean.ui.process.alarm.AlarmZYGetTimeUM">
<!-- 		SELECT a.alarmThursday,a.alarmThursdayCount+e.eventThursdayCount AS ThursdayCount -->
<!-- 		FROM -->
<!-- 		(SELECT t1.TheDate AS alarmThursday,COUNT(a.`id`) AS alarmThursdayCount -->
<!-- 		FROM  -->
<!-- 		(SELECT * FROM ${library.dynamic_dbname}.hk_alarm a WHERE DATE_FORMAT(a.`create_time`,'%w')=4 AND DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) a  -->
<!-- 		RIGHT JOIN  -->
<!-- 		(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1  -->
<!-- 		ON DATE_FORMAT(a.`create_time`, '%H') = t1.TheDate  -->
<!-- 		GROUP BY t1.TheDate  -->
<!-- 		ORDER BY t1.TheDate) a 	 -->
<!-- 		LEFT JOIN -->
<!-- 		(SELECT t1.TheDate AS eventThursday,COUNT(e.`id`) AS eventThursdayCount -->
<!-- 		FROM  -->
<!-- 		(SELECT * FROM ${library.dynamic_dbname}.hk_event e WHERE DATE_FORMAT(e.`event_htime`,'%w')=4 AND DATE(e.`event_htime`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) e  -->
<!-- 		RIGHT JOIN  -->
<!-- 		(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1  -->
<!-- 		ON DATE_FORMAT(e.`event_htime`, '%H') = t1.TheDate  -->
<!-- 		GROUP BY t1.TheDate  -->
<!-- 		ORDER BY t1.TheDate) e  -->
<!-- 		ON a.alarmThursday=e.eventThursday -->
<!-- 		GROUP BY a.alarmThursday -->
			SELECT a.alarmMonday,a.alarmMondayCount+e.eventMondayCount AS MondayCount
			FROM
			(SELECT t1.TheDate AS alarmMonday,COUNT(a.`id`) AS alarmMondayCount
			FROM 
			(SELECT * FROM ${library.dynamic_dbname}.hk_alarm a WHERE DATE_FORMAT(a.`create_time`,'%w')=4 AND DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) a 
			RIGHT JOIN 
			(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1 
			ON DATE_FORMAT(a.`create_time`, '%H') = t1.TheDate 
			GROUP BY t1.TheDate 
			ORDER BY t1.TheDate) a 	
			LEFT JOIN
			(SELECT t1.TheDate AS eventMonday,COUNT(e.`id`) AS eventMondayCount
			FROM 
			(SELECT * FROM ${library.dynamic_dbname}.hk_event e WHERE DATE_FORMAT(e.`event_htime`,'%w')=4 AND DATE(e.`event_htime`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) e 
			RIGHT JOIN 
			(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1 
			ON DATE_FORMAT(e.`event_htime`, '%H') = t1.TheDate 
			GROUP BY t1.TheDate 
			ORDER BY t1.TheDate) e 
			ON a.alarmMonday=e.eventMonday
			GROUP BY a.alarmMonday
	</select>
	
	<!-- 综合作业,设备感知,按时间段统计(周五) -->
	<select id="getZYAlarmCountByFriday" resultType="com.hotcomm.community.common.bean.ui.process.alarm.AlarmZYGetTimeUM">
<!-- 		SELECT a.alarmFriday,a.alarmFridayCount+e.eventFridayCount AS FridayCount -->
<!-- 		FROM -->
<!-- 		(SELECT t1.TheDate AS alarmFriday,COUNT(a.`id`) AS alarmFridayCount -->
<!-- 		FROM  -->
<!-- 		(SELECT * FROM ${library.dynamic_dbname}.hk_alarm a WHERE DATE_FORMAT(a.`create_time`,'%w')=5 AND DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) a  -->
<!-- 		RIGHT JOIN  -->
<!-- 		(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1  -->
<!-- 		ON DATE_FORMAT(a.`create_time`, '%H') = t1.TheDate  -->
<!-- 		GROUP BY t1.TheDate  -->
<!-- 		ORDER BY t1.TheDate) a 	 -->
<!-- 		LEFT JOIN -->
<!-- 		(SELECT t1.TheDate AS eventFriday,COUNT(e.`id`) AS eventFridayCount -->
<!-- 		FROM  -->
<!-- 		(SELECT * FROM ${library.dynamic_dbname}.hk_event e WHERE DATE_FORMAT(e.`event_htime`,'%w')=5 AND DATE(e.`event_htime`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) e  -->
<!-- 		RIGHT JOIN  -->
<!-- 		(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1  -->
<!-- 		ON DATE_FORMAT(e.`event_htime`, '%H') = t1.TheDate  -->
<!-- 		GROUP BY t1.TheDate  -->
<!-- 		ORDER BY t1.TheDate) e  -->
<!-- 		ON a.alarmFriday=e.eventFriday -->
<!-- 		GROUP BY a.alarmFriday 	 -->
			SELECT a.alarmMonday,a.alarmMondayCount+e.eventMondayCount AS MondayCount
			FROM
			(SELECT t1.TheDate AS alarmMonday,COUNT(a.`id`) AS alarmMondayCount
			FROM 
			(SELECT * FROM ${library.dynamic_dbname}.hk_alarm a WHERE DATE_FORMAT(a.`create_time`,'%w')=5 AND DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) a 
			RIGHT JOIN 
			(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1 
			ON DATE_FORMAT(a.`create_time`, '%H') = t1.TheDate 
			GROUP BY t1.TheDate 
			ORDER BY t1.TheDate) a 	
			LEFT JOIN
			(SELECT t1.TheDate AS eventMonday,COUNT(e.`id`) AS eventMondayCount
			FROM 
			(SELECT * FROM ${library.dynamic_dbname}.hk_event e WHERE DATE_FORMAT(e.`event_htime`,'%w')=5 AND DATE(e.`event_htime`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) e 
			RIGHT JOIN 
			(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1 
			ON DATE_FORMAT(e.`event_htime`, '%H') = t1.TheDate 
			GROUP BY t1.TheDate 
			ORDER BY t1.TheDate) e 
			ON a.alarmMonday=e.eventMonday
			GROUP BY a.alarmMonday
	</select>
	
	<!-- 综合作业,设备感知,按时间段统计(周六) -->
	<select id="getZYAlarmCountBySaturday" resultType="com.hotcomm.community.common.bean.ui.process.alarm.AlarmZYGetTimeUM">
<!-- 		SELECT a.alarmSaturday,a.alarmSaturdayCount+e.eventSaturdayCount AS SaturdayCount -->
<!-- 		FROM -->
<!-- 		(SELECT t1.TheDate AS alarmSaturday,COUNT(a.`id`) AS alarmSaturdayCount -->
<!-- 		FROM  -->
<!-- 		(SELECT * FROM ${library.dynamic_dbname}.hk_alarm a WHERE DATE_FORMAT(a.`create_time`,'%w')=6 AND DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) a  -->
<!-- 		RIGHT JOIN  -->
<!-- 		(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1  -->
<!-- 		ON DATE_FORMAT(a.`create_time`, '%H') = t1.TheDate  -->
<!-- 		GROUP BY t1.TheDate  -->
<!-- 		ORDER BY t1.TheDate) a 	 -->
<!-- 		LEFT JOIN -->
<!-- 		(SELECT t1.TheDate AS eventSaturday,COUNT(e.`id`) AS eventSaturdayCount -->
<!-- 		FROM  -->
<!-- 		(SELECT * FROM ${library.dynamic_dbname}.hk_event e WHERE DATE_FORMAT(e.`event_htime`,'%w')=6 AND DATE(e.`event_htime`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) e  -->
<!-- 		RIGHT JOIN  -->
<!-- 		(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1  -->
<!-- 		ON DATE_FORMAT(e.`event_htime`, '%H') = t1.TheDate  -->
<!-- 		GROUP BY t1.TheDate  -->
<!-- 		ORDER BY t1.TheDate) e  -->
<!-- 		ON a.alarmSaturday=e.eventSaturday -->
<!-- 		GROUP BY a.alarmSaturday -->
			SELECT a.alarmMonday,a.alarmMondayCount+e.eventMondayCount AS MondayCount
			FROM
			(SELECT t1.TheDate AS alarmMonday,COUNT(a.`id`) AS alarmMondayCount
			FROM 
			(SELECT * FROM ${library.dynamic_dbname}.hk_alarm a WHERE DATE_FORMAT(a.`create_time`,'%w')=1 AND DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) a 
			RIGHT JOIN 
			(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1 
			ON DATE_FORMAT(a.`create_time`, '%H') = t1.TheDate 
			GROUP BY t1.TheDate 
			ORDER BY t1.TheDate) a 	
			LEFT JOIN
			(SELECT t1.TheDate AS eventMonday,COUNT(e.`id`) AS eventMondayCount
			FROM 
			(SELECT * FROM ${library.dynamic_dbname}.hk_event e WHERE DATE_FORMAT(e.`event_htime`,'%w')=1 AND DATE(e.`event_htime`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) e 
			RIGHT JOIN 
			(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1 
			ON DATE_FORMAT(e.`event_htime`, '%H') = t1.TheDate 
			GROUP BY t1.TheDate 
			ORDER BY t1.TheDate) e 
			ON a.alarmMonday=e.eventMonday
			GROUP BY a.alarmMonday
	</select>
	
	<!-- 综合作业,设备感知,按时间段统计(周日) -->
	<select id="getZYAlarmCountBySunday" resultType="com.hotcomm.community.common.bean.ui.process.alarm.AlarmZYGetTimeUM">
<!-- 		SELECT a.alarmSunday,a.alarmSundayCount+e.eventSundayCount AS SundayCount -->
<!-- 		FROM -->
<!-- 		(SELECT t1.TheDate AS alarmSunday,COUNT(a.`id`) AS alarmSundayCount -->
<!-- 		FROM  -->
<!-- 		(SELECT * FROM ${library.dynamic_dbname}.hk_alarm a WHERE DATE_FORMAT(a.`create_time`,'%w')=0 AND DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) a  -->
<!-- 		RIGHT JOIN  -->
<!-- 		(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1  -->
<!-- 		ON DATE_FORMAT(a.`create_time`, '%H') = t1.TheDate  -->
<!-- 		GROUP BY t1.TheDate  -->
<!-- 		ORDER BY t1.TheDate) a 	 -->
<!-- 		LEFT JOIN -->
<!-- 		(SELECT t1.TheDate AS eventSunday,COUNT(e.`id`) AS eventSundayCount -->
<!-- 		FROM  -->
<!-- 		(SELECT * FROM ${library.dynamic_dbname}.hk_event e WHERE DATE_FORMAT(e.`event_htime`,'%w')=0 AND DATE(e.`event_htime`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) e  -->
<!-- 		RIGHT JOIN  -->
<!-- 		(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1  -->
<!-- 		ON DATE_FORMAT(e.`event_htime`, '%H') = t1.TheDate  -->
<!-- 		GROUP BY t1.TheDate  -->
<!-- 		ORDER BY t1.TheDate) e  -->
<!-- 		ON a.alarmSunday=e.eventSunday -->
<!-- 		GROUP BY a.alarmSunday	 -->
			SELECT a.alarmMonday,a.alarmMondayCount+e.eventMondayCount AS MondayCount
			FROM
			(SELECT t1.TheDate AS alarmMonday,COUNT(a.`id`) AS alarmMondayCount
			FROM 
			(SELECT * FROM ${library.dynamic_dbname}.hk_alarm a WHERE DATE_FORMAT(a.`create_time`,'%w')=0 AND DATE(a.`create_time`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) a 
			RIGHT JOIN 
			(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1 
			ON DATE_FORMAT(a.`create_time`, '%H') = t1.TheDate 
			GROUP BY t1.TheDate 
			ORDER BY t1.TheDate) a 	
			LEFT JOIN
			(SELECT t1.TheDate AS eventMonday,COUNT(e.`id`) AS eventMondayCount
			FROM 
			(SELECT * FROM ${library.dynamic_dbname}.hk_event e WHERE DATE_FORMAT(e.`event_htime`,'%w')=0 AND DATE(e.`event_htime`)>=DATE_SUB(CURDATE(), INTERVAL 7 DAY)) e 
			RIGHT JOIN 
			(SELECT DATE_FORMAT((ADDDATE(CURDATE(), INTERVAL @d HOUR)),'%H') AS TheDate,@d := @d + 1 HOUR FROM hotcomm_community.hk_diction, (SELECT @d := 0) temp LIMIT 24) t1 
			ON DATE_FORMAT(e.`event_htime`, '%H') = t1.TheDate 
			GROUP BY t1.TheDate 
			ORDER BY t1.TheDate) e 
			ON a.alarmMonday=e.eventMonday
			GROUP BY a.alarmMonday
	</select>
	
	<!-- 综合作业,累计报警,今日报警,未处理报警,未处理工单,超时工单 -->
	<select id="getZYAllCount" resultType="java.util.HashMap">
		SELECT
		((SELECT COUNT(a.`id`) AS alarmCount FROM ${library.dynamic_dbname}.hk_alarm a)+(SELECT COUNT(e.`id`) AS eventCount FROM ${library.dynamic_dbname}.hk_event e)) AS allCount,
		((SELECT COUNT(a.`id`) AS todayAlarmCount FROM ${library.dynamic_dbname}.hk_alarm a WHERE DATEDIFF(a.`create_time`,NOW())=0)+(SELECT COUNT(e.`id`) AS todayEventCount FROM ${library.dynamic_dbname}.hk_event e WHERE DATEDIFF(e.`create_time`,NOW())=0)) AS todayAlarmCount,
		((SELECT COUNT(a.`id`) AS notDeal FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`handel_state`=0)+(SELECT COUNT(e.`id`) AS notDeal FROM ${library.dynamic_dbname}.hk_event e WHERE e.`event_status`=0)) AS notDealAlarmCount,
		(SELECT COUNT(w.`id`) AS notDealWorder FROM ${library.dynamic_dbname}.hk_worder w WHERE w.`order_status` = 1) AS notDealWorder,
		(SELECT COUNT(w.`id`) AS overTimeWorder FROM ${library.dynamic_dbname}.hk_worder w WHERE TIMESTAMPDIFF(MINUTE,w.`create_time`,w.`handle_end`) > w.`time_confine`) overTimeWorder
		FROM ${library.dynamic_dbname}.hk_alarm a
		GROUP BY allCount
	</select>
	
	<!-- 态势分析,实时报警 -->
	<select id="getSTRealTimeAlerts" resultType="java.util.HashMap">
<!-- 		SELECT  -->
<!-- 		a.`module_id` AS typeNo, -->
<!-- 		d.`dev_type` AS alarmtype, -->
<!-- 		a.`alarm_address` AS address, -->
<!-- 		a.`alarm_message` AS alarmMessage, -->
<!-- 		a.`alarm_level` AS alarmValue  -->
<!-- 		FROM ${library.dynamic_dbname}.hk_alarm a  -->
<!-- 		LEFT JOIN ${library.dynamic_dbname}.hk_device d ON d.`id` = a.`alarm_source_id`  -->
<!-- 		LEFT JOIN hotcomm_community.`hk_device_module` dm ON dm.`id` = a.`module_id` WHERE a.`alarm_type` = 1 AND DATEDIFF(a.`create_time`,NOW())=0 -->
			
<!-- 			SELECT * -->
<!-- 			FROM		 -->
<!-- 			(SELECT  -->
<!-- 			a.`id` AS alarmDevId, -->
<!-- 			a.`alarm_type` AS alarmDeviceType, -->
<!-- 			a.`module_id` AS typeNoDev, -->
<!-- 			d.`dev_type` AS alarmDevtype, -->
<!-- 			a.`alarm_address` AS addressDev, -->
<!-- 			a.`alarm_message` AS alarmDevMessage, -->
<!-- 			a.`alarm_level` AS alarDevmLevel  -->
<!-- 			FROM ${library.dynamic_dbname}.hk_alarm a  -->
<!-- 			LEFT JOIN ${library.dynamic_dbname}.hk_device d ON d.`id` = a.`alarm_source_id`  -->
<!-- 			LEFT JOIN hotcomm_community.`hk_device_module` dm ON dm.`id` = a.`module_id` WHERE a.`alarm_type` = 1) a -->
<!-- 			LEFT JOIN  -->
<!-- 			( -->
<!-- 			SELECT  -->
<!-- 			a.`id` AS alarmId, -->
<!-- 			a.`alarm_type` AS alarmType, -->
<!-- 			a.`alarm_source` AS alarmSource,  -->
<!-- 			a.`alarm_address` AS alarmAddress, -->
<!-- 			a.`alarm_message` AS alarmMessage -->
<!-- 			,a.`alarm_level` AS alarmLevel,  -->
<!-- 			REPLACE(REPLACE(REPLACE(REPLACE(JSON_EXTRACT(a.alarm_view,'$.pendingView.img[*].url'),'[',''),']',''),'"',''),' ','') AS alarmImg -->
<!-- 			FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`alarm_type` !=1  ) b ON 1=1 -->
		SELECT 
		a.`id` AS alarmId,
		case when a.alarm_type=3 then IFNULL(a.alarm_nature_of_vehicle,'') else a.`alarm_nature_of_person` end AS alarmSourceId,
<!-- 		a.`alarm_type` AS alarmType, -->
<!-- 		1 as alarmType, -->
		CONCAT(a.`alarm_type`,'') AS alarmType,
		a.`module_id` AS typeNo,
		d.`dev_type` AS alarmDevtype,
		a.`alarm_source` AS alarmSource,
		a.`alarm_address` AS address,
		a.`alarm_message` AS alarmMessage,
		a.`alarm_level` AS alarmLevel,
		REPLACE(REPLACE(REPLACE(REPLACE(JSON_EXTRACT(a.alarm_view,'$.pendingView.img[*].url'),'[',''),']',''),'"',''),' ','') AS alarmImg
		FROM ${library.dynamic_dbname}.hk_alarm a
		LEFT JOIN ${library.dynamic_dbname}.hk_device d ON d.`id` = a.`alarm_source_id` 
		LEFT JOIN hotcomm_community.`hk_device_module` dm ON dm.`id` = a.`module_id`
		order by a.create_time desc
	</select>
	
	<!-- 态势分析,总报警,一级报警,处理及时率 -->
	<select id="getSTAlarmAllCount" resultType="java.util.HashMap">
		SELECT
		(SELECT COUNT(*) AS alarmCount FROM ${library.dynamic_dbname}.hk_alarm ) AS alarmCount, 
		(SELECT COUNT(*) AS alarmLevel FROM ${library.dynamic_dbname}.hk_alarm a WHERE a.`alarm_level` = 1) AS alarmLevel,
		ROUND((SELECT COUNT(*) FROM ${library.dynamic_dbname}.hk_alarm a LEFT JOIN ${library.dynamic_dbname}.hk_worder w ON w.`order_no` = a.`worder_no` WHERE w.time_confine >= TIMESTAMPDIFF(MINUTE,w.`create_time`,w.`handle_end`))/(SELECT COUNT(*) AS alarmCount FROM ${library.dynamic_dbname}.hk_alarm)*100,0) AS dealAlarm
		FROM ${library.dynamic_dbname}.hk_alarm
		GROUP BY alarmCount
	</select>

<select id="getDevAlarmInfoForFont" resultType="java.util.HashMap">
		SELECT 
		  a.`id`,
<!-- 		  a.`alarm_message`, -->
IFNULL(s.state_name,a.alarm_message) AS alarm_message,
		  CASE
		    WHEN a.handel_state = 0 
		    THEN '未处理' 
		    WHEN a.handel_state = 1 
		    OR (
		      a.handel_state = 3 
		      AND a.wor_id IS NULL
		    ) 
		    THEN '处理中' 
		    WHEN a.handel_state = 3 
		    AND a.wor_id IS NOT NULL 
		    THEN '需转工单' 
		  END AS handleState ,
		  a.create_time AS alarmTime,
		  a.alarm_address AS alarmAddress,
		  IFNULL(CONCAT(u.real_name),'') AS handlerName,
		  IFNULL(CONCAT(u.telephone),'') AS handleTel,
		  REPLACE(REPLACE(REPLACE(REPLACE(JSON_EXTRACT(d.video_list,'$.video'),'"',''),'[',''),']',''),' ','') AS relationVideo,
		  b.building_name AS buildingName,
		  d.lon AS lng,
		  d.lat AS lat 
		FROM
		  ${library.dynamic_dbname}.hk_alarm a 
		  LEFT JOIN hotcomm_community.`hk_alarm_state` s ON a.alarm_source_type=s.id
		  LEFT JOIN ${library.dynamic_dbname}.hk_device d ON d.id=a.alarm_source_id
		  LEFT JOIN ${library.dynamic_dbname}.hk_device_alarm_gz g ON g.alarm_mac = d.mac
		  LEFT JOIN hotcomm_community.`hk_sys_user` u ON u.user_id IN (JSON_EXTRACT(g.inform_userid,'$.user'))
		  LEFT JOIN ${library.dynamic_dbname}.hk_building b ON b.building_name AND d.building_num
		WHERE DATE_FORMAT(NOW(), '%m-%d-%Y') = DATE_FORMAT(a.`create_time`, '%m-%d-%Y') 
		  AND a.handel_state IN (0, 1, 3) AND a.alarm_type=1
		  AND a.module_id IN (${moduleId})
		  GROUP BY a.id
	</select>
	
	<select id="getPersonAlarmInfoForFontWork" resultType="java.util.HashMap">
		SELECT 
		  a.`id`,
		  a.`alarm_message`,
		  CASE
		    WHEN a.handel_state = 0 
		    THEN '未处理' 
		    WHEN a.handel_state = 1 
		    OR (
		      a.handel_state = 3 
		      AND a.wor_id IS NULL
		    ) 
		    THEN '处理中' 
		    WHEN a.handel_state = 3 
		    AND a.wor_id IS NOT NULL 
		    THEN '需转工单' 
		  END AS handleState ,
		  a.create_time AS alarmTime,
		  a.alarm_address AS alarmAddress,
		  IFNULL(CONCAT(u.real_name),'') AS handlerName,
		  IFNULL(CONCAT(u.telephone),'') AS handleTel,
		  a.lng AS lng,
		  a.lat AS lat ,
		  a.alarm_source AS alarmPerson,
		  REPLACE(REPLACE(REPLACE(REPLACE(JSON_EXTRACT(a.alarm_view,'$.pendingView.img[*].url'),'[',''),']',''),'"',''),' ','') AS alarmImg,
  		  REPLACE(REPLACE(REPLACE(REPLACE(JSON_EXTRACT(a.alarm_view,'$.pendingView.video[*].url'),'[',''),']',''),'"',''),' ','') AS alarmVideo
		FROM
		  ${library.dynamic_dbname}.hk_alarm a 
		  LEFT JOIN hotcomm_community.`hk_sys_user` u ON u.user_id IN (REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(JSON_EXTRACT(a.handel_user,'$.user'),'id',''),'"',''),': ',''),'{',''),'}',''),' ',''),'[',''),']',''))
		  left join ${library.dynamic_dbname}.hk_person_lable l on l.id=a.alarm_source_type
		WHERE DATE_FORMAT(NOW(), '%m-%d-%Y') = DATE_FORMAT(a.`create_time`, '%m-%d-%Y') 
		  AND a.handel_state IN (0, 1, 3) AND a.alarm_type=3
		  and FIND_IN_SET (l.type_code,#{alarmSource})
		  GROUP BY a.id
	</select>
	
	<select id="getCarAlarmInfoForFontWork" resultType="java.util.HashMap">
		SELECT 
		  a.`id`,
		  a.`alarm_message`,
		  CASE
		    WHEN a.handel_state = 0 
		    THEN '未处理' 
		    WHEN a.handel_state = 1 
		    OR (
		      a.handel_state = 3 
		      AND a.wor_id IS NULL
		    ) 
		    THEN '处理中' 
		    WHEN a.handel_state = 3 
		    AND a.wor_id IS NOT NULL 
		    THEN '需转工单' 
		  END AS handleState ,
		  a.create_time AS alarmTime,
		  a.alarm_address AS alarmAddress,
		  IFNULL(CONCAT(u.real_name),'') AS handlerName,
		  IFNULL(CONCAT(u.telephone),'') AS handleTel,
		  a.lng AS lng,
		  a.lat AS lat ,
		  a.alarm_source AS alarmPerson,
		  IFNULL(REPLACE(REPLACE(REPLACE(REPLACE(JSON_EXTRACT(a.alarm_view,'$.pendingView.img[*].url'),'[',''),']',''),'"',''),' ',''),'') AS alarmImg,
		  IFNULL(REPLACE(REPLACE(REPLACE(REPLACE(JSON_EXTRACT(a.alarm_view,'$.pendingView.video[*].url'),'[',''),']',''),'"',''),' ',''),'') AS alarmVideo
		FROM
		  ${library.dynamic_dbname}.hk_alarm a 
		  LEFT JOIN hotcomm_community.`hk_sys_user` u ON u.user_id IN (REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(JSON_EXTRACT(a.handel_user,'$.user'),'id',''),'"',''),': ',''),'{',''),'}',''),' ',''),'[',''),']',''))
		WHERE DATE_FORMAT(NOW(), '%m-%d-%Y') = DATE_FORMAT(a.`create_time`, '%m-%d-%Y') 
		  AND a.handel_state IN (0, 1, 3) 
		  AND a.alarm_type=2
		  GROUP BY a.id
	</select> 

		<select id="getOtherAlarmInfoForFontWork" resultType="java.util.HashMap">
			SELECT 
			  e.`id`,
			  CASE
			    WHEN e.time_confine = 60 
			    OR e.time_confine = 480 
			    OR e.time_confine = 1440 
			    THEN 1 
			    WHEN e.time_confine = 4320 
			    THEN 2 
			    ELSE 3 
			  END AS eventLevel,
			  CASE
			    WHEN e.event_status = 0 
			    THEN '未处理' 
			    WHEN e.event_status = 1 
			    THEN '已转工单' 
			    WHEN e.event_status = 2 
			    THEN '处理中' 
			  END AS eventState,
			  CASE
			    WHEN e.event_type = 1 
			    THEN '设备' 
			    WHEN e.event_type = 2 
			    THEN '户政' 
			    WHEN e.event_type = 3 
			    THEN '消防' 
			    WHEN e.event_type = 4 
			    THEN '治安' 
			    WHEN e.event_type = 5 
			    THEN '刑事' 
			    WHEN e.event_type = 6 
			    THEN '交通' 
			    WHEN e.event_type = 7 
			    THEN '生产安全' 
			    WHEN e.event_type = 8 
			    THEN '其他' 
			  END AS eventType,
			  e.event_title AS eventMessage ,
			  e.event_address AS eventAddress,
			  e.lng AS lng,
			  e.lat AS lat,
			  u.real_name AS handlerName,
			  e.create_time AS reportTime
			FROM
			  ${library.dynamic_dbname}.hk_event e 
			  LEFT JOIN hotcomm_community.`hk_sys_user` u ON e.handle_user_id=u.user_id
			WHERE DATE_FORMAT(NOW(), '%m-%d-%Y') = DATE_FORMAT(e.`create_time`, '%m-%d-%Y') 
			  AND e.event_status IN (0, 1, 2)
		</select>
		
		<select id="getHeatPointInfo" resultType="java.util.HashMap">
<!-- 			SELECT  -->
<!-- 			  a.`lng` AS lng, -->
<!-- 			  a.`lat` AS lat  -->
<!-- 			FROM -->
<!-- 			  ${library.dynamic_dbname}.hk_alarm a  -->
<!-- 			WHERE DATE_FORMAT(NOW(), '%m-%d-%Y') = DATE_FORMAT(a.`create_time`, '%m-%d-%Y')  -->
<!-- 			  AND a.`handel_state` IN (2, 4)  -->
<!-- 			UNION -->
<!-- 			(SELECT  -->
<!-- 			  e.`lng` lng, -->
<!-- 			  e.`lat` lat  -->
<!-- 			FROM -->
<!-- 			  ${library.dynamic_dbname}.hk_event e  -->
<!-- 			WHERE DATE_FORMAT(NOW(), '%m-%d-%Y') = DATE_FORMAT(e.`create_time`, '%m-%d-%Y')  -->
<!-- 			  AND e.`event_status` = 1) -->
SELECT 
  w.`lng`,
  w.`lat` ,count(0) as countInfo
FROM
  ${library.dynamic_dbname}.hk_worder w 
WHERE DATE_FORMAT(NOW(), '%m-%d-%Y') = DATE_FORMAT(w.`create_time`, '%m-%d-%Y') 
  AND w.`order_status` = 4 
  GROUP BY w.`lng`,w.`lat`
		</select>
		
		<select id="getWorderInfoForFontWork" resultType="java.util.HashMap">
<!-- 				SELECT  -->
<!-- 				  *  -->
<!-- 				FROM -->
<!-- 				  (SELECT  -->
<!-- 				    w.`id` id, -->
<!-- 				    w.`order_title` orderTitle, -->
<!-- 				    CASE -->
<!-- 				      WHEN w.order_status = 1  -->
<!-- 				      THEN '未处理'  -->
<!-- 				      WHEN w.order_status = 2  -->
<!-- 				      THEN '处理中'  -->
<!-- 				      WHEN w.order_status = 3  -->
<!-- 				      THEN '挂起'  -->
<!-- 				    END AS orderState, -->
<!-- 				    CONCAT(u.real_name, ' ', u.telephone) AS handlerInfo, -->
<!-- 				    CASE -->
<!-- 				      WHEN w.time_confine = 60  -->
<!-- 				      THEN '一小时'  -->
<!-- 				      WHEN w.time_confine = 480  -->
<!-- 				      THEN '八小时内'  -->
<!-- 				      WHEN w.time_confine = 1440  -->
<!-- 				      THEN '一天内'  -->
<!-- 				      WHEN w.time_confine = 4320  -->
<!-- 				      THEN '三天内'  -->
<!-- 				      WHEN w.time_confine = 7200  -->
<!-- 				      THEN '其他'  -->
<!-- 				    END timeConfine, -->
<!-- 				    CASE -->
<!-- 				      WHEN TIMESTAMPDIFF(MINUTE, w.create_time, NOW()) > w.time_confine  -->
<!-- 				      THEN '未超时'  -->
<!-- 				      ELSE '超时'  -->
<!-- 				    END checkTime, -->
<!-- 				    w.order_no AS orderNo, -->
<!-- 				    CASE -->
<!-- 				      WHEN w.module_id IS NOT NULL  -->
<!-- 				      THEN 1  -->
<!-- 				      WHEN w.module_id IS NULL  -->
<!-- 				      AND w.source_type = 1  -->
<!-- 				      THEN 2  -->
<!-- 				      WHEN w.source_type = 2  -->
<!-- 				      THEN 3  -->
<!-- 				      ELSE 4  -->
<!-- 				    END AS worderType , -->
<!-- 				    w.lng, -->
<!-- 				    w.lat, -->
<!-- 				    CASE WHEN w.module_id IS NOT NULL THEN FLOOR(100 + (RAND() * 400)) ELSE 0 END AS height, -->
<!-- 				    w.source_address AS address,w.create_time AS createTime -->
<!-- 				  FROM -->
<!-- 				    ${library.dynamic_dbname}.hk_worder w  -->
<!-- 				    LEFT JOIN hotcomm_community.`hk_sys_user` u  -->
<!-- 				      ON u.user_id = w.handle_user_id  -->
<!-- 				  WHERE w.`order_status` IN (1, 2, 3)  -->
<!-- 				    AND DATE_FORMAT(NOW(), '%m-%d-%Y') = DATE_FORMAT(w.`create_time`, '%m-%d-%Y')) t1  -->
<!-- 				WHERE FIND_IN_SET(t1.worderType, #{queryType}) -->
SELECT 
  * 
FROM
  (SELECT 
    w.`id` id,
    IFNULL(s.state_name, w.`order_title`) orderTitle,
    CASE
      WHEN w.order_status = 1 
      THEN '未处理' 
      WHEN w.order_status = 2 
      THEN '处理中' 
      WHEN w.order_status = 3 
      THEN '挂起' 
    END AS orderState,
    CONCAT(u.real_name, ' ', u.telephone) AS handlerInfo,
    CASE
      WHEN w.time_confine = 60 
      THEN '一小时' 
      WHEN w.time_confine = 480 
      THEN '八小时内' 
      WHEN w.time_confine = 1440 
      THEN '一天内' 
      WHEN w.time_confine = 4320 
      THEN '三天内' 
      WHEN w.time_confine = 7200 
      THEN '其他' 
    END timeConfine,
    CASE
      WHEN TIMESTAMPDIFF(MINUTE, w.create_time, NOW()) > w.time_confine 
      THEN '未超时' 
      ELSE '超时' 
    END checkTime,
    w.order_no AS orderNo,
    CASE
      WHEN w.module_id IS NOT NULL 
      THEN 1 
      WHEN w.module_id IS NULL 
      AND w.source_type = 1 
      THEN 2 
      WHEN w.source_type = 2 
      THEN 3 
      ELSE 4 
    END AS worderType,
    w.lng,
    w.lat,
    CASE
      WHEN w.module_id IS NOT NULL 
      THEN FLOOR(100 + (RAND() * 400)) 
      ELSE 0 
    END AS height,
    w.source_address AS address,
<!--     w.create_time AS createTime  -->
IFNULL(DATE_SUB(w.create_time,INTERVAL 0 HOUR),'') createTime
  FROM
    ${library.dynamic_dbname}.hk_worder w 
    LEFT JOIN hotcomm_community.`hk_sys_user` u 
      ON u.user_id = w.handle_user_id 
    LEFT JOIN ${library.dynamic_dbname}.hk_alarm a 
      ON a.id = w.source_id 
      AND w.module_id IS NOT NULL 
      AND w.source_type = 1 
    LEFT JOIN hotcomm_community.`hk_alarm_state` s 
      ON s.id = a.alarm_source_type 
  WHERE w.`order_status` IN (1, 2, 3) 
    AND DATE_FORMAT(NOW(), '%m-%d-%Y') = DATE_FORMAT(w.`create_time`, '%m-%d-%Y')) t1 
WHERE FIND_IN_SET(t1.worderType, #{queryType})
		</select>
		
		<select id="getAlarmWorkMainInfo" resultType="java.util.HashMap">
<!-- 		SELECT * FROM ( -->
<!-- 				SELECT  -->
<!-- 				  a.`id`, -->
<!-- 				  a.`alarm_message`, -->
<!-- 				  CASE -->
<!-- 				    WHEN a.handel_state = 0  -->
<!-- 				    THEN '未处理'  -->
<!-- 				    WHEN a.handel_state = 1  -->
<!-- 				    OR ( -->
<!-- 				      a.handel_state = 3  -->
<!-- 				      AND a.wor_id IS NOT NULL -->
<!-- 				    )  -->
<!-- 				    THEN '处理中'  -->
<!-- 				    WHEN a.handel_state = 3  -->
<!-- 				    AND a.wor_id IS NULL  -->
<!-- 				    THEN '需转工单'  -->
<!-- 				  END AS handleState, -->
<!-- 				  a.create_time AS alarmTime, -->
<!-- 				  a.alarm_address AS alarmAddress, -->
<!-- 				  CASE -->
<!-- 				    WHEN a.handle_user_id IS NOT NULL  -->
<!-- 				    THEN IFNULL( -->
<!-- 				      CONCAT(ua.real_name, ' ', ua.telephone), -->
<!-- 				      '未预设，待分配中' -->
<!-- 				    )  -->
<!-- 				    WHEN a.wor_id IS NOT NULL  -->
<!-- 				    THEN IFNULL( -->
<!-- 				      CONCAT(uw.real_name, ' ', uw.telephone), -->
<!-- 				      '未预设，待分配中' -->
<!-- 				    )  -->
<!-- 				    WHEN a.module_id IS NOT NULL  -->
<!-- 				    AND a.handel_state = 0  -->
<!-- 				    THEN IFNULL( -->
<!-- 				      CONCAT(u.real_name, ' ', u.telephone), -->
<!-- 				      '未预设，待分配中' -->
<!-- 				    )  -->
<!-- 				    ELSE '未预设，待分配中'  -->
<!-- 				  END AS handlerInfo, -->
<!-- 				  a.lng AS lng, -->
<!--    				  a.lat AS lat, -->
<!-- 				  IFNULL( -->
<!-- 				    CONCAT(a.alarm_level, '级'), -->
<!-- 				    '三级' -->
<!-- 				  ) AS alarmLevel, -->
<!-- 				  CASE -->
<!-- 				    WHEN a.alarm_type = 1  -->
<!-- 				    AND s.state_name = '烟雾报警'  -->
<!-- 				    THEN '火灾报警'  -->
<!-- 				    WHEN a.alarm_type = 1  -->
<!-- 				    AND s.state_name = '电流异常报警'  -->
<!-- 				    THEN '漏电报警'  -->
<!-- 				    WHEN a.alarm_type = 1  -->
<!-- 				    AND s.state_name = '气体泄漏'  -->
<!-- 				    THEN '漏气报警'  -->
<!-- 				    WHEN a.alarm_type = 3  -->
<!-- 				    AND pl.type_code = 'F01'  -->
<!-- 				    THEN '关爱人员未归报警'  -->
<!-- 				    WHEN a.alarm_type = 3  -->
<!-- 				    AND pl.type_code != 'F01'  -->
<!-- 				    THEN '异常通行报警'  -->
<!-- 				    WHEN a.alarm_type = 2  -->
<!-- 				    THEN '关注车辆报警'  -->
<!-- 				    ELSE '其他报警'  -->
<!-- 				  END AS alarmType, -->
<!-- 				  CASE -->
<!-- 				    WHEN a.alarm_type = 1  -->
<!-- 				    AND s.state_name = '烟雾报警'  -->
<!-- 				    THEN 1 -->
<!-- 				    WHEN a.alarm_type = 1  -->
<!-- 				    AND s.state_name = '电流异常报警'  -->
<!-- 				    THEN 2 -->
<!-- 				    WHEN a.alarm_type = 1  -->
<!-- 				    AND s.state_name = '气体泄漏'  -->
<!-- 				    THEN 3 -->
<!-- 				    WHEN a.alarm_type = 3  -->
<!-- 				    AND pl.type_code = 'F01'  -->
<!-- 				    THEN 4 -->
<!-- 				    WHEN a.alarm_type = 3  -->
<!-- 				    AND pl.type_code != 'F01'  -->
<!-- 				    THEN 5 -->
<!-- 				    WHEN a.alarm_type = 2  -->
<!-- 				    THEN 6  -->
<!-- 				    ELSE 7 -->
<!-- 				  END AS alarmFlag, -->
<!-- 				  CASE -->
<!-- 				    WHEN a.module_id IS NOT NULL  -->
<!-- 				    THEN FLOOR(100 + (RAND() * 400))  -->
<!-- 				    ELSE 0  -->
<!-- 				  END AS height  -->
<!-- 				FROM -->
<!-- 				  ${library.dynamic_dbname}.hk_alarm a  -->
<!-- 				  LEFT JOIN ${library.dynamic_dbname}.hk_device d  -->
<!-- 				    ON d.id = a.alarm_source_id  -->
<!-- 				  LEFT JOIN ${library.dynamic_dbname}.hk_device_alarm_gz g  -->
<!-- 				    ON g.alarm_mac = d.mac  -->
<!-- 				  LEFT JOIN hotcomm_community.`hk_sys_user` u  -->
<!-- 				    ON u.user_id IN ( -->
<!-- 				      JSON_EXTRACT (g.inform_userid, '$.user') -->
<!-- 				    )  -->
<!-- 				  LEFT JOIN hotcomm_community.`hk_sys_user` ua  -->
<!-- 				    ON ua.user_id = a.handle_user_id  -->
<!-- 				  LEFT JOIN ${library.dynamic_dbname}.hk_worder w  -->
<!-- 				    ON w.source_type = 1  -->
<!-- 				    AND w.source_id = a.id  -->
<!-- 				  LEFT JOIN hotcomm_community.`hk_sys_user` uw  -->
<!-- 				    ON uw.user_id = w.handle_user_id  -->
<!-- 				  LEFT JOIN hotcomm_community.`hk_alarm_state` s  -->
<!-- 				    ON a.alarm_source_type = s.id  -->
<!-- 				    AND a.alarm_type = 1  -->
<!-- 				  LEFT JOIN ${library.dynamic_dbname}.hk_person_lable pl  -->
<!-- 				    ON pl.id = a.alarm_source_type  -->
<!-- 				    AND a.alarm_type = 3  -->
<!-- 				WHERE DATE_FORMAT(NOW(), '%m-%d-%Y') = DATE_FORMAT(a.`create_time`, '%m-%d-%Y')  -->
<!-- 				  AND a.handel_state IN (0, 1, 3)  -->
<!-- 			      AND a.wor_id is null -->
<!-- 				GROUP BY a.id  -->
<!-- 				) t1 WHERE FIND_IN_SET(t1.alarmFlag,#{queryType}) -->
							SELECT *,
CONCAT(
    '报警',
    CASE
      WHEN `id` &lt; 10 
      THEN '0000000' 
      WHEN `id` >= 10 
      AND `id` &lt; 100 
      THEN '000000' 
      WHEN `id` >= 100 
      AND `id` &lt; 1000 
      THEN '00000' 
      WHEN `id` >= 1000 
      AND `id` &lt; 10000 
      THEN '0000' 
      WHEN `id` >= 10000 
      AND `id` &lt; 100000 
      THEN '000' 
      WHEN `id` >= 100000 
      AND `id` &lt; 1000000 
      THEN '00' 
      WHEN `id` >= 1000000 
      AND `id` &lt; 10000000 
      THEN '0' 
      ELSE `id` 
    END,
    CASE
      WHEN `id` >= 10000000 
      THEN '' 
      ELSE `id`
      END
    ) AS alarmNo
							 FROM (
							SELECT 
							  1 AS lableType,
							  a.`id`,
							  a.`alarm_message`,
							  CASE
							    WHEN a.handel_state = 0 
							    THEN '未处理' 
							    WHEN a.handel_state = 1 
							    OR (
							      a.handel_state = 3 
							      AND a.wor_id IS NOT NULL
							    ) 
							    THEN '处理中' 
							    WHEN a.handel_state = 3 
							    AND a.wor_id IS NULL 
							    THEN '需转工单' 
							  END AS handleState,
							  a.create_time AS alarmTime,
							  a.alarm_address AS alarmAddress,
							  CASE
							    WHEN a.handle_user_id IS NOT NULL 
							    THEN IFNULL(
							      CONCAT(ua.real_name, ' ', ua.telephone),
							      '未预设，待分配中'
							    ) 
							    WHEN a.wor_id IS NOT NULL 
							    THEN IFNULL(
							      CONCAT(uw.real_name, ' ', uw.telephone),
							      '未预设，待分配中'
							    ) 
							    WHEN a.module_id IS NOT NULL 
							    AND a.handel_state = 0 
							    THEN IFNULL(
							      CONCAT(u.real_name, ' ', u.telephone),
							      '未预设，待分配中'
							    ) 
							    ELSE '未预设，待分配中' 
							  END AS handlerInfo,
							  a.lng AS lng,
							  a.lat AS lat,
							  IFNULL(
							    CONCAT(a.alarm_level, '级'),
							    '三级'
							  ) AS alarmLevel,
							  CASE
							    WHEN a.alarm_type = 1 
							    AND s.state_name = '烟雾报警' 
							    THEN '火灾报警' 
							    WHEN a.alarm_type = 1 
							    AND s.state_name = '电流异常报警' 
							    THEN '漏电报警' 
							    WHEN a.alarm_type = 1 
							    AND s.state_name = '气体泄漏' 
							    THEN '漏气报警' 
							    WHEN a.alarm_type = 3 
							    AND pl.type_code = 'F01' 
							    THEN '关爱人员未归报警' 
							    WHEN a.alarm_type = 3 
							    AND pl.type_code != 'F01' 
							    THEN '异常通行报警' 
							    WHEN a.alarm_type = 2 
							    THEN '关注车辆报警' 
							    ELSE '其他报警' 
							  END AS alarmType,
							  CASE
							    WHEN a.alarm_type = 1 
							    AND s.state_name = '烟雾报警' 
							    THEN 1 
							    WHEN a.alarm_type = 1 
							    AND s.state_name = '电流异常报警' 
							    THEN 2 
							    WHEN a.alarm_type = 1 
							    AND s.state_name = '气体泄漏' 
							    THEN 3 
							    WHEN a.alarm_type = 3 
							    AND pl.type_code = 'F01' 
							    THEN 4 
							    WHEN a.alarm_type = 3 
							    AND pl.type_code != 'F01' 
							    THEN 5 
							    WHEN a.alarm_type = 2 
							    THEN 6 
							    ELSE 7 
							  END AS alarmFlag,
							  CASE
							    WHEN a.module_id IS NOT NULL 
							    THEN FLOOR(100 + (RAND() * 400)) 
							    ELSE 0 
							  END AS height 
							FROM
							  ${library.dynamic_dbname}.hk_alarm a 
							  LEFT JOIN ${library.dynamic_dbname}.hk_device d 
							    ON d.id = a.alarm_source_id 
							  LEFT JOIN ${library.dynamic_dbname}.hk_device_alarm_gz g 
							    ON g.alarm_mac = d.mac 
							  LEFT JOIN hotcomm_community.`hk_sys_user` u 
							    ON u.user_id IN (
							      JSON_EXTRACT (g.inform_userid, '$.user')
							    ) 
							  LEFT JOIN hotcomm_community.`hk_sys_user` ua 
							    ON ua.user_id = a.handle_user_id 
							  LEFT JOIN ${library.dynamic_dbname}.hk_worder w 
							    ON w.source_type = 1 
							    AND w.source_id = a.id 
							  LEFT JOIN hotcomm_community.`hk_sys_user` uw 
							    ON uw.user_id = w.handle_user_id 
							  LEFT JOIN hotcomm_community.`hk_alarm_state` s 
							    ON a.alarm_source_type = s.id 
							    AND a.alarm_type = 1 
							  LEFT JOIN ${library.dynamic_dbname}.hk_person_lable pl 
							    ON pl.id = a.alarm_source_type 
							    AND a.alarm_type = 3 
							WHERE DATE_FORMAT(NOW(), '%m-%d-%Y') = DATE_FORMAT(a.`create_time`, '%m-%d-%Y') 
							  AND a.handel_state IN (0, 1, 3) 
							GROUP BY a.id 
							UNION
							SELECT 
							  2 AS lableType,
							  e.id AS id,
							  e.event_title AS alarm_message,
							  '未处理' AS handleState,
							  e.create_time AS alarmTime,
							  e.event_address AS alarmAddress,
							  CONCAT(u.real_name, ' ', u.telephone) AS handlerInfo,
							  e.lng,
							  e.lat,
							  CASE
							    WHEN e.time_confine = 60 
							    OR e.time_confine = 480 
							    OR e.time_confine = 1440 
							    THEN '1级' 
							    WHEN e.time_confine = 4320 
							    THEN '2级' 
							    ELSE '3级' 
							  END AS alarmLevel,
							  '其他报警' AS alarmType,
							  7 AS alarmFlag,
							  0 AS height 
							FROM
							  ${library.dynamic_dbname}.hk_event e 
							  LEFT JOIN hotcomm_community.`hk_sys_user` u 
							    ON u.user_id = e.handle_user_id 
							WHERE DATE_FORMAT(NOW(), '%m-%d-%Y') = DATE_FORMAT(e.`create_time`, '%m-%d-%Y') 
							  AND e.event_status = 0 
							GROUP BY e.id 
							) t1 WHERE FIND_IN_SET(t1.alarmFlag,#{queryType})
		</select>
		
		<select id="UserLngLat" resultType="com.hotcomm.community.common.bean.ui.process.alarm.AlarmUserLngLatUM">
			SELECT 
			  sr.`role_name` AS roleName,
			  u.`user_name` AS userName,
			  u.`telephone`,
			  CONCAT(113.7500, FLOOR(1 + (RAND() * 101))) AS lng ,
			  CONCAT(22.9946, FLOOR(1 + (RAND() * 101))) AS lat 
			FROM
			  hotcomm_community.`hk_sys_user` u 
			  INNER JOIN hotcomm_community.`hk_sys_user_role` r 
			    ON u.`user_id` = r.`user_id` 
			  INNER JOIN hotcomm_community.`hk_sys_role` sr 
			    ON sr.`id` = r.`role_id` 
			    AND u.`is_delete` = 1 
			    AND FIND_IN_SET(sr.`role_code`,'F05,F07,F08')
		</select>

		<select id="getAlarmMainWork" resultType="Integer">
<!-- 			SELECT  -->
<!-- 			  CASE -->
<!-- 			    WHEN s.state_name = '烟雾报警'  -->
<!-- 			    THEN 1  -->
<!-- 			    WHEN s.state_name = '电流异常报警'  -->
<!-- 			    THEN 2  -->
<!-- 			    WHEN s.state_name = '气体泄漏' OR s.state_name = '气体泄漏和防拆同时报警' -->
<!-- 			    THEN 3 -->
<!-- 			    WHEN pl.type_code='F01' -->
<!-- 			    THEN 4 -->
<!-- 			    WHEN pl.type_code='F04' -->
<!-- 			    THEN 5 -->
<!-- 			    WHEN a.alarm_type=2 -->
<!-- 			    THEN 6 -->
<!-- 			    ELSE 7 -->
<!-- 			    END AS alarmMainWorkType -->
<!-- 			FROM -->
<!-- 			  ${library.dynamic_dbname}.hk_alarm a  -->
<!-- 			  LEFT JOIN hotcomm_community.`hk_alarm_state` s  -->
<!-- 			    ON a.`alarm_source_type` = s.`id`  -->
<!-- 			    AND a.`alarm_type` = 1  -->
<!-- 			  LEFT JOIN ${library.dynamic_dbname}.hk_person_lable pl  -->
<!-- 			    ON a.`alarm_type` = 2  -->
<!-- 			    AND a.`alarm_source_type` = pl.`id`  -->
<!-- 			  LEFT JOIN ${library.dynamic_dbname}.hk_car_label cl  -->
<!-- 			    ON a.`alarm_source_type` = cl.`id`  -->
<!-- 			    AND a.`alarm_type` = 2  -->
<!-- 			WHERE a.`id` = #{aid} -->
<!-- 			GROUP BY a.`id`  -->
				SELECT 
				  t1.alarmMainWorkType 
				FROM
				  (SELECT 
				    CASE
				      WHEN s.state_name = '烟雾报警' 
				      THEN 1 
				      WHEN s.state_name = '电流异常报警' 
				      THEN 2 
				      WHEN s.state_name = '气体泄漏' 
				      OR s.state_name = '气体泄漏和防拆同时报警' 
				      THEN 3 
				      WHEN pl.type_code = 'F01' 
				      THEN 4 
				      WHEN pl.type_code = 'F04' 
				      THEN 5 
				      WHEN a.alarm_type = 2 
				      THEN 6 
				      ELSE 7 
				    END AS alarmMainWorkType,
				    1 AS lableType 
				  FROM
				    ${library.dynamic_dbname}.hk_alarm a 
				    LEFT JOIN hotcomm_community.`hk_alarm_state` s 
				      ON a.`alarm_source_type` = s.`id` 
				      AND a.`alarm_type` = 1 
				    LEFT JOIN ${library.dynamic_dbname}.hk_person_lable pl 
				      ON a.`alarm_type` = 3 
				      AND a.`alarm_source_type` = pl.`id` 
				    LEFT JOIN ${library.dynamic_dbname}.hk_car_label cl 
				      ON a.`alarm_source_type` = cl.`id` 
				      AND a.`alarm_type` = 2 
				  WHERE a.`id` = #{aid} 
				  GROUP BY a.`id` 
				  UNION
				  SELECT 
				    7 AS alarmMainWorkType,
				    2 AS lableType 
				  FROM
				    ${library.dynamic_dbname}.hk_event e 
				  WHERE e.event_status = 0 
				    AND e.id = #{aid}) t1 
				WHERE t1.lableType = #{lid} 
		</select>
		
<!-- 		<select id="getAlarmHandlerAndStateAndNo" resultType="java.util.HashMap"> -->
			
<!-- 		</select> -->
		
		<select id="getMainWorkAlarmDevDetail" resultType="java.util.HashMap">
				SELECT 
				  CONCAT(
				    b.building_name,
				    unit.unit_name,
				    f.floor_name
				  ) AS '楼栋信息',
				  a.`id`,
 CONCAT(
    '报警',
    CASE
      WHEN a.`id` &lt; 10 
      THEN '0000000' 
      WHEN a.`id` >= 10 
      AND a.`id` &lt; 100 
      THEN '000000' 
      WHEN a.`id` >= 100 
      AND a.`id` &lt; 1000 
      THEN '00000' 
      WHEN a.`id` >= 1000 
      AND a.`id` &lt; 10000 
      THEN '0000' 
      WHEN a.`id` >= 10000 
      AND a.`id` &lt; 100000 
      THEN '000' 
      WHEN a.`id` >= 100000 
      AND a.`id` &lt; 1000000 
      THEN '00' 
      WHEN a.`id` >= 1000000 
      AND a.`id` &lt; 10000000 
      THEN '0' 
      ELSE a.`id` 
    END,
    CASE
      WHEN a.`id` >= 10000000 
      THEN '' 
      ELSE a.`id`
      END
    ) AS '报警编号',
				  a.`alarm_message` as '报警内容',
				  CASE
				    WHEN a.handel_state = 0 
				    THEN '未处理' 
				    WHEN a.handel_state = 1 
				    OR (
				      a.handel_state = 3 
				      AND a.wor_id IS NULL
				    ) 
				    THEN '处理中' 
				    WHEN a.handel_state = 3 
				    AND a.wor_id IS NOT NULL 
				    THEN '需转工单' 
				  END AS '报警状态',
				  a.create_time AS '报警时间',
				  a.alarm_address AS '报警地址',
				  CASE
				    WHEN a.handle_user_id IS NOT NULL 
				    THEN IFNULL(
				      CONCAT(ua.real_name, ' ', ua.telephone),
				      '未预设，待分配中'
				    ) 
				    WHEN a.wor_id IS NOT NULL 
				    THEN IFNULL(
				      CONCAT(uw.real_name, ' ', uw.telephone),
				      '未预设，待分配中'
				    ) 
				    WHEN a.module_id IS NOT NULL 
				    AND a.handel_state = 0 
				    THEN IFNULL(
				      CONCAT(u.real_name, ' ', u.telephone),
				      '未预设，待分配中'
				    ) 
				    ELSE '未预设，待分配中' 
				  END AS '处理人',
				  REPLACE(
				    REPLACE(
				      REPLACE(
				        REPLACE(
				          JSON_EXTRACT (d.video_list, '$.video'),
				          '"',
				          ''
				        ),
				        '[',
				        ''
				      ),
				      ']',
				      ''
				    ),
				    ' ',
				    ''
				  ) AS '报警视频',
				  d.lon AS lng,
				  d.lat AS lat 
				FROM
				  ${library.dynamic_dbname}.hk_alarm a 
				  LEFT JOIN ${library.dynamic_dbname}.hk_device d 
				    ON d.id = a.alarm_source_id 
				  LEFT JOIN ${library.dynamic_dbname}.hk_device_alarm_gz g 
				    ON g.alarm_mac = d.mac 
				  LEFT JOIN hotcomm_community.`hk_sys_user` u 
				    ON u.user_id IN (
				      JSON_EXTRACT (g.inform_userid, '$.user')
				    ) 
				  LEFT JOIN ${library.dynamic_dbname}.hk_building b 
				    ON b.building_name 
				    AND d.building_num 
				  LEFT JOIN ${library.dynamic_dbname}.hk_unit unit 
				    ON unit.id = d.unit_num 
				  LEFT JOIN ${library.dynamic_dbname}.hk_floors f 
				    ON f.id = d.floor_num 
				  LEFT JOIN hotcomm_community.`hk_sys_user` ua 
				    ON ua.user_id = a.handle_user_id 
				  LEFT JOIN ${library.dynamic_dbname}.hk_worder w 
				    ON w.source_type = 1 
				    AND w.source_id = a.id 
				  LEFT JOIN hotcomm_community.`hk_sys_user` uw 
				    ON uw.user_id = w.handle_user_id 
				WHERE a.handel_state IN (0, 1, 3) 
				  AND a.alarm_type = 1 
				  AND a.id = #{aid}
				GROUP BY a.id 
		</select>

		<select id="getMainWorkAlarmPersonDetail" resultType="java.util.HashMap">
					SELECT 
					  a.`id`,
CONCAT(
    '报警',
    CASE
      WHEN a.`id` &lt; 10 
      THEN '0000000' 
      WHEN a.`id` >= 10 
      AND a.`id` &lt; 100 
      THEN '000000' 
      WHEN a.`id` >= 100 
      AND a.`id` &lt; 1000 
      THEN '00000' 
      WHEN a.`id` >= 1000 
      AND a.`id` &lt; 10000 
      THEN '0000' 
      WHEN a.`id` >= 10000 
      AND a.`id` &lt; 100000 
      THEN '000' 
      WHEN a.`id` >= 100000 
      AND a.`id` &lt; 1000000 
      THEN '00' 
      WHEN a.`id` >= 1000000 
      AND a.`id` &lt; 10000000 
      THEN '0' 
      ELSE a.`id` 
    END,
    CASE
      WHEN a.`id` >= 10000000 
      THEN '' 
      ELSE a.`id`
      END
    ) AS '报警编号',
					  a.`alarm_message` as '报警内容',
					  CASE
					    WHEN a.handel_state = 0 
					    THEN '未处理' 
					    WHEN a.handel_state = 1 
					    OR (
					      a.handel_state = 3 
					      AND a.wor_id IS NULL
					    ) 
					    THEN '处理中' 
					    WHEN a.handel_state = 3 
					    AND a.wor_id IS NOT NULL 
					    THEN '需转工单' 
					  END AS '报警状态',
					  a.create_time AS '报警时间',
					  a.alarm_address AS '报警地址',
					  IFNULL(
					    CONCAT(u.real_name, ' ', u.telephone),
					    '未预设，待分配中'
					  ) AS '处理人',
					  a.lng AS lng,
					  a.lat AS lat,
					  a.alarm_source AS '报警人员',
					  REPLACE(
					    REPLACE(
					      REPLACE(
					        REPLACE(
					          JSON_EXTRACT (
					            a.alarm_view,
					            '$.pendingView.img[*].url'
					          ),
					          '[',
					          ''
					        ),
					        ']',
					        ''
					      ),
					      '"',
					      ''
					    ),
					    ' ',
					    ''
					  ) AS '报警图片',
					  REPLACE(
					    REPLACE(
					      REPLACE(
					        REPLACE(
					          JSON_EXTRACT (
					            a.alarm_view,
					            '$.pendingView.video[*].url'
					          ),
					          '[',
					          ''
					        ),
					        ']',
					        ''
					      ),
					      '"',
					      ''
					    ),
					    ' ',
					    ''
					  ) AS '报警视频' 
					FROM
					  ${library.dynamic_dbname}.hk_alarm a 
					  LEFT JOIN hotcomm_community.`hk_sys_user` u 
					    ON u.user_id IN (
					      REPLACE(
					        REPLACE(
					          REPLACE(
					            REPLACE(
					              REPLACE(
					                REPLACE(
					                  REPLACE(
					                    REPLACE(
					                      JSON_EXTRACT (a.handel_user, '$.user'),
					                      'id',
					                      ''
					                    ),
					                    '"',
					                    ''
					                  ),
					                  ': ',
					                  ''
					                ),
					                '{',
					                ''
					              ),
					              '}',
					              ''
					            ),
					            ' ',
					            ''
					          ),
					          '[',
					          ''
					        ),
					        ']',
					        ''
					      )
					    ) 
					  LEFT JOIN ${library.dynamic_dbname}.hk_person_lable l 
					    ON l.id = a.alarm_source_type 
					WHERE a.handel_state IN (0, 1, 3) 
					  AND a.alarm_type = 3 
					  AND a.id = #{aid} 
					GROUP BY a.id 
		</select>
		
		<select id="getMainWorkAlarmCarDetail" resultType="java.util.HashMap">
				SELECT 
				  a.`id`,
CONCAT(
    '报警',
    CASE
      WHEN a.`id` &lt; 10 
      THEN '0000000' 
      WHEN a.`id` >= 10 
      AND a.`id` &lt; 100 
      THEN '000000' 
      WHEN a.`id` >= 100 
      AND a.`id` &lt; 1000 
      THEN '00000' 
      WHEN a.`id` >= 1000 
      AND a.`id` &lt; 10000 
      THEN '0000' 
      WHEN a.`id` >= 10000 
      AND a.`id` &lt; 100000 
      THEN '000' 
      WHEN a.`id` >= 100000 
      AND a.`id` &lt; 1000000 
      THEN '00' 
      WHEN a.`id` >= 1000000 
      AND a.`id` &lt; 10000000 
      THEN '0' 
      ELSE a.`id` 
    END,
    CASE
      WHEN a.`id` >= 10000000 
      THEN '' 
      ELSE a.`id`
      END
    ) AS '报警编号',
				  a.`alarm_message` as '报警内容',
				  CASE
				    WHEN a.handel_state = 0 
				    THEN '未处理' 
				    WHEN a.handel_state = 1 
				    OR (
				      a.handel_state = 3 
				      AND a.wor_id IS NULL
				    ) 
				    THEN '处理中' 
				    WHEN a.handel_state = 3 
				    AND a.wor_id IS NOT NULL 
				    THEN '需转工单' 
				    when a.handel_state = 4
				    then '已完成'
				    when a.handel_state = 5
				    then '已关闭'
				  END AS '报警状态',
				  a.create_time AS '报警时间',
				  a.alarm_address AS '报警地址',
				  IFNULL(CONCAT(u.real_name), '') AS '处理人',
				  IFNULL(CONCAT(u.telephone), '') AS '处理人电话',
				  a.lng AS lng,
				  a.lat AS lat,
				  a.alarm_source AS '报警车辆',
				  IFNULL(
				    REPLACE(
				      REPLACE(
				        REPLACE(
				          REPLACE(
				            JSON_EXTRACT (
				              a.alarm_view,
				              '$.pendingView.img[*].url'
				            ),
				            '[',
				            ''
				          ),
				          ']',
				          ''
				        ),
				        '"',
				        ''
				      ),
				      ' ',
				      ''
				    ),
				    ''
				  ) AS '报警图片',
				  IFNULL(
				    REPLACE(
				      REPLACE(
				        REPLACE(
				          REPLACE(
				            JSON_EXTRACT (
				              a.alarm_view,
				              '$.pendingView.video[*].url'
				            ),
				            '[',
				            ''
				          ),
				          ']',
				          ''
				        ),
				        '"',
				        ''
				      ),
				      ' ',
				      ''
				    ),
				    ''
				  ) AS '报警视频' 
				FROM
				  ${library.dynamic_dbname}.hk_alarm a 
				  LEFT JOIN hotcomm_community.`hk_sys_user` u 
				    ON u.user_id IN (
				      REPLACE(
				        REPLACE(
				          REPLACE(
				            REPLACE(
				              REPLACE(
				                REPLACE(
				                  REPLACE(
				                    REPLACE(
				                      JSON_EXTRACT (a.handel_user, '$.user'),
				                      'id',
				                      ''
				                    ),
				                    '"',
				                    ''
				                  ),
				                  ': ',
				                  ''
				                ),
				                '{',
				                ''
				              ),
				              '}',
				              ''
				            ),
				            ' ',
				            ''
				          ),
				          '[',
				          ''
				        ),
				        ']',
				        ''
				      )
				    ) 
				WHERE 
<!-- 				a.handel_state IN (0, 1, 3) AND -->
				  a.alarm_type = 2 
				  AND a.id = #{aid} 
				GROUP BY a.id 
		</select>
		
		<select id="getMainWorkAlarmOtherDetail" resultType="java.util.HashMap">
				SELECT 
				  * 
				FROM
				  (SELECT 
				    2 AS lableType,
CONCAT(
    '报警',
    CASE
      WHEN e.`id` &lt; 10 
      THEN '0000000' 
      WHEN e.`id` >= 10 
      AND e.`id` &lt; 100 
      THEN '000000' 
      WHEN e.`id` >= 100 
      AND e.`id` &lt; 1000 
      THEN '00000' 
      WHEN e.`id` >= 1000 
      AND e.`id` &lt; 10000 
      THEN '0000' 
      WHEN e.`id` >= 10000 
      AND e.`id` &lt; 100000 
      THEN '000' 
      WHEN e.`id` >= 100000 
      AND e.`id` &lt; 1000000 
      THEN '00' 
      WHEN e.`id` >= 1000000 
      AND e.`id` &lt; 10000000 
      THEN '0' 
      ELSE e.`id` 
    END,
    CASE
      WHEN e.`id` >= 10000000 
      THEN '' 
      ELSE e.`id`
      END
    ) AS '报警编号',
    				e.`id`,
				    CASE
				      WHEN e.time_confine = 60 
				      OR e.time_confine = 480 
				      OR e.time_confine = 1440 
				      THEN '1级' 
				      WHEN e.time_confine = 4320 
				      THEN '2级' 
				      ELSE '3级' 
				    END AS '报警等级',
				    CASE
				      WHEN e.event_status = 0 
				      THEN '未处理' 
				      WHEN e.event_status = 1 
				      THEN '已转工单' 
				      WHEN e.event_status = 2 
				      THEN '处理中' 
				    END AS '报警状态',
				    CASE
				      WHEN e.event_type = 1 
				      THEN '设备' 
				      WHEN e.event_type = 2 
				      THEN '户政' 
				      WHEN e.event_type = 3 
				      THEN '消防' 
				      WHEN e.event_type = 4 
				      THEN '治安' 
				      WHEN e.event_type = 5 
				      THEN '刑事' 
				      WHEN e.event_type = 6 
				      THEN '交通' 
				      WHEN e.event_type = 7 
				      THEN '生产安全' 
				      WHEN e.event_type = 8 
				      THEN '其他' 
				    END AS '报警类型',
				    e.event_title AS '报警内容',
				    e.event_address AS '报警地址',
				    e.lng AS lng,
				    e.lat AS lat,
				    u.real_name AS '处理人',
				    e.create_time AS '报警时间',
				    0 AS height 
				  FROM
				    ${library.dynamic_dbname}.hk_event e 
				    LEFT JOIN hotcomm_community.`hk_sys_user` u 
				      ON e.handle_user_id = u.user_id 
				  WHERE e.event_status = 0 
				    AND e.id = #{aid} 
				  UNION
				  SELECT 
				    1 AS lableType,
CONCAT(
    '报警',
    CASE
      WHEN a.`id` &lt; 10 
      THEN '0000000' 
      WHEN a.`id` >= 10 
      AND a.`id` &lt; 100 
      THEN '000000' 
      WHEN a.`id` >= 100 
      AND a.`id` &lt; 1000 
      THEN '00000' 
      WHEN a.`id` >= 1000 
      AND a.`id` &lt; 10000 
      THEN '0000' 
      WHEN a.`id` >= 10000 
      AND a.`id` &lt; 100000 
      THEN '000' 
      WHEN a.`id` >= 100000 
      AND a.`id` &lt; 1000000 
      THEN '00' 
      WHEN a.`id` >= 1000000 
      AND a.`id` &lt; 10000000 
      THEN '0' 
      ELSE a.`id` 
    END,
    CASE
      WHEN a.`id` >= 10000000 
      THEN '' 
      ELSE a.`id`
      END
    ) AS '报警编号',
				    a.`id`,
				    IFNULL(
				      CONCAT(a.alarm_level, '级'),
				      '三级'
				    ) AS '报警等级',
				    CASE
				      WHEN a.handel_state = 0 
				      THEN '未处理' 
				      WHEN a.handel_state = 1 
				      OR (
				        a.handel_state = 3 
				        AND a.wor_id IS NOT NULL
				      ) 
				      THEN '处理中' 
				      WHEN a.handel_state = 3 
				      AND a.wor_id IS NULL 
				      THEN '需转工单' 
				    END AS '报警状态',
				    IFNULL(s.state_name, '通行报警') AS '报警类型',
				    a.`alarm_message` AS '报警内容',
				    a.alarm_address AS '报警地址',
				    a.lng AS lng,
				    a.lat AS lat,
				    CASE
				      WHEN a.handle_user_id IS NOT NULL 
				      THEN IFNULL(
				        CONCAT(ua.real_name, ' ', ua.telephone),
				        '未预设，待分配中'
				      ) 
				      WHEN a.wor_id IS NOT NULL 
				      THEN IFNULL(
				        CONCAT(uw.real_name, ' ', uw.telephone),
				        '未预设，待分配中'
				      ) 
				      WHEN a.module_id IS NOT NULL 
				      AND a.handel_state = 0 
				      THEN IFNULL(
				        CONCAT(u.real_name, ' ', u.telephone),
				        '未预设，待分配中'
				      ) 
				      ELSE '未预设，待分配中' 
				    END AS '处理人',
				    a.create_time AS '报警时间',
				    CASE
				      WHEN a.module_id IS NOT NULL 
				      THEN FLOOR(100 + (RAND() * 400)) 
				      ELSE 0 
				    END AS height 
				  FROM
				    ${library.dynamic_dbname}.hk_alarm a 
				    LEFT JOIN ${library.dynamic_dbname}.hk_device d 
				      ON d.id = a.alarm_source_id 
				    LEFT JOIN ${library.dynamic_dbname}.hk_device_alarm_gz g 
				      ON g.alarm_mac = d.mac 
				    LEFT JOIN hotcomm_community.`hk_sys_user` u 
				      ON u.user_id IN (
				        JSON_EXTRACT (g.inform_userid, '$.user')
				      ) 
				    LEFT JOIN hotcomm_community.`hk_sys_user` ua 
				      ON ua.user_id = a.handle_user_id 
				    LEFT JOIN ${library.dynamic_dbname}.hk_worder w 
				      ON w.source_type = 1 
				      AND w.source_id = a.id 
				    LEFT JOIN hotcomm_community.`hk_sys_user` uw 
				      ON uw.user_id = w.handle_user_id 
				    LEFT JOIN hotcomm_community.`hk_alarm_state` s 
				      ON a.alarm_source_type = s.id 
				      AND a.alarm_type = 1 
				    LEFT JOIN ${library.dynamic_dbname}.hk_person_lable pl 
				      ON pl.id = a.alarm_source_type 
				      AND a.alarm_type = 3 
				  WHERE a.handel_state IN (0, 1, 3) 
				    AND a.id = #{aid} 
				  GROUP BY a.id) t1 
				WHERE t1.lableType = #{lid} 
				  AND t1.id = #{aid} 
		</select>
		
		<select id="getAlarmWorkMainWorkDetail" resultType="java.util.HashMap">
			SELECT 
			  w.`order_title` '工单标题',
			  w.order_desc AS '详细说明',
			  w.source_address '报警地点',
			  w.lng '经度',
			  w.lat '纬度',
			  '治安管理部' AS '责任部门',
			  CASE
			    WHEN w.order_status = 1 
			    THEN '未处理' 
			    WHEN w.order_status = 2 
			    THEN '处理中' 
			    WHEN w.order_status = 3 
			    THEN '挂起' 
			    WHEN w.order_status = 4 
			    THEN '已处理' 
			  END AS '工单状态',
			  CONCAT(u.real_name, ' ', u.telephone) AS '处理人',
			  CASE
			    WHEN w.time_confine = 60 
			    THEN '一小时' 
			    WHEN w.time_confine = 480 
			    THEN '八小时内' 
			    WHEN w.time_confine = 1440 
			    THEN '一天内' 
			    WHEN w.time_confine = 4320 
			    THEN '三天内' 
			    WHEN w.time_confine = 7200 
			    THEN '其他' 
			  END '要求处理时间',
			  CASE
			    WHEN w.time_confine = 60 
			    THEN '非常紧急' 
			    WHEN w.time_confine = 480 
			    THEN '非常紧急' 
			    WHEN w.time_confine = 1440 
			    THEN '紧急' 
			    WHEN w.time_confine = 4320 
			    THEN '紧急' 
			    WHEN w.time_confine = 7200 
			    THEN '一般' 
			  END '紧急程度',
			  w.order_no AS '工单编号',
<!-- 			  w.create_time AS '创建时间', -->
IFNULL(DATE_SUB(w.create_time,INTERVAL 0 HOUR),'')  '创建时间',
  REPLACE(
  REPLACE(
  REPLACE(
  REPLACE(
			  CASE
			    WHEN w.module_id IS NOT NULL 
			    THEN d.video_list -> '$.video' 
			    WHEN w.source_type = 2 
			    THEN e.event_view -> '$.pendingView.video[*].url' 
			    WHEN w.source_type = 1 
			    THEN a.alarm_view -> '$.pendingView.video[*].url' 
			  END 
  ,'"','')
  ,'[','')
  ,']','')
  ,' ','')  
			  AS '相关摄像头',
  REPLACE(
  REPLACE(
  REPLACE(
  REPLACE(
			  CASE
			    WHEN w.source_type = 2 
			    THEN e.event_view -> '$.pendingView.img[*].url' 
			    WHEN w.source_type = 1 
			    THEN a.alarm_view -> '$.pendingView.img[*].url' 
			  END 
  ,'"','')
  ,'[','')
  ,']','')
  ,' ','')
			  AS '相关图片' 
			FROM
			  ${library.dynamic_dbname}.hk_worder w 
			  LEFT JOIN hotcomm_community.`hk_sys_user` u 
			    ON u.user_id = w.handle_user_id 
			  LEFT JOIN ${library.dynamic_dbname}.hk_device d 
			    ON w.module_id IS NOT NULL 
			    AND w.source_id = d.id 
			  LEFT JOIN ${library.dynamic_dbname}.hk_alarm a 
			    ON w.source_type = 1 
			    AND w.source_id = a.id 
			  LEFT JOIN ${library.dynamic_dbname}.hk_event e 
			    ON w.source_type = 2 
			    AND w.source_id = e.id 
			WHERE w.id = #{wid} 
		</select>
		
		<select id="fixDevAlarmMessage" resultType="String">
  SELECT 
    IFNULL(CONCAT(s.state_name,''),CONCAT(a.alarm_message,'')) AS alarm_message
  FROM
    ${library.dynamic_dbname}.hk_alarm a 
    LEFT JOIN ${library.dynamic_dbname}.hk_device d 
      ON d.id = a.alarm_source_id 
    LEFT JOIN ${library.dynamic_dbname}.hk_device_alarm_gz g 
      ON g.alarm_mac = d.mac 
    LEFT JOIN hotcomm_community.`hk_sys_user` u 
      ON u.user_id IN (
        JSON_EXTRACT (g.inform_userid, '$.user')
      ) 
    LEFT JOIN hotcomm_community.`hk_sys_user` ua 
      ON ua.user_id = a.handle_user_id 
    LEFT JOIN ${library.dynamic_dbname}.hk_worder w 
      ON w.source_type = 1 
      AND w.source_id = a.id 
    LEFT JOIN hotcomm_community.`hk_sys_user` uw 
      ON uw.user_id = w.handle_user_id 
    LEFT JOIN hotcomm_community.`hk_alarm_state` s 
      ON a.alarm_source_type = s.id 
      AND a.alarm_type = 1 
    LEFT JOIN ${library.dynamic_dbname}.hk_person_lable pl 
      ON pl.id = a.alarm_source_type 
      AND a.alarm_type = 3 
  WHERE DATE_FORMAT(NOW(), '%m-%d-%Y') = DATE_FORMAT(a.`create_time`, '%m-%d-%Y') 
    AND a.handel_state IN (0, 1, 3) 
    AND a.`id`=#{aid}
  GROUP BY a.id 
		</select>

</mapper>